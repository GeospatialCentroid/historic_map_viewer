var _____WB$wombat$assign$function_____ = function(name) {return (self._wb_wombat && self._wb_wombat.local_init && self._wb_wombat.local_init(name)) || self[name]; };
if (!self.__WB_pmw) { self.__WB_pmw = function(obj) { this.__WB_source = obj; return this; } }
{
  let window = _____WB$wombat$assign$function_____("window");
  let self = _____WB$wombat$assign$function_____("self");
  let document = _____WB$wombat$assign$function_____("document");
  let location = _____WB$wombat$assign$function_____("location");
  let top = _____WB$wombat$assign$function_____("top");
  let parent = _____WB$wombat$assign$function_____("parent");
  let frames = _____WB$wombat$assign$function_____("frames");
  let opener = _____WB$wombat$assign$function_____("opener");

(function(De,It){typeof exports=="object"&&typeof module<"u"?It(exports,require("leaflet")):typeof define=="function"&&define.amd?define(["exports","leaflet"],It):(De=typeof globalThis<"u"?globalThis:De||self,It(De.Allmaps={},De.L))})(this,function(De,It){"use strict";function Uo(r){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(r){for(const t in r)if(t!=="default"){const i=Object.getOwnPropertyDescriptor(r,t);Object.defineProperty(e,t,i.get?i:{enumerable:!0,get:()=>r[t]})}}return e.default=r,Object.freeze(e)}const Je=Uo(It);function ut(r,e){const t=e[0],i=e[1];return[r[0]*t+r[2]*i+r[4],r[1]*t+r[3]*i+r[5]]}function Wo(){return[1,0,0,1,0,0]}function zo(r,e){const t=r[0],i=r[1],n=r[2],s=r[3],o=r[4],a=r[5],l=e[0],c=e[1],h=e[2],u=e[3],g=e[4],y=e[5];return[t*l+n*c,i*l+s*c,t*h+n*u,i*h+s*u,t*g+n*y+o,i*g+s*y+a]}function yn(r,e,t,i,n,s,o){const a=Math.sin(n),l=Math.cos(n);return[t*l,i*a,-t*a,i*l,s*t*l-o*t*a+r,s*i*a+o*i*l+e]}function Vo(r){const e=$o(r),t=r[0],i=r[1],n=r[2],s=r[3],o=r[4],a=r[5];return[s/e,-i/e,-n/e,t/e,(n*a-s*o)/e,-(t*a-i*o)/e]}function $o(r){return r[0]*r[3]-r[1]*r[2]}function qo(r){const e=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];return e[0]=r[0],e[1]=r[1],e[4]=r[2],e[5]=r[3],e[12]=r[4],e[13]=r[5],e}async function wn(r,e,t){let i;if(typeof t=="function"?i=await t(r,e):i=await fetch(r,e),!i.ok)throw new Error(i.statusText);return i}async function Zo(r,e,t){return await(await wn(r,e,t)).json()}async function Xo(r,e,t){return await Zo(`${r}/info.json`,e,t)}function xn(r,e=!1){switch(r.type){case"Polygon":return r.coordinates?{...r,coordinates:_n(r.coordinates,e)}:r;case"MultiPolygon":return r.coordinates?{...r,coordinates:r.coordinates.map(t=>_n(t,e))}:r;case"GeometryCollection":return{...r,geometries:r.geometries.map(t=>xn(t,e))};default:return r}}function _n(r,e){if(r.length===0)return r;const t=[];for(let i=0;i<r.length;i++)t.push(Ho(r[i],i===0?e:!e));return t}function Ho(r,e){let t=0,i=0;for(let n=0,s=r.length,o=s-1;n<s;o=n++){const a=(r[n][0]-r[o][0])*(r[o][1]+r[n][1]),l=t+a;i+=Math.abs(t)>=Math.abs(a)?t-l+a:a-l+t,t=l}return t+i>=0!=!!e?r.slice().reverse():r}function pe(r){return Array.isArray(r)&&r.length===2&&typeof r[0]=="number"&&typeof r[1]=="number"}function Se(r){return Array.isArray(r)&&r.every(pe)}function Yo(r){return Array.isArray(r)&&r.every(pe)}function Re(r){return Array.isArray(r)&&r.every(Yo)}function Fe(r){return Array.isArray(r)&&r.every(pe)}function Ge(r){return Array.isArray(r)&&r.every(Se)}function Be(r){return Array.isArray(r)&&r.every(Re)}function lr(r){if(r=r.filter(function(e,t,i){return t===0||!gi(e,i[t-1])}),r.length<2)throw new Error("LineString should contain at least 2 points");return r}function pi(r){if(r=r.filter(function(e,t,i){return t===0||!gi(e,i[t-1])}),Ko(r)&&r.splice(-1),r.length<3)throw new Error("Ring should contain at least 3 points");return r}function bn(r){return r.map(e=>pi(e))}function Jo(r){return r.map(e=>lr(e))}function Qo(r){return r.map(e=>bn(e))}function cr(r){return{type:"Point",coordinates:r}}function hr(r){return{type:"LineString",coordinates:r}}function ur(r,e=!0){const t={type:"Polygon",coordinates:e?r.map(i=>[...i,i[0]]):r};return xn(t)}function Ko(r){return Array.isArray(r)&&r.length>=2&&gi(r[0],r[r.length-1])}function gi(r,e){return r===e?!0:r===null||e===null?!1:r[0]===e[0]&&r[1]===e[1]}function ea(r){return[r[0],-r[1]]}function dr(r,e){return[(e[0]-r[0])/2+r[0],(e[1]-r[1])/2+r[1]]}function ta(r,e,t){return r*t+e*(1-t)}function ra(r,e,t){return[r[0]*t+e[0]*(1-t),r[1]*t+e[1]*(1-t)]}function xe(r,e){if(Se(r)&&r.length===2)return xe(r[0],r[1]);if(pe(r)&&pe(e))return Math.sqrt((e[0]-r[0])**2+(e[1]-r[1])**2);throw new Error("Input type not supported")}function ia(r){return r*(Math.PI/180)}function Ue(r){return typeof r=="object"&&r!==null&&r.type==="Point"&&pe(r.coordinates)}function We(r){return typeof r=="object"&&r!==null&&r.type==="LineString"&&Se(r.coordinates)}function ze(r){return typeof r=="object"&&r!==null&&r.type==="Polygon"&&Array.isArray(r.coordinates)&&Re(r.coordinates)}function Ve(r){return typeof r=="object"&&r!==null&&r.type==="MultiPoint"&&Fe(r.coordinates)}function $e(r){return typeof r=="object"&&r!==null&&r.type==="MultiLineString"&&Ge(r.coordinates)}function qe(r){return typeof r=="object"&&r!==null&&r.type==="MultiPolygon"&&Array.isArray(r.coordinates)&&Be(r.coordinates)}function na(r){const e=typeof r=="object"&&r!==null,i=e&&"type"in r&&typeof r.type=="string"&&(r.type==="Point"||r.type==="LineString"||r.type==="Polygon"||r.type==="MultiPoint"||r.type==="MultiLineString"||r.type==="MultiPolygon"),n=e&&"coordinates"in r&&Array.isArray(r.coordinates);return i&&n}function At(r){return r.coordinates}function Ct(r){return lr(r.coordinates)}function kt(r,e=!1){let t=r.coordinates;return t=bn(t),e?t.map(i=>[...i,i[0]]):t}function sa(r){return r.coordinates}function oa(r){return Jo(r.coordinates)}function aa(r,e=!1){let t=r.coordinates;return t=Qo(t),e?t.map(i=>i.map(n=>[...n,n[0]])):t}function la(r){if(Ue(r))return At(r);if(We(r))return Ct(r);if(ze(r))return kt(r);if(Ve(r))return sa(r);if($e(r))return oa(r);if(qe(r))return aa(r);throw new Error("Geometry type not supported")}function fr(r){return r.coordinates.map(e=>({type:"Point",coordinates:e}))}function pr(r){return r.coordinates.map(e=>({type:"LineString",coordinates:e}))}function gr(r){return r.coordinates.map(e=>({type:"Polygon",coordinates:e}))}function mr(r){return{type:"MultiPoint",coordinates:r.map(e=>e.coordinates)}}function vr(r){return{type:"MultiLineString",coordinates:r.map(e=>e.coordinates)}}function yr(r){return{type:"MultiPolygon",coordinates:r.map(e=>e.coordinates)}}function ca(r,e){return{type:"Feature",properties:e||{},geometry:r}}function ha(r,e){return{type:"FeatureCollection",features:r.map((t,i)=>ca(t))}}function ua(r){return r.geometry}function da(r){return r.features.map(ua)}function Mn(r){let e=Number.POSITIVE_INFINITY,t=Number.NEGATIVE_INFINITY;for(const i of r)e===void 0?i>=i&&(e=t=i):(e>i&&(e=i),t<i&&(t=i));return[e,t]}function ue(r){if(pe(r)&&(r=[r]),Re(r)&&(r=r.flat()),na(r))return ue(la(r));const e=[],t=[];for(const a of r)e.push(a[0]),t.push(a[1]);const[i,n]=Mn(e),[s,o]=Mn(t);return[i,s,n,o]}function Tn(r,e){return[Math.min(r[0],e[0]),Math.min(r[1],e[1]),Math.max(r[2],e[2]),Math.max(r[3],e[3])]}function fa(r,e){const t=r[2]>=e[0]&&e[2]>=r[0],i=r[3]>=e[1]&&e[3]>=r[1];return t&&i}function wr(r){return[[r[0],r[1]],[r[2],r[1]],[r[2],r[3]],[r[0],r[3]]]}function En(r){return[[r[0],r[1]],[r[2],r[3]]]}function pa(r){return xe(En(r))}function ga(r){return xe(En(ue(r)))}function dt(r){return[(r[0]+r[2])/2,(r[1]+r[3])/2]}function mi(r){return[r[2]-r[0],r[3]-r[1]]}function vi(r){return[.5*(xe(r[0],r[1])+xe(r[2],r[3])),.5*(xe(r[1],r[2])+xe(r[3],r[0]))]}function xr(r,e,t){return t?t==="contain"?e[0]>=e[1]?r[0]/e[0]:r[1]/e[1]:e[0]>=e[1]?r[1]/e[1]:r[0]/e[0]:Math.sqrt(r[0]*r[1]/(e[0]*e[1]))}function Pn(r,e){return xr(vi(r),vi(e))}function _r(r,e,t,i=!0){if(r.has(e)&&i)return r.get(e);{const n=t();return r.set(e,n),n}}function yi(r,e,t,i,n=!0){if(r.get(e)?.has(t)&&n)return r.get(e)?.get(t);{const s=i();return r.get(e)||r.set(e,new Map),r.get(e)?.set(t,s),s}}function ma(r){const e=parseInt(r.replace(/^#/,""),16),t=e>>16&255,i=e>>8&255,n=e&255;return[t,i,n]}function br(r){return ma(r).map(e=>e/255)}function va(r,e){return!r||!e||r.size!==e.size?!1:[...r].every(t=>e.has(t))}function Sn(r,e){if(r!==void 0&&e!==void 0)return Math.max(r,e);if(r!==void 0)return r;if(e!==void 0)return e}function ya(r){let e;try{e=new URL(r)}catch{return!1}return e.protocol==="http:"||e.protocol==="https:"}function wa(r,e){e===void 0&&(e={});var t=e.offsetLine||0,i=e.offsetColumn||0,n=r.split(`
`),s=0,o=n.map(function(u,g){var y=s+u.length+1,v={start:s,end:y,line:g};return s=y,v}),a=0;function l(u,g){return u.start<=g&&g<u.end}function c(u,g){return{line:t+u.line,column:i+g-u.start,character:g}}function h(u,g){typeof u=="string"&&(u=r.indexOf(u,g||0));for(var y=o[a],v=u>=y.end?1:-1;y;){if(l(y,u))return c(y,u);a+=v,y=o[a]}}return h}function xa(r,e,t){return wa(r,t)(e,t)}var Rn=/[a-zA-Z0-9:_-]/,In=/[\s\t\r\n]/,_a=/['"]/;function ba(r,e){for(var t="";e--;)t+=r;return t}function Ma(r){var e="",t=[],i=a,n=null,s=null;function o(p){var _=xa(r,d),R=_.line,A=_.column,M=r.slice(0,d),f=/(^|\n).*$/.exec(M)[0].replace(/\t/g,"  "),x=r.slice(d),T=/.*(\n|$)/.exec(x)[0],b=""+f+T+`
`+ba(" ",f.length)+"^";throw new Error(p+" ("+R+":"+A+`). If this is valid SVG, it's probably a bug in svg-parser. Please raise an issue at https://github.com/Rich-Harris/svg-parser/issues â€“ thanks!

`+b)}function a(){for(;d<r.length&&r[d]!=="<"||!Rn.test(r[d+1]);)e+=r[d++];return l()}function l(){for(var p="";d<r.length&&r[d]!=="<";)p+=r[d++];return/\S/.test(p)&&n.children.push({type:"text",value:p}),r[d]==="<"?c:l}function c(){var p=r[d];if(p==="?")return l;if(p==="!"){if(r.slice(d+1,d+3)==="--")return h;if(r.slice(d+1,d+8)==="[CDATA[")return u;if(/doctype/i.test(r.slice(d+1,d+8)))return l}if(p==="/")return g;var _=y(),R={type:"element",tagName:_,properties:{},children:[]};n?n.children.push(R):s=R;for(var A;d<r.length&&(A=v());)R.properties[A.name]=A.value;var M=!1;return r[d]==="/"&&(d+=1,M=!0),r[d]!==">"&&o("Expected >"),M||(n=R,t.push(R)),l}function h(){var p=r.indexOf("-->",d);return~p||o("expected -->"),d=p+2,l}function u(){var p=r.indexOf("]]>",d);return~p||o("expected ]]>"),n.children.push(r.slice(d+7,p)),d=p+2,l}function g(){var p=y();return p||o("Expected tag name"),p!==n.tagName&&o("Expected closing tag </"+p+"> to match opening tag <"+n.tagName+">"),S(),r[d]!==">"&&o("Expected >"),t.pop(),n=t[t.length-1],l}function y(){for(var p="";d<r.length&&Rn.test(r[d]);)p+=r[d++];return p}function v(){if(!In.test(r[d]))return null;S();var p=y();if(!p)return null;var _=!0;return S(),r[d]==="="&&(d+=1,S(),_=E(),!isNaN(_)&&_.trim()!==""&&(_=+_)),{name:p,value:_}}function E(){return _a.test(r[d])?w():P()}function P(){var p="";do{var _=r[d];if(_===" "||_===">"||_==="/")return p;p+=_,d+=1}while(d<r.length);return p}function w(){for(var p=r[d++],_="",R=!1;d<r.length;){var A=r[d++];if(A===p&&!R)return _;A==="\\"&&!R&&(R=!0),_+=R?"\\"+A:A,R=!1}}function S(){for(;d<r.length&&In.test(r[d]);)d+=1}for(var d=a.length;d<r.length;)i||o("Unexpected character"),i=i(),d+=1;return i!==l&&o("Unexpected end of input"),s.tagName==="svg"&&(s.metadata=e),{type:"root",children:[s]}}function*Ta(r){function*e(i){if("children"in i)for(const n of i.children)typeof n!="string"&&(yield*e(n));yield i}const t=Ma(r);for(const i of e(t))if("tagName"in i&&i.tagName!=="svg"&&i.tagName!=="g"){const n=Ea(i);n&&(yield n)}}function Ea(r){const e=r?.tagName?.toLowerCase();if(e==="circle")return{type:"circle",coordinates:[se(r,"cx"),se(r,"cy")]};if(e==="line")return{type:"line",coordinates:[[se(r,"x1"),se(r,"y1")],[se(r,"x2"),se(r,"y2")]]};if(e==="polyline")return{type:"polyline",coordinates:An(r)};if(e==="polygon")return{type:"polygon",coordinates:An(r)};if(e==="rect")return{type:"rect",coordinates:[[se(r,"x"),se(r,"y")],[se(r,"x")+se(r,"width"),se(r,"y")],[se(r,"x")+se(r,"width"),se(r,"y")+se(r,"height")],[se(r,"x"),se(r,"y")+se(r,"height")],[se(r,"x"),se(r,"y")]]};throw new Error(`Unsupported SVG element: ${e}`)}function se(r,e){const t=r?.properties?.[e];return Number(t)||0}function An(r){const e=r?.properties?.points;return e?String(e).trim().split(/\s+/).map(t=>{const i=t.split(",").map(n=>Number(n));return[i[0],i[1]]}):[]}function Cn(r){return r.map(e=>e.join(",")).join(" ")}function Pa(r){return`<svg xmlns="http://www.w3.org/2000/svg">
  ${r.map(Sa).join(`
`)}
</svg>`}function Sa(r){if(r.type==="circle")return Lt("circle",{...r.attributes,cx:r.coordinates[0],cy:r.coordinates[1]});if(r.type==="line")return Lt("line",{...r.attributes,x1:r.coordinates[0][0],y1:r.coordinates[0][1],x2:r.coordinates[1][0],y2:r.coordinates[1][1]});if(r.type==="polyline")return Lt("polyline",{...r.attributes,points:Cn(r.coordinates)});if(r.type==="polygon")return Lt("polygon",{...r.attributes,points:Cn(r.coordinates)});if(r.type==="rect")return Lt("rect",{...r.attributes,x:r.coordinates[0][0],y:r.coordinates[0][1],width:r.coordinates[1][0]-r.coordinates[0][0],height:r.coordinates[2][1]-r.coordinates[0][1]});throw new Error("Unknown SVG element")}function Lt(r,e){const t=Object.entries(e).map(([i,n])=>`${i}="${n}"`);return`<${r} ${t.join(" ")} />`}function Ra([r,e]){const i=6378137*ia(r),n=i/r,s=180/Math.PI*Math.log(Math.tan(Math.PI/4+e*(Math.PI/180)/2))*n;return[i,s]}function kn([r,e]){const i=Math.PI*6378137,n=r/i*180;let s=e/i*180;return s=180/Math.PI*(2*Math.atan(Math.exp(s*Math.PI/180))-Math.PI/2),[n,s]}class Mr{geoCenter;geoRectangle;geoSize;geoRectangleBbox;projectedGeoCenter;projectedGeoRectangle;projectedGeoSize;projectedGeoRectangleBbox;rotation;projectedGeoPerViewportScale;viewportCenter;viewportRectangle;viewportSize;viewportBbox;devicePixelRatio;canvasCenter;canvasRectangle;canvasSize;canvasBbox;projectedGeoPerCanvasScale;projectedGeoToViewportTransform=[1,0,0,1,0,0];projectedGeoToClipTransform=[1,0,0,1,0,0];constructor(e,t,i,n,s=1){this.projectedGeoCenter=t,this.projectedGeoPerViewportScale=i,this.rotation=n,this.viewportSize=e,this.devicePixelRatio=s,this.projectedGeoRectangle=this.computeProjectedGeoRectangle(this.projectedGeoCenter,this.projectedGeoPerViewportScale,this.rotation,this.viewportSize),this.projectedGeoRectangleBbox=ue(this.projectedGeoRectangle),this.projectedGeoSize=[this.viewportSize[0]*i,this.viewportSize[1]*i],this.geoCenter=kn(this.projectedGeoCenter),this.geoRectangle=this.projectedGeoRectangle.map(o=>kn(o)),this.geoRectangleBbox=ue(this.geoRectangle),this.geoSize=mi(this.geoRectangleBbox),this.viewportCenter=[this.viewportSize[0]/2,this.viewportSize[1]/2],this.viewportBbox=[0,0,...this.viewportSize],this.viewportRectangle=wr(this.viewportBbox),this.canvasCenter=[this.viewportCenter[0]*this.devicePixelRatio,this.viewportSize[1]*this.devicePixelRatio],this.canvasSize=[this.viewportSize[0]*this.devicePixelRatio,this.viewportSize[1]*this.devicePixelRatio],this.canvasBbox=[0,0,...this.canvasSize],this.canvasRectangle=wr(this.canvasBbox),this.projectedGeoPerCanvasScale=this.projectedGeoPerViewportScale/this.devicePixelRatio,this.projectedGeoToViewportTransform=this.composeProjectedGeoToViewportTransform(),this.projectedGeoToClipTransform=this.composeProjectedGeoToClipTransform()}static fromWarpedMapList(e,t,i,n="contain",s=1){const o=t.getProjectedCenter(),a=t.getProjectedBbox();if(!o||!a)throw new Error("WarpedMapList has no projected center or bbox");const l=mi(a),c=xr(l,e,n)*(1/s);return new Mr(e,o,c,0,i)}static fromProjectedGeoBbox(e,t,i,n="contain"){const s=dt(t),o=mi(t),a=xr(o,e,n);return new Mr(e,s,a,0,i)}composeProjectedGeoToViewportTransform(){return yn(this.viewportSize[0]/2,this.viewportSize[1]/2,1/this.projectedGeoPerViewportScale,-1/this.projectedGeoPerViewportScale,-this.rotation,-this.projectedGeoCenter[0],-this.projectedGeoCenter[1])}composeProjectedGeoToClipTransform(){return yn(0,0,2/(this.projectedGeoPerViewportScale*this.viewportSize[0]),2/(this.projectedGeoPerViewportScale*this.viewportSize[1]),-this.rotation,-this.projectedGeoCenter[0],-this.projectedGeoCenter[1])}computeProjectedGeoRectangle(e,t,i,n){const s=t*n[0]/2,o=t*n[1]/2,a=Math.cos(i),l=Math.sin(i),c=s*a,h=s*l,u=o*a,g=o*l,y=e[0],v=e[1];return[[y-c+g,v-h-u],[y-c-g,v-h+u],[y+c-g,v+h+u],[y+c+g,v+h-u]]}}function wi(r){return Array.isArray(r)?`[${r.map(e=>wi(e)).join(",")}]`:typeof r=="number"?`${r}`:typeof r=="string"?`"${r}"`:typeof r=="object"&&r!==null?Object.keys(r).sort().map(e=>`${e}:${wi(r[e])}`).join("|"):String(r)}async function Ia(r){const e=await crypto.subtle.digest("SHA-1",new TextEncoder().encode(r));return Array.from(new Uint8Array(e)).map(n=>n.toString(16).padStart(2,"0")).join("")}async function Ln(r,e=16){return(await Ia(String(r))).slice(0,e)}async function Aa(r,e){return await Ln(wi(r),e)}var H;(function(r){r.assertEqual=n=>n;function e(n){}r.assertIs=e;function t(n){throw new Error}r.assertNever=t,r.arrayToEnum=n=>{const s={};for(const o of n)s[o]=o;return s},r.getValidEnumValues=n=>{const s=r.objectKeys(n).filter(a=>typeof n[n[a]]!="number"),o={};for(const a of s)o[a]=n[a];return r.objectValues(o)},r.objectValues=n=>r.objectKeys(n).map(function(s){return n[s]}),r.objectKeys=typeof Object.keys=="function"?n=>Object.keys(n):n=>{const s=[];for(const o in n)Object.prototype.hasOwnProperty.call(n,o)&&s.push(o);return s},r.find=(n,s)=>{for(const o of n)if(s(o))return o},r.isInteger=typeof Number.isInteger=="function"?n=>Number.isInteger(n):n=>typeof n=="number"&&isFinite(n)&&Math.floor(n)===n;function i(n,s=" | "){return n.map(o=>typeof o=="string"?`'${o}'`:o).join(s)}r.joinValues=i,r.jsonStringifyReplacer=(n,s)=>typeof s=="bigint"?s.toString():s})(H||(H={}));var xi;(function(r){r.mergeShapes=(e,t)=>({...e,...t})})(xi||(xi={}));const O=H.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Qe=r=>{switch(typeof r){case"undefined":return O.undefined;case"string":return O.string;case"number":return isNaN(r)?O.nan:O.number;case"boolean":return O.boolean;case"function":return O.function;case"bigint":return O.bigint;case"symbol":return O.symbol;case"object":return Array.isArray(r)?O.array:r===null?O.null:r.then&&typeof r.then=="function"&&r.catch&&typeof r.catch=="function"?O.promise:typeof Map<"u"&&r instanceof Map?O.map:typeof Set<"u"&&r instanceof Set?O.set:typeof Date<"u"&&r instanceof Date?O.date:O.object;default:return O.unknown}},I=H.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),Ca=r=>JSON.stringify(r,null,2).replace(/"([^"]+)":/g,"$1:");class _e extends Error{constructor(e){super(),this.issues=[],this.addIssue=i=>{this.issues=[...this.issues,i]},this.addIssues=(i=[])=>{this.issues=[...this.issues,...i]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){const t=e||function(s){return s.message},i={_errors:[]},n=s=>{for(const o of s.issues)if(o.code==="invalid_union")o.unionErrors.map(n);else if(o.code==="invalid_return_type")n(o.returnTypeError);else if(o.code==="invalid_arguments")n(o.argumentsError);else if(o.path.length===0)i._errors.push(t(o));else{let a=i,l=0;for(;l<o.path.length;){const c=o.path[l];l===o.path.length-1?(a[c]=a[c]||{_errors:[]},a[c]._errors.push(t(o))):a[c]=a[c]||{_errors:[]},a=a[c],l++}}};return n(this),i}static assert(e){if(!(e instanceof _e))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,H.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},i=[];for(const n of this.issues)n.path.length>0?(t[n.path[0]]=t[n.path[0]]||[],t[n.path[0]].push(e(n))):i.push(e(n));return{formErrors:i,fieldErrors:t}}get formErrors(){return this.flatten()}}_e.create=r=>new _e(r);const ft=(r,e)=>{let t;switch(r.code){case I.invalid_type:r.received===O.undefined?t="Required":t=`Expected ${r.expected}, received ${r.received}`;break;case I.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(r.expected,H.jsonStringifyReplacer)}`;break;case I.unrecognized_keys:t=`Unrecognized key(s) in object: ${H.joinValues(r.keys,", ")}`;break;case I.invalid_union:t="Invalid input";break;case I.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${H.joinValues(r.options)}`;break;case I.invalid_enum_value:t=`Invalid enum value. Expected ${H.joinValues(r.options)}, received '${r.received}'`;break;case I.invalid_arguments:t="Invalid function arguments";break;case I.invalid_return_type:t="Invalid function return type";break;case I.invalid_date:t="Invalid date";break;case I.invalid_string:typeof r.validation=="object"?"includes"in r.validation?(t=`Invalid input: must include "${r.validation.includes}"`,typeof r.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${r.validation.position}`)):"startsWith"in r.validation?t=`Invalid input: must start with "${r.validation.startsWith}"`:"endsWith"in r.validation?t=`Invalid input: must end with "${r.validation.endsWith}"`:H.assertNever(r.validation):r.validation!=="regex"?t=`Invalid ${r.validation}`:t="Invalid";break;case I.too_small:r.type==="array"?t=`Array must contain ${r.exact?"exactly":r.inclusive?"at least":"more than"} ${r.minimum} element(s)`:r.type==="string"?t=`String must contain ${r.exact?"exactly":r.inclusive?"at least":"over"} ${r.minimum} character(s)`:r.type==="number"?t=`Number must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${r.minimum}`:r.type==="date"?t=`Date must be ${r.exact?"exactly equal to ":r.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(r.minimum))}`:t="Invalid input";break;case I.too_big:r.type==="array"?t=`Array must contain ${r.exact?"exactly":r.inclusive?"at most":"less than"} ${r.maximum} element(s)`:r.type==="string"?t=`String must contain ${r.exact?"exactly":r.inclusive?"at most":"under"} ${r.maximum} character(s)`:r.type==="number"?t=`Number must be ${r.exact?"exactly":r.inclusive?"less than or equal to":"less than"} ${r.maximum}`:r.type==="bigint"?t=`BigInt must be ${r.exact?"exactly":r.inclusive?"less than or equal to":"less than"} ${r.maximum}`:r.type==="date"?t=`Date must be ${r.exact?"exactly":r.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(r.maximum))}`:t="Invalid input";break;case I.custom:t="Invalid input";break;case I.invalid_intersection_types:t="Intersection results could not be merged";break;case I.not_multiple_of:t=`Number must be a multiple of ${r.multipleOf}`;break;case I.not_finite:t="Number must be finite";break;default:t=e.defaultError,H.assertNever(r)}return{message:t}};let jn=ft;function ka(r){jn=r}function Tr(){return jn}const Er=r=>{const{data:e,path:t,errorMaps:i,issueData:n}=r,s=[...t,...n.path||[]],o={...n,path:s};if(n.message!==void 0)return{...n,path:s,message:n.message};let a="";const l=i.filter(c=>!!c).slice().reverse();for(const c of l)a=c(o,{data:e,defaultError:a}).message;return{...n,path:s,message:a}},La=[];function j(r,e){const t=Tr(),i=Er({issueData:e,data:r.data,path:r.path,errorMaps:[r.common.contextualErrorMap,r.schemaErrorMap,t,t===ft?void 0:ft].filter(n=>!!n)});r.common.issues.push(i)}class de{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const i=[];for(const n of t){if(n.status==="aborted")return F;n.status==="dirty"&&e.dirty(),i.push(n.value)}return{status:e.value,value:i}}static async mergeObjectAsync(e,t){const i=[];for(const n of t){const s=await n.key,o=await n.value;i.push({key:s,value:o})}return de.mergeObjectSync(e,i)}static mergeObjectSync(e,t){const i={};for(const n of t){const{key:s,value:o}=n;if(s.status==="aborted"||o.status==="aborted")return F;s.status==="dirty"&&e.dirty(),o.status==="dirty"&&e.dirty(),s.value!=="__proto__"&&(typeof o.value<"u"||n.alwaysSet)&&(i[s.value]=o.value)}return{status:e.value,value:i}}}const F=Object.freeze({status:"aborted"}),pt=r=>({status:"dirty",value:r}),ge=r=>({status:"valid",value:r}),_i=r=>r.status==="aborted",bi=r=>r.status==="dirty",jt=r=>r.status==="valid",Ot=r=>typeof Promise<"u"&&r instanceof Promise;function Pr(r,e,t,i){if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e.get(r)}function On(r,e,t,i,n){if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(r,t),t}typeof SuppressedError=="function"&&SuppressedError;var N;(function(r){r.errToObj=e=>typeof e=="string"?{message:e}:e||{},r.toString=e=>typeof e=="string"?e:e?.message})(N||(N={}));var Nt,Dt;class Le{constructor(e,t,i,n){this._cachedPath=[],this.parent=e,this.data=t,this._path=i,this._key=n}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Nn=(r,e)=>{if(jt(e))return{success:!0,data:e.value};if(!r.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new _e(r.common.issues);return this._error=t,this._error}}};function G(r){if(!r)return{};const{errorMap:e,invalid_type_error:t,required_error:i,description:n}=r;if(e&&(t||i))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:n}:{errorMap:(o,a)=>{var l,c;const{message:h}=r;return o.code==="invalid_enum_value"?{message:h??a.defaultError}:typeof a.data>"u"?{message:(l=h??i)!==null&&l!==void 0?l:a.defaultError}:o.code!=="invalid_type"?{message:a.defaultError}:{message:(c=h??t)!==null&&c!==void 0?c:a.defaultError}},description:n}}class B{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return Qe(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Qe(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new de,ctx:{common:e.parent.common,data:e.data,parsedType:Qe(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(Ot(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const i=this.safeParse(e,t);if(i.success)return i.data;throw i.error}safeParse(e,t){var i;const n={common:{issues:[],async:(i=t?.async)!==null&&i!==void 0?i:!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Qe(e)},s=this._parseSync({data:e,path:n.path,parent:n});return Nn(n,s)}async parseAsync(e,t){const i=await this.safeParseAsync(e,t);if(i.success)return i.data;throw i.error}async safeParseAsync(e,t){const i={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Qe(e)},n=this._parse({data:e,path:i.path,parent:i}),s=await(Ot(n)?n:Promise.resolve(n));return Nn(i,s)}refine(e,t){const i=n=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(n):t;return this._refinement((n,s)=>{const o=e(n),a=()=>s.addIssue({code:I.custom,...i(n)});return typeof Promise<"u"&&o instanceof Promise?o.then(l=>l?!0:(a(),!1)):o?!0:(a(),!1)})}refinement(e,t){return this._refinement((i,n)=>e(i)?!0:(n.addIssue(typeof t=="function"?t(i,n):t),!1))}_refinement(e){return new Ce({schema:this,typeName:D.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return Oe.create(this,this._def)}nullable(){return rt.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Ae.create(this,this._def)}promise(){return yt.create(this,this._def)}or(e){return Ut.create([this,e],this._def)}and(e){return Wt.create(this,e,this._def)}transform(e){return new Ce({...G(this._def),schema:this,typeName:D.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new Zt({...G(this._def),innerType:this,defaultValue:t,typeName:D.ZodDefault})}brand(){return new Ei({typeName:D.ZodBranded,type:this,...G(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new Xt({...G(this._def),innerType:this,catchValue:t,typeName:D.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return Ht.create(this,e)}readonly(){return Yt.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const ja=/^c[^\s-]{8,}$/i,Oa=/^[0-9a-z]+$/,Na=/^[0-9A-HJKMNP-TV-Z]{26}$/,Da=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Fa=/^[a-z0-9_-]{21}$/i,Ga=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Ba=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Ua="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Mi;const Wa=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,za=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,Va=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Dn="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",$a=new RegExp(`^${Dn}$`);function Fn(r){let e="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return r.precision?e=`${e}\\.\\d{${r.precision}}`:r.precision==null&&(e=`${e}(\\.\\d+)?`),e}function qa(r){return new RegExp(`^${Fn(r)}$`)}function Gn(r){let e=`${Dn}T${Fn(r)}`;const t=[];return t.push(r.local?"Z?":"Z"),r.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function Za(r,e){return!!((e==="v4"||!e)&&Wa.test(r)||(e==="v6"||!e)&&za.test(r))}class Ie extends B{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==O.string){const s=this._getOrReturnCtx(e);return j(s,{code:I.invalid_type,expected:O.string,received:s.parsedType}),F}const i=new de;let n;for(const s of this._def.checks)if(s.kind==="min")e.data.length<s.value&&(n=this._getOrReturnCtx(e,n),j(n,{code:I.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),i.dirty());else if(s.kind==="max")e.data.length>s.value&&(n=this._getOrReturnCtx(e,n),j(n,{code:I.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),i.dirty());else if(s.kind==="length"){const o=e.data.length>s.value,a=e.data.length<s.value;(o||a)&&(n=this._getOrReturnCtx(e,n),o?j(n,{code:I.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):a&&j(n,{code:I.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),i.dirty())}else if(s.kind==="email")Ba.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"email",code:I.invalid_string,message:s.message}),i.dirty());else if(s.kind==="emoji")Mi||(Mi=new RegExp(Ua,"u")),Mi.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"emoji",code:I.invalid_string,message:s.message}),i.dirty());else if(s.kind==="uuid")Da.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"uuid",code:I.invalid_string,message:s.message}),i.dirty());else if(s.kind==="nanoid")Fa.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"nanoid",code:I.invalid_string,message:s.message}),i.dirty());else if(s.kind==="cuid")ja.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"cuid",code:I.invalid_string,message:s.message}),i.dirty());else if(s.kind==="cuid2")Oa.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"cuid2",code:I.invalid_string,message:s.message}),i.dirty());else if(s.kind==="ulid")Na.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"ulid",code:I.invalid_string,message:s.message}),i.dirty());else if(s.kind==="url")try{new URL(e.data)}catch{n=this._getOrReturnCtx(e,n),j(n,{validation:"url",code:I.invalid_string,message:s.message}),i.dirty()}else s.kind==="regex"?(s.regex.lastIndex=0,s.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"regex",code:I.invalid_string,message:s.message}),i.dirty())):s.kind==="trim"?e.data=e.data.trim():s.kind==="includes"?e.data.includes(s.value,s.position)||(n=this._getOrReturnCtx(e,n),j(n,{code:I.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),i.dirty()):s.kind==="toLowerCase"?e.data=e.data.toLowerCase():s.kind==="toUpperCase"?e.data=e.data.toUpperCase():s.kind==="startsWith"?e.data.startsWith(s.value)||(n=this._getOrReturnCtx(e,n),j(n,{code:I.invalid_string,validation:{startsWith:s.value},message:s.message}),i.dirty()):s.kind==="endsWith"?e.data.endsWith(s.value)||(n=this._getOrReturnCtx(e,n),j(n,{code:I.invalid_string,validation:{endsWith:s.value},message:s.message}),i.dirty()):s.kind==="datetime"?Gn(s).test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{code:I.invalid_string,validation:"datetime",message:s.message}),i.dirty()):s.kind==="date"?$a.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{code:I.invalid_string,validation:"date",message:s.message}),i.dirty()):s.kind==="time"?qa(s).test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{code:I.invalid_string,validation:"time",message:s.message}),i.dirty()):s.kind==="duration"?Ga.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"duration",code:I.invalid_string,message:s.message}),i.dirty()):s.kind==="ip"?Za(e.data,s.version)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"ip",code:I.invalid_string,message:s.message}),i.dirty()):s.kind==="base64"?Va.test(e.data)||(n=this._getOrReturnCtx(e,n),j(n,{validation:"base64",code:I.invalid_string,message:s.message}),i.dirty()):H.assertNever(s);return{status:i.value,value:e.data}}_regex(e,t,i){return this.refinement(n=>e.test(n),{validation:t,code:I.invalid_string,...N.errToObj(i)})}_addCheck(e){return new Ie({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...N.errToObj(e)})}url(e){return this._addCheck({kind:"url",...N.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...N.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...N.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...N.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...N.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...N.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...N.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...N.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...N.errToObj(e)})}datetime(e){var t,i;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof e?.precision>"u"?null:e?.precision,offset:(t=e?.offset)!==null&&t!==void 0?t:!1,local:(i=e?.local)!==null&&i!==void 0?i:!1,...N.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof e?.precision>"u"?null:e?.precision,...N.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...N.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...N.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...N.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...N.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...N.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...N.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...N.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...N.errToObj(t)})}nonempty(e){return this.min(1,N.errToObj(e))}trim(){return new Ie({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Ie({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Ie({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}Ie.create=r=>{var e;return new Ie({checks:[],typeName:D.ZodString,coerce:(e=r?.coerce)!==null&&e!==void 0?e:!1,...G(r)})};function Xa(r,e){const t=(r.toString().split(".")[1]||"").length,i=(e.toString().split(".")[1]||"").length,n=t>i?t:i,s=parseInt(r.toFixed(n).replace(".","")),o=parseInt(e.toFixed(n).replace(".",""));return s%o/Math.pow(10,n)}class Ke extends B{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==O.number){const s=this._getOrReturnCtx(e);return j(s,{code:I.invalid_type,expected:O.number,received:s.parsedType}),F}let i;const n=new de;for(const s of this._def.checks)s.kind==="int"?H.isInteger(e.data)||(i=this._getOrReturnCtx(e,i),j(i,{code:I.invalid_type,expected:"integer",received:"float",message:s.message}),n.dirty()):s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(i=this._getOrReturnCtx(e,i),j(i,{code:I.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),n.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(i=this._getOrReturnCtx(e,i),j(i,{code:I.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),n.dirty()):s.kind==="multipleOf"?Xa(e.data,s.value)!==0&&(i=this._getOrReturnCtx(e,i),j(i,{code:I.not_multiple_of,multipleOf:s.value,message:s.message}),n.dirty()):s.kind==="finite"?Number.isFinite(e.data)||(i=this._getOrReturnCtx(e,i),j(i,{code:I.not_finite,message:s.message}),n.dirty()):H.assertNever(s);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,N.toString(t))}gt(e,t){return this.setLimit("min",e,!1,N.toString(t))}lte(e,t){return this.setLimit("max",e,!0,N.toString(t))}lt(e,t){return this.setLimit("max",e,!1,N.toString(t))}setLimit(e,t,i,n){return new Ke({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:i,message:N.toString(n)}]})}_addCheck(e){return new Ke({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:N.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:N.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:N.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:N.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:N.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:N.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:N.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:N.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:N.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&H.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const i of this._def.checks){if(i.kind==="finite"||i.kind==="int"||i.kind==="multipleOf")return!0;i.kind==="min"?(t===null||i.value>t)&&(t=i.value):i.kind==="max"&&(e===null||i.value<e)&&(e=i.value)}return Number.isFinite(t)&&Number.isFinite(e)}}Ke.create=r=>new Ke({checks:[],typeName:D.ZodNumber,coerce:r?.coerce||!1,...G(r)});class et extends B{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==O.bigint){const s=this._getOrReturnCtx(e);return j(s,{code:I.invalid_type,expected:O.bigint,received:s.parsedType}),F}let i;const n=new de;for(const s of this._def.checks)s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(i=this._getOrReturnCtx(e,i),j(i,{code:I.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),n.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(i=this._getOrReturnCtx(e,i),j(i,{code:I.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),n.dirty()):s.kind==="multipleOf"?e.data%s.value!==BigInt(0)&&(i=this._getOrReturnCtx(e,i),j(i,{code:I.not_multiple_of,multipleOf:s.value,message:s.message}),n.dirty()):H.assertNever(s);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,N.toString(t))}gt(e,t){return this.setLimit("min",e,!1,N.toString(t))}lte(e,t){return this.setLimit("max",e,!0,N.toString(t))}lt(e,t){return this.setLimit("max",e,!1,N.toString(t))}setLimit(e,t,i,n){return new et({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:i,message:N.toString(n)}]})}_addCheck(e){return new et({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:N.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:N.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:N.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:N.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:N.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}et.create=r=>{var e;return new et({checks:[],typeName:D.ZodBigInt,coerce:(e=r?.coerce)!==null&&e!==void 0?e:!1,...G(r)})};class Ft extends B{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==O.boolean){const i=this._getOrReturnCtx(e);return j(i,{code:I.invalid_type,expected:O.boolean,received:i.parsedType}),F}return ge(e.data)}}Ft.create=r=>new Ft({typeName:D.ZodBoolean,coerce:r?.coerce||!1,...G(r)});class ot extends B{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==O.date){const s=this._getOrReturnCtx(e);return j(s,{code:I.invalid_type,expected:O.date,received:s.parsedType}),F}if(isNaN(e.data.getTime())){const s=this._getOrReturnCtx(e);return j(s,{code:I.invalid_date}),F}const i=new de;let n;for(const s of this._def.checks)s.kind==="min"?e.data.getTime()<s.value&&(n=this._getOrReturnCtx(e,n),j(n,{code:I.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),i.dirty()):s.kind==="max"?e.data.getTime()>s.value&&(n=this._getOrReturnCtx(e,n),j(n,{code:I.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),i.dirty()):H.assertNever(s);return{status:i.value,value:new Date(e.data.getTime())}}_addCheck(e){return new ot({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:N.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:N.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}ot.create=r=>new ot({checks:[],coerce:r?.coerce||!1,typeName:D.ZodDate,...G(r)});class Sr extends B{_parse(e){if(this._getType(e)!==O.symbol){const i=this._getOrReturnCtx(e);return j(i,{code:I.invalid_type,expected:O.symbol,received:i.parsedType}),F}return ge(e.data)}}Sr.create=r=>new Sr({typeName:D.ZodSymbol,...G(r)});class Gt extends B{_parse(e){if(this._getType(e)!==O.undefined){const i=this._getOrReturnCtx(e);return j(i,{code:I.invalid_type,expected:O.undefined,received:i.parsedType}),F}return ge(e.data)}}Gt.create=r=>new Gt({typeName:D.ZodUndefined,...G(r)});class Bt extends B{_parse(e){if(this._getType(e)!==O.null){const i=this._getOrReturnCtx(e);return j(i,{code:I.invalid_type,expected:O.null,received:i.parsedType}),F}return ge(e.data)}}Bt.create=r=>new Bt({typeName:D.ZodNull,...G(r)});class gt extends B{constructor(){super(...arguments),this._any=!0}_parse(e){return ge(e.data)}}gt.create=r=>new gt({typeName:D.ZodAny,...G(r)});class at extends B{constructor(){super(...arguments),this._unknown=!0}_parse(e){return ge(e.data)}}at.create=r=>new at({typeName:D.ZodUnknown,...G(r)});class Ze extends B{_parse(e){const t=this._getOrReturnCtx(e);return j(t,{code:I.invalid_type,expected:O.never,received:t.parsedType}),F}}Ze.create=r=>new Ze({typeName:D.ZodNever,...G(r)});class Rr extends B{_parse(e){if(this._getType(e)!==O.undefined){const i=this._getOrReturnCtx(e);return j(i,{code:I.invalid_type,expected:O.void,received:i.parsedType}),F}return ge(e.data)}}Rr.create=r=>new Rr({typeName:D.ZodVoid,...G(r)});class Ae extends B{_parse(e){const{ctx:t,status:i}=this._processInputParams(e),n=this._def;if(t.parsedType!==O.array)return j(t,{code:I.invalid_type,expected:O.array,received:t.parsedType}),F;if(n.exactLength!==null){const o=t.data.length>n.exactLength.value,a=t.data.length<n.exactLength.value;(o||a)&&(j(t,{code:o?I.too_big:I.too_small,minimum:a?n.exactLength.value:void 0,maximum:o?n.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:n.exactLength.message}),i.dirty())}if(n.minLength!==null&&t.data.length<n.minLength.value&&(j(t,{code:I.too_small,minimum:n.minLength.value,type:"array",inclusive:!0,exact:!1,message:n.minLength.message}),i.dirty()),n.maxLength!==null&&t.data.length>n.maxLength.value&&(j(t,{code:I.too_big,maximum:n.maxLength.value,type:"array",inclusive:!0,exact:!1,message:n.maxLength.message}),i.dirty()),t.common.async)return Promise.all([...t.data].map((o,a)=>n.type._parseAsync(new Le(t,o,t.path,a)))).then(o=>de.mergeArray(i,o));const s=[...t.data].map((o,a)=>n.type._parseSync(new Le(t,o,t.path,a)));return de.mergeArray(i,s)}get element(){return this._def.type}min(e,t){return new Ae({...this._def,minLength:{value:e,message:N.toString(t)}})}max(e,t){return new Ae({...this._def,maxLength:{value:e,message:N.toString(t)}})}length(e,t){return new Ae({...this._def,exactLength:{value:e,message:N.toString(t)}})}nonempty(e){return this.min(1,e)}}Ae.create=(r,e)=>new Ae({type:r,minLength:null,maxLength:null,exactLength:null,typeName:D.ZodArray,...G(e)});function mt(r){if(r instanceof te){const e={};for(const t in r.shape){const i=r.shape[t];e[t]=Oe.create(mt(i))}return new te({...r._def,shape:()=>e})}else return r instanceof Ae?new Ae({...r._def,type:mt(r.element)}):r instanceof Oe?Oe.create(mt(r.unwrap())):r instanceof rt?rt.create(mt(r.unwrap())):r instanceof je?je.create(r.items.map(e=>mt(e))):r}class te extends B{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=H.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==O.object){const c=this._getOrReturnCtx(e);return j(c,{code:I.invalid_type,expected:O.object,received:c.parsedType}),F}const{status:i,ctx:n}=this._processInputParams(e),{shape:s,keys:o}=this._getCached(),a=[];if(!(this._def.catchall instanceof Ze&&this._def.unknownKeys==="strip"))for(const c in n.data)o.includes(c)||a.push(c);const l=[];for(const c of o){const h=s[c],u=n.data[c];l.push({key:{status:"valid",value:c},value:h._parse(new Le(n,u,n.path,c)),alwaysSet:c in n.data})}if(this._def.catchall instanceof Ze){const c=this._def.unknownKeys;if(c==="passthrough")for(const h of a)l.push({key:{status:"valid",value:h},value:{status:"valid",value:n.data[h]}});else if(c==="strict")a.length>0&&(j(n,{code:I.unrecognized_keys,keys:a}),i.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const c=this._def.catchall;for(const h of a){const u=n.data[h];l.push({key:{status:"valid",value:h},value:c._parse(new Le(n,u,n.path,h)),alwaysSet:h in n.data})}}return n.common.async?Promise.resolve().then(async()=>{const c=[];for(const h of l){const u=await h.key,g=await h.value;c.push({key:u,value:g,alwaysSet:h.alwaysSet})}return c}).then(c=>de.mergeObjectSync(i,c)):de.mergeObjectSync(i,l)}get shape(){return this._def.shape()}strict(e){return N.errToObj,new te({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,i)=>{var n,s,o,a;const l=(o=(s=(n=this._def).errorMap)===null||s===void 0?void 0:s.call(n,t,i).message)!==null&&o!==void 0?o:i.defaultError;return t.code==="unrecognized_keys"?{message:(a=N.errToObj(e).message)!==null&&a!==void 0?a:l}:{message:l}}}:{}})}strip(){return new te({...this._def,unknownKeys:"strip"})}passthrough(){return new te({...this._def,unknownKeys:"passthrough"})}extend(e){return new te({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new te({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:D.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new te({...this._def,catchall:e})}pick(e){const t={};return H.objectKeys(e).forEach(i=>{e[i]&&this.shape[i]&&(t[i]=this.shape[i])}),new te({...this._def,shape:()=>t})}omit(e){const t={};return H.objectKeys(this.shape).forEach(i=>{e[i]||(t[i]=this.shape[i])}),new te({...this._def,shape:()=>t})}deepPartial(){return mt(this)}partial(e){const t={};return H.objectKeys(this.shape).forEach(i=>{const n=this.shape[i];e&&!e[i]?t[i]=n:t[i]=n.optional()}),new te({...this._def,shape:()=>t})}required(e){const t={};return H.objectKeys(this.shape).forEach(i=>{if(e&&!e[i])t[i]=this.shape[i];else{let s=this.shape[i];for(;s instanceof Oe;)s=s._def.innerType;t[i]=s}}),new te({...this._def,shape:()=>t})}keyof(){return Bn(H.objectKeys(this.shape))}}te.create=(r,e)=>new te({shape:()=>r,unknownKeys:"strip",catchall:Ze.create(),typeName:D.ZodObject,...G(e)}),te.strictCreate=(r,e)=>new te({shape:()=>r,unknownKeys:"strict",catchall:Ze.create(),typeName:D.ZodObject,...G(e)}),te.lazycreate=(r,e)=>new te({shape:r,unknownKeys:"strip",catchall:Ze.create(),typeName:D.ZodObject,...G(e)});class Ut extends B{_parse(e){const{ctx:t}=this._processInputParams(e),i=this._def.options;function n(s){for(const a of s)if(a.result.status==="valid")return a.result;for(const a of s)if(a.result.status==="dirty")return t.common.issues.push(...a.ctx.common.issues),a.result;const o=s.map(a=>new _e(a.ctx.common.issues));return j(t,{code:I.invalid_union,unionErrors:o}),F}if(t.common.async)return Promise.all(i.map(async s=>{const o={...t,common:{...t.common,issues:[]},parent:null};return{result:await s._parseAsync({data:t.data,path:t.path,parent:o}),ctx:o}})).then(n);{let s;const o=[];for(const l of i){const c={...t,common:{...t.common,issues:[]},parent:null},h=l._parseSync({data:t.data,path:t.path,parent:c});if(h.status==="valid")return h;h.status==="dirty"&&!s&&(s={result:h,ctx:c}),c.common.issues.length&&o.push(c.common.issues)}if(s)return t.common.issues.push(...s.ctx.common.issues),s.result;const a=o.map(l=>new _e(l));return j(t,{code:I.invalid_union,unionErrors:a}),F}}get options(){return this._def.options}}Ut.create=(r,e)=>new Ut({options:r,typeName:D.ZodUnion,...G(e)});const Xe=r=>r instanceof Vt?Xe(r.schema):r instanceof Ce?Xe(r.innerType()):r instanceof $t?[r.value]:r instanceof tt?r.options:r instanceof qt?H.objectValues(r.enum):r instanceof Zt?Xe(r._def.innerType):r instanceof Gt?[void 0]:r instanceof Bt?[null]:r instanceof Oe?[void 0,...Xe(r.unwrap())]:r instanceof rt?[null,...Xe(r.unwrap())]:r instanceof Ei||r instanceof Yt?Xe(r.unwrap()):r instanceof Xt?Xe(r._def.innerType):[];class Ir extends B{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==O.object)return j(t,{code:I.invalid_type,expected:O.object,received:t.parsedType}),F;const i=this.discriminator,n=t.data[i],s=this.optionsMap.get(n);return s?t.common.async?s._parseAsync({data:t.data,path:t.path,parent:t}):s._parseSync({data:t.data,path:t.path,parent:t}):(j(t,{code:I.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[i]}),F)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,i){const n=new Map;for(const s of t){const o=Xe(s.shape[e]);if(!o.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const a of o){if(n.has(a))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(a)}`);n.set(a,s)}}return new Ir({typeName:D.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:n,...G(i)})}}function Ti(r,e){const t=Qe(r),i=Qe(e);if(r===e)return{valid:!0,data:r};if(t===O.object&&i===O.object){const n=H.objectKeys(e),s=H.objectKeys(r).filter(a=>n.indexOf(a)!==-1),o={...r,...e};for(const a of s){const l=Ti(r[a],e[a]);if(!l.valid)return{valid:!1};o[a]=l.data}return{valid:!0,data:o}}else if(t===O.array&&i===O.array){if(r.length!==e.length)return{valid:!1};const n=[];for(let s=0;s<r.length;s++){const o=r[s],a=e[s],l=Ti(o,a);if(!l.valid)return{valid:!1};n.push(l.data)}return{valid:!0,data:n}}else return t===O.date&&i===O.date&&+r==+e?{valid:!0,data:r}:{valid:!1}}class Wt extends B{_parse(e){const{status:t,ctx:i}=this._processInputParams(e),n=(s,o)=>{if(_i(s)||_i(o))return F;const a=Ti(s.value,o.value);return a.valid?((bi(s)||bi(o))&&t.dirty(),{status:t.value,value:a.data}):(j(i,{code:I.invalid_intersection_types}),F)};return i.common.async?Promise.all([this._def.left._parseAsync({data:i.data,path:i.path,parent:i}),this._def.right._parseAsync({data:i.data,path:i.path,parent:i})]).then(([s,o])=>n(s,o)):n(this._def.left._parseSync({data:i.data,path:i.path,parent:i}),this._def.right._parseSync({data:i.data,path:i.path,parent:i}))}}Wt.create=(r,e,t)=>new Wt({left:r,right:e,typeName:D.ZodIntersection,...G(t)});class je extends B{_parse(e){const{status:t,ctx:i}=this._processInputParams(e);if(i.parsedType!==O.array)return j(i,{code:I.invalid_type,expected:O.array,received:i.parsedType}),F;if(i.data.length<this._def.items.length)return j(i,{code:I.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),F;!this._def.rest&&i.data.length>this._def.items.length&&(j(i,{code:I.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const s=[...i.data].map((o,a)=>{const l=this._def.items[a]||this._def.rest;return l?l._parse(new Le(i,o,i.path,a)):null}).filter(o=>!!o);return i.common.async?Promise.all(s).then(o=>de.mergeArray(t,o)):de.mergeArray(t,s)}get items(){return this._def.items}rest(e){return new je({...this._def,rest:e})}}je.create=(r,e)=>{if(!Array.isArray(r))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new je({items:r,typeName:D.ZodTuple,rest:null,...G(e)})};class zt extends B{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:i}=this._processInputParams(e);if(i.parsedType!==O.object)return j(i,{code:I.invalid_type,expected:O.object,received:i.parsedType}),F;const n=[],s=this._def.keyType,o=this._def.valueType;for(const a in i.data)n.push({key:s._parse(new Le(i,a,i.path,a)),value:o._parse(new Le(i,i.data[a],i.path,a)),alwaysSet:a in i.data});return i.common.async?de.mergeObjectAsync(t,n):de.mergeObjectSync(t,n)}get element(){return this._def.valueType}static create(e,t,i){return t instanceof B?new zt({keyType:e,valueType:t,typeName:D.ZodRecord,...G(i)}):new zt({keyType:Ie.create(),valueType:e,typeName:D.ZodRecord,...G(t)})}}class Ar extends B{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:i}=this._processInputParams(e);if(i.parsedType!==O.map)return j(i,{code:I.invalid_type,expected:O.map,received:i.parsedType}),F;const n=this._def.keyType,s=this._def.valueType,o=[...i.data.entries()].map(([a,l],c)=>({key:n._parse(new Le(i,a,i.path,[c,"key"])),value:s._parse(new Le(i,l,i.path,[c,"value"]))}));if(i.common.async){const a=new Map;return Promise.resolve().then(async()=>{for(const l of o){const c=await l.key,h=await l.value;if(c.status==="aborted"||h.status==="aborted")return F;(c.status==="dirty"||h.status==="dirty")&&t.dirty(),a.set(c.value,h.value)}return{status:t.value,value:a}})}else{const a=new Map;for(const l of o){const c=l.key,h=l.value;if(c.status==="aborted"||h.status==="aborted")return F;(c.status==="dirty"||h.status==="dirty")&&t.dirty(),a.set(c.value,h.value)}return{status:t.value,value:a}}}}Ar.create=(r,e,t)=>new Ar({valueType:e,keyType:r,typeName:D.ZodMap,...G(t)});class lt extends B{_parse(e){const{status:t,ctx:i}=this._processInputParams(e);if(i.parsedType!==O.set)return j(i,{code:I.invalid_type,expected:O.set,received:i.parsedType}),F;const n=this._def;n.minSize!==null&&i.data.size<n.minSize.value&&(j(i,{code:I.too_small,minimum:n.minSize.value,type:"set",inclusive:!0,exact:!1,message:n.minSize.message}),t.dirty()),n.maxSize!==null&&i.data.size>n.maxSize.value&&(j(i,{code:I.too_big,maximum:n.maxSize.value,type:"set",inclusive:!0,exact:!1,message:n.maxSize.message}),t.dirty());const s=this._def.valueType;function o(l){const c=new Set;for(const h of l){if(h.status==="aborted")return F;h.status==="dirty"&&t.dirty(),c.add(h.value)}return{status:t.value,value:c}}const a=[...i.data.values()].map((l,c)=>s._parse(new Le(i,l,i.path,c)));return i.common.async?Promise.all(a).then(l=>o(l)):o(a)}min(e,t){return new lt({...this._def,minSize:{value:e,message:N.toString(t)}})}max(e,t){return new lt({...this._def,maxSize:{value:e,message:N.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}lt.create=(r,e)=>new lt({valueType:r,minSize:null,maxSize:null,typeName:D.ZodSet,...G(e)});class vt extends B{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==O.function)return j(t,{code:I.invalid_type,expected:O.function,received:t.parsedType}),F;function i(a,l){return Er({data:a,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Tr(),ft].filter(c=>!!c),issueData:{code:I.invalid_arguments,argumentsError:l}})}function n(a,l){return Er({data:a,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Tr(),ft].filter(c=>!!c),issueData:{code:I.invalid_return_type,returnTypeError:l}})}const s={errorMap:t.common.contextualErrorMap},o=t.data;if(this._def.returns instanceof yt){const a=this;return ge(async function(...l){const c=new _e([]),h=await a._def.args.parseAsync(l,s).catch(y=>{throw c.addIssue(i(l,y)),c}),u=await Reflect.apply(o,this,h);return await a._def.returns._def.type.parseAsync(u,s).catch(y=>{throw c.addIssue(n(u,y)),c})})}else{const a=this;return ge(function(...l){const c=a._def.args.safeParse(l,s);if(!c.success)throw new _e([i(l,c.error)]);const h=Reflect.apply(o,this,c.data),u=a._def.returns.safeParse(h,s);if(!u.success)throw new _e([n(h,u.error)]);return u.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new vt({...this._def,args:je.create(e).rest(at.create())})}returns(e){return new vt({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,i){return new vt({args:e||je.create([]).rest(at.create()),returns:t||at.create(),typeName:D.ZodFunction,...G(i)})}}class Vt extends B{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Vt.create=(r,e)=>new Vt({getter:r,typeName:D.ZodLazy,...G(e)});class $t extends B{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return j(t,{received:t.data,code:I.invalid_literal,expected:this._def.value}),F}return{status:"valid",value:e.data}}get value(){return this._def.value}}$t.create=(r,e)=>new $t({value:r,typeName:D.ZodLiteral,...G(e)});function Bn(r,e){return new tt({values:r,typeName:D.ZodEnum,...G(e)})}class tt extends B{constructor(){super(...arguments),Nt.set(this,void 0)}_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),i=this._def.values;return j(t,{expected:H.joinValues(i),received:t.parsedType,code:I.invalid_type}),F}if(Pr(this,Nt)||On(this,Nt,new Set(this._def.values)),!Pr(this,Nt).has(e.data)){const t=this._getOrReturnCtx(e),i=this._def.values;return j(t,{received:t.data,code:I.invalid_enum_value,options:i}),F}return ge(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return tt.create(e,{...this._def,...t})}exclude(e,t=this._def){return tt.create(this.options.filter(i=>!e.includes(i)),{...this._def,...t})}}Nt=new WeakMap,tt.create=Bn;class qt extends B{constructor(){super(...arguments),Dt.set(this,void 0)}_parse(e){const t=H.getValidEnumValues(this._def.values),i=this._getOrReturnCtx(e);if(i.parsedType!==O.string&&i.parsedType!==O.number){const n=H.objectValues(t);return j(i,{expected:H.joinValues(n),received:i.parsedType,code:I.invalid_type}),F}if(Pr(this,Dt)||On(this,Dt,new Set(H.getValidEnumValues(this._def.values))),!Pr(this,Dt).has(e.data)){const n=H.objectValues(t);return j(i,{received:i.data,code:I.invalid_enum_value,options:n}),F}return ge(e.data)}get enum(){return this._def.values}}Dt=new WeakMap,qt.create=(r,e)=>new qt({values:r,typeName:D.ZodNativeEnum,...G(e)});class yt extends B{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==O.promise&&t.common.async===!1)return j(t,{code:I.invalid_type,expected:O.promise,received:t.parsedType}),F;const i=t.parsedType===O.promise?t.data:Promise.resolve(t.data);return ge(i.then(n=>this._def.type.parseAsync(n,{path:t.path,errorMap:t.common.contextualErrorMap})))}}yt.create=(r,e)=>new yt({type:r,typeName:D.ZodPromise,...G(e)});class Ce extends B{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===D.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:i}=this._processInputParams(e),n=this._def.effect||null,s={addIssue:o=>{j(i,o),o.fatal?t.abort():t.dirty()},get path(){return i.path}};if(s.addIssue=s.addIssue.bind(s),n.type==="preprocess"){const o=n.transform(i.data,s);if(i.common.async)return Promise.resolve(o).then(async a=>{if(t.value==="aborted")return F;const l=await this._def.schema._parseAsync({data:a,path:i.path,parent:i});return l.status==="aborted"?F:l.status==="dirty"||t.value==="dirty"?pt(l.value):l});{if(t.value==="aborted")return F;const a=this._def.schema._parseSync({data:o,path:i.path,parent:i});return a.status==="aborted"?F:a.status==="dirty"||t.value==="dirty"?pt(a.value):a}}if(n.type==="refinement"){const o=a=>{const l=n.refinement(a,s);if(i.common.async)return Promise.resolve(l);if(l instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return a};if(i.common.async===!1){const a=this._def.schema._parseSync({data:i.data,path:i.path,parent:i});return a.status==="aborted"?F:(a.status==="dirty"&&t.dirty(),o(a.value),{status:t.value,value:a.value})}else return this._def.schema._parseAsync({data:i.data,path:i.path,parent:i}).then(a=>a.status==="aborted"?F:(a.status==="dirty"&&t.dirty(),o(a.value).then(()=>({status:t.value,value:a.value}))))}if(n.type==="transform")if(i.common.async===!1){const o=this._def.schema._parseSync({data:i.data,path:i.path,parent:i});if(!jt(o))return o;const a=n.transform(o.value,s);if(a instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:a}}else return this._def.schema._parseAsync({data:i.data,path:i.path,parent:i}).then(o=>jt(o)?Promise.resolve(n.transform(o.value,s)).then(a=>({status:t.value,value:a})):o);H.assertNever(n)}}Ce.create=(r,e,t)=>new Ce({schema:r,typeName:D.ZodEffects,effect:e,...G(t)}),Ce.createWithPreprocess=(r,e,t)=>new Ce({schema:e,effect:{type:"preprocess",transform:r},typeName:D.ZodEffects,...G(t)});class Oe extends B{_parse(e){return this._getType(e)===O.undefined?ge(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Oe.create=(r,e)=>new Oe({innerType:r,typeName:D.ZodOptional,...G(e)});class rt extends B{_parse(e){return this._getType(e)===O.null?ge(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}rt.create=(r,e)=>new rt({innerType:r,typeName:D.ZodNullable,...G(e)});class Zt extends B{_parse(e){const{ctx:t}=this._processInputParams(e);let i=t.data;return t.parsedType===O.undefined&&(i=this._def.defaultValue()),this._def.innerType._parse({data:i,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}Zt.create=(r,e)=>new Zt({innerType:r,typeName:D.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...G(e)});class Xt extends B{_parse(e){const{ctx:t}=this._processInputParams(e),i={...t,common:{...t.common,issues:[]}},n=this._def.innerType._parse({data:i.data,path:i.path,parent:{...i}});return Ot(n)?n.then(s=>({status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new _e(i.common.issues)},input:i.data})})):{status:"valid",value:n.status==="valid"?n.value:this._def.catchValue({get error(){return new _e(i.common.issues)},input:i.data})}}removeCatch(){return this._def.innerType}}Xt.create=(r,e)=>new Xt({innerType:r,typeName:D.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...G(e)});class Cr extends B{_parse(e){if(this._getType(e)!==O.nan){const i=this._getOrReturnCtx(e);return j(i,{code:I.invalid_type,expected:O.nan,received:i.parsedType}),F}return{status:"valid",value:e.data}}}Cr.create=r=>new Cr({typeName:D.ZodNaN,...G(r)});const Ha=Symbol("zod_brand");class Ei extends B{_parse(e){const{ctx:t}=this._processInputParams(e),i=t.data;return this._def.type._parse({data:i,path:t.path,parent:t})}unwrap(){return this._def.type}}class Ht extends B{_parse(e){const{status:t,ctx:i}=this._processInputParams(e);if(i.common.async)return(async()=>{const s=await this._def.in._parseAsync({data:i.data,path:i.path,parent:i});return s.status==="aborted"?F:s.status==="dirty"?(t.dirty(),pt(s.value)):this._def.out._parseAsync({data:s.value,path:i.path,parent:i})})();{const n=this._def.in._parseSync({data:i.data,path:i.path,parent:i});return n.status==="aborted"?F:n.status==="dirty"?(t.dirty(),{status:"dirty",value:n.value}):this._def.out._parseSync({data:n.value,path:i.path,parent:i})}}static create(e,t){return new Ht({in:e,out:t,typeName:D.ZodPipeline})}}class Yt extends B{_parse(e){const t=this._def.innerType._parse(e),i=n=>(jt(n)&&(n.value=Object.freeze(n.value)),n);return Ot(t)?t.then(n=>i(n)):i(t)}unwrap(){return this._def.innerType}}Yt.create=(r,e)=>new Yt({innerType:r,typeName:D.ZodReadonly,...G(e)});function Un(r,e={},t){return r?gt.create().superRefine((i,n)=>{var s,o;if(!r(i)){const a=typeof e=="function"?e(i):typeof e=="string"?{message:e}:e,l=(o=(s=a.fatal)!==null&&s!==void 0?s:t)!==null&&o!==void 0?o:!0,c=typeof a=="string"?{message:a}:a;n.addIssue({code:"custom",...c,fatal:l})}}):gt.create()}const Ya={object:te.lazycreate};var D;(function(r){r.ZodString="ZodString",r.ZodNumber="ZodNumber",r.ZodNaN="ZodNaN",r.ZodBigInt="ZodBigInt",r.ZodBoolean="ZodBoolean",r.ZodDate="ZodDate",r.ZodSymbol="ZodSymbol",r.ZodUndefined="ZodUndefined",r.ZodNull="ZodNull",r.ZodAny="ZodAny",r.ZodUnknown="ZodUnknown",r.ZodNever="ZodNever",r.ZodVoid="ZodVoid",r.ZodArray="ZodArray",r.ZodObject="ZodObject",r.ZodUnion="ZodUnion",r.ZodDiscriminatedUnion="ZodDiscriminatedUnion",r.ZodIntersection="ZodIntersection",r.ZodTuple="ZodTuple",r.ZodRecord="ZodRecord",r.ZodMap="ZodMap",r.ZodSet="ZodSet",r.ZodFunction="ZodFunction",r.ZodLazy="ZodLazy",r.ZodLiteral="ZodLiteral",r.ZodEnum="ZodEnum",r.ZodEffects="ZodEffects",r.ZodNativeEnum="ZodNativeEnum",r.ZodOptional="ZodOptional",r.ZodNullable="ZodNullable",r.ZodDefault="ZodDefault",r.ZodCatch="ZodCatch",r.ZodPromise="ZodPromise",r.ZodBranded="ZodBranded",r.ZodPipeline="ZodPipeline",r.ZodReadonly="ZodReadonly"})(D||(D={}));const Ja=(r,e={message:`Input not instance of ${r.name}`})=>Un(t=>t instanceof r,e),Wn=Ie.create,zn=Ke.create,Qa=Cr.create,Ka=et.create,Vn=Ft.create,el=ot.create,tl=Sr.create,rl=Gt.create,il=Bt.create,nl=gt.create,sl=at.create,ol=Ze.create,al=Rr.create,ll=Ae.create,cl=te.create,hl=te.strictCreate,ul=Ut.create,dl=Ir.create,fl=Wt.create,pl=je.create,gl=zt.create,ml=Ar.create,vl=lt.create,yl=vt.create,wl=Vt.create,xl=$t.create,_l=tt.create,bl=qt.create,Ml=yt.create,$n=Ce.create,Tl=Oe.create,El=rt.create,Pl=Ce.createWithPreprocess,Sl=Ht.create;var m=Object.freeze({__proto__:null,defaultErrorMap:ft,setErrorMap:ka,getErrorMap:Tr,makeIssue:Er,EMPTY_PATH:La,addIssueToContext:j,ParseStatus:de,INVALID:F,DIRTY:pt,OK:ge,isAborted:_i,isDirty:bi,isValid:jt,isAsync:Ot,get util(){return H},get objectUtil(){return xi},ZodParsedType:O,getParsedType:Qe,ZodType:B,datetimeRegex:Gn,ZodString:Ie,ZodNumber:Ke,ZodBigInt:et,ZodBoolean:Ft,ZodDate:ot,ZodSymbol:Sr,ZodUndefined:Gt,ZodNull:Bt,ZodAny:gt,ZodUnknown:at,ZodNever:Ze,ZodVoid:Rr,ZodArray:Ae,ZodObject:te,ZodUnion:Ut,ZodDiscriminatedUnion:Ir,ZodIntersection:Wt,ZodTuple:je,ZodRecord:zt,ZodMap:Ar,ZodSet:lt,ZodFunction:vt,ZodLazy:Vt,ZodLiteral:$t,ZodEnum:tt,ZodNativeEnum:qt,ZodPromise:yt,ZodEffects:Ce,ZodTransformer:Ce,ZodOptional:Oe,ZodNullable:rt,ZodDefault:Zt,ZodCatch:Xt,ZodNaN:Cr,BRAND:Ha,ZodBranded:Ei,ZodPipeline:Ht,ZodReadonly:Yt,custom:Un,Schema:B,ZodSchema:B,late:Ya,get ZodFirstPartyTypeKind(){return D},coerce:{string:r=>Ie.create({...r,coerce:!0}),number:r=>Ke.create({...r,coerce:!0}),boolean:r=>Ft.create({...r,coerce:!0}),bigint:r=>et.create({...r,coerce:!0}),date:r=>ot.create({...r,coerce:!0})},any:nl,array:ll,bigint:Ka,boolean:Vn,date:el,discriminatedUnion:dl,effect:$n,enum:_l,function:yl,instanceof:Ja,intersection:fl,lazy:wl,literal:xl,map:ml,nan:Qa,nativeEnum:bl,never:ol,null:il,nullable:El,number:zn,object:cl,oboolean:()=>Vn().optional(),onumber:()=>zn().optional(),optional:Tl,ostring:()=>Wn().optional(),pipeline:Sl,preprocess:Pl,promise:Ml,record:gl,set:vl,strictObject:hl,string:Wn,symbol:tl,transformer:$n,tuple:pl,undefined:rl,union:ul,unknown:sl,void:al,NEVER:F,ZodIssueCode:I,quotelessJson:Ca,ZodError:_e});const kr=/^https?:\/\/library.stanford.edu\/iiif\/image-api\/1.1\/compliance.html#level(?<level>[012])$/,qn=m.string().regex(kr),Rl=qn,Lr="https://web.archive.org/web/20240616124036/http://library.stanford.edu/iiif/image-api/1.1/context.json",Zn="https://web.archive.org/web/20240616124036/http://iiif.io/api/image/1/context.json",Xn=m.literal(Lr),Hn=m.object({"@context":Xn,"@id":m.string().url(),profile:qn.optional(),width:m.number().int(),height:m.number().int(),scale_factors:m.number().array().optional(),tile_width:m.number().optional(),tile_height:m.number().optional()}),Yn=m.object({width:m.number().int(),height:m.number().int()}),Jn=m.object({width:m.number().int(),height:m.number().int().optional(),scaleFactors:m.array(m.number().int())}),Il=["ImageService1","ImageService2","ImageService3"],Qn=m.enum(Il),jr=/^https?:\/\/iiif.io\/api\/image\/2.*level(?<level>[012])(.json)?$/,Kn=m.string().regex(jr),Al=m.object({formats:m.string().array().optional(),maxArea:m.number().int().optional(),maxHeight:m.number().int().optional(),maxWidth:m.number().int().optional(),qualities:m.string().array().optional(),supports:m.string().array().optional()}),Or=Kn.or(m.array(m.union([Kn,Al,m.any()]))),Nr="https://web.archive.org/web/20240616124036/http://iiif.io/api/image/2/context.json",es=m.literal(Nr).or(m.literal("https://web.archive.org/web/20240616124036/https://iiif.io/api/image/2/context.json")),Pi=m.object({"@id":m.string().url(),"@type":m.literal("iiif:Image").optional(),"@context":es,protocol:m.literal("https://web.archive.org/web/20240616124036/http://iiif.io/api/image"),width:m.number().int(),height:m.number().int(),profile:Or,sizes:Yn.array().optional(),tiles:Jn.array().optional()}),Cl=["level0","level1","level2"],ts=m.enum(Cl),Si=m.object({id:m.string().url(),type:m.literal("ImageService3"),protocol:m.literal("https://web.archive.org/web/20240616124036/http://iiif.io/api/image"),profile:ts,width:m.number().int(),height:m.number().int(),maxWidth:m.number().int().optional(),maxHeight:m.number().int().optional(),maxArea:m.number().int().optional(),sizes:Yn.array().optional(),tiles:Jn.array().optional(),extraFeatures:m.string().array().optional()}),kl=m.object({"@id":m.string().url(),"@type":Qn.optional(),profile:Rl.or(Or).or(ts),width:m.number().int().optional(),height:m.number().int().optional(),"@context":Xn.or(m.literal("https://web.archive.org/web/20240616124036/http://iiif.io/api/image/1/context.json")).or(es).optional()}),Ll=["level0","level1","level2"],jl=m.object({id:m.string().url(),type:m.literal("ImageService2"),profile:Or}).or(m.object({"@id":m.string().url(),"@type":m.literal("ImageService2"),profile:Or})),Ol=m.object({id:m.string().url(),type:Qn,profile:m.enum(Ll)}),Nl=m.union([jl,Ol]),rs=kl.or(Nl),is=m.string().or(m.number()).or(m.boolean()),ns=is.or(is.array()),ss=m.object({"@language":m.string().optional(),"@value":ns}),ct=ns.or(ss).or(ss.array()),os=m.union([m.any(),m.object({label:ct.optional(),value:ct.optional()})]).transform(r=>{if(r&&typeof r=="object"&&"label"in r&&"value"in r)return r}).array(),Dl=m.object({width:m.number().int().optional(),height:m.number().int().optional(),service:rs}),Fl=m.object({resource:Dl}),as=m.object({"@id":m.string().url(),"@type":m.literal("sc:Canvas"),width:m.number().int(),height:m.number().int(),images:Fl.array().length(1),label:ct.optional(),metadata:os.optional()}),Gl=m.object({canvases:as.array().nonempty()}),ls=m.object({"@id":m.string().url(),"@type":m.literal("sc:Manifest"),sequences:Gl.array().length(1),label:ct.optional(),description:ct.optional(),metadata:os.optional()}),cs=m.lazy(()=>m.object({"@id":m.string().url(),"@type":m.literal("sc:Manifest"),label:ct.optional()})),Ri=m.lazy(()=>m.object({"@id":m.string().url(),"@type":m.literal("sc:Collection"),label:ct.optional(),manifests:cs.array().optional(),collections:Ri.array().optional(),members:cs.or(Ri).array().optional()})),Bl=m.string().or(m.number()).or(m.boolean()),ht=m.record(m.string(),Bl.array()),hs=m.union([m.any(),m.object({label:ht.optional(),value:ht.optional()})]).transform(r=>{if(r&&typeof r=="object"&&"label"in r&&"value"in r)return r}).array(),us=m.object({type:m.literal("Image"),width:m.number().int().optional(),height:m.number().int().optional(),service:rs.array()}),Ul=m.object({type:m.literal("Annotation"),body:us.or(us.array().length(1))}),Wl=m.object({type:m.literal("AnnotationPage"),items:Ul.array().length(1)}),ds=m.object({id:m.string().url(),type:m.literal("Canvas"),width:m.number().int(),height:m.number().int(),items:Wl.array().length(1),label:ht.optional(),metadata:hs.optional()}),fs=m.object({id:m.string().url(),type:m.literal("Manifest"),items:ds.array().nonempty(),label:ht.optional(),description:ht.optional(),metadata:hs.optional()}),zl=m.lazy(()=>m.object({id:m.string().url(),type:m.literal("Manifest"),label:ht.optional()})),ps=m.lazy(()=>m.object({id:m.string().url(),type:m.literal("Collection"),label:ht.optional(),items:zl.or(ps).array()})),gs=Hn.or(Pi).or(Si);as.or(ds);const Vl=ls.or(fs);Ri.or(ps),ls.or(Pi),fs.or(Si),Vl.or(gs);function ms({width:r,height:e},t,i,n){const s=i*t.originalWidth,o=n*t.originalHeight,a=i*t.originalWidth+t.width*t.scaleFactor>r?r-i*t.originalWidth:t.width*t.scaleFactor,l=n*t.originalHeight+t.height*t.scaleFactor>e?e-n*t.originalHeight:t.height*t.scaleFactor;let c=t.width,h=t.height;return s+t.width*t.scaleFactor>r&&(c=Math.floor((r-s+t.scaleFactor-1)/t.scaleFactor)),o+t.height*t.scaleFactor>e&&(h=Math.floor((e-o+t.scaleFactor-1)/t.scaleFactor)),{region:{x:s,y:o,width:a,height:l},size:{width:c,height:h}}}function $l({width:r,height:e},t=768){const i=Math.max(r,e)/t,n=Math.ceil(Math.log(i)/Math.log(2));return{scaleFactors:Array.from({length:n},(s,o)=>2**o),width:t}}function ql({width:r,height:e},t,i){const n=t.height||t.width,s=t.width*i,o=n*i;return{scaleFactor:i,width:t.width,height:n,originalWidth:s,originalHeight:o,columns:Math.ceil(r/s),rows:Math.ceil(e/o)}}function Zl(r,e){return e.map(t=>t.scaleFactors.map(i=>ql(r,t,i))).flat()}function Xl(r){return!!r.some(e=>e.width&&e.scaleFactors&&e.scaleFactors.length)}function Hl(r,e,t){if(!e||!Xl(e))if(t)e=[$l(r)];else throw new Error("Image does not support tiles or custom regions and sizes.");return Zl(r,e)}function Yl(r,e,t="cover"){if(t==="cover"||t==="contain"){const i=e.width/r.width,n=e.height/r.height,s=t==="cover"?Math.max(i,n):Math.min(i,n),o=r.width*s,a=r.height*s;return{width:o,height:a}}else throw new Error('Mode must be either "cover" or "contain"')}const Jl=.8,Ql=1.5;function vs(r,e,t="cover",{sizes:i,tileZoomLevels:n,supportsAnyRegionAndSize:s,maxWidth:o,maxHeight:a,maxArea:l}){let{width:c,height:h}=Yl(r,e,t);if(o&&c>o&&(h=h/c*o,c=o),a&&h>a&&(c=c/h*a,h=a),l&&c*h>l){const g=h/c,v=Math.floor(Math.sqrt(l/g))*g;c=Math.floor(v)/g,h=c*g}const u=r.width/r.height;if(c=Math.floor(c),h=Math.round(c/u),i){let g;for(const y of i){const v=y.width/c;if(v>=Jl&&v<=Ql){g=y;break}}if(g)return{size:g}}if(s)return{size:{width:Math.round(c),height:Math.round(h)}};if(n){const g=r.width/c,y=n.map(({scaleFactor:S},d)=>({index:d,scaleFactor:S,diff:Math.abs(S-g)})).sort((S,d)=>S.diff-d.diff),v=n[y[0].index],E=Math.ceil(r.width/(v.scaleFactor*n[0].width)),P=Math.ceil(r.height/(v.scaleFactor*n[0].height)),w=[];for(let S=0;S<P;S++){const d=[];for(let p=0;p<E;p++){const _=ms(r,v,p,S);d.push(_)}w.push(d)}return w}throw new Error("Unable to create thumbnail")}const ys=["regionByPx","sizeByWh"];function Kl(r){const e=r.match(kr);if(e&&e.groups)return parseInt(e.groups.level)}function ws(r){const e=r.match(jr);if(e&&e.groups)return parseInt(e.groups.level)}function ec(r){return{maxWidth:r?.maxWidth,maxHeight:r?.maxHeight,maxArea:r?.maxArea,supportsAnyRegionAndSize:ys.every(e=>r?.supports&&r?.supports?.includes(e))}}function tc(r){if("type"in r&&r.type==="ImageService3")return 3;if("type"in r&&r.type==="ImageService2"||"@type"in r&&r["@type"]==="ImageService2"||"@context"in r&&r["@context"]===Nr)return 2;if("@context"in r&&(r["@context"]===Lr||r["@context"]===Zn))return 1;if("profile"in r){let e;return Array.isArray(r.profile)?e=r.profile[0]:e=r.profile,e.match(kr)?1:e.match(jr)?2:3}else throw new Error("Unsupported IIIF Image Service")}function Ii(r){if("type"in r||"@type"in r){const e=r.profile;let t=!1;return e==="level0"||typeof e=="string"&&e.endsWith("level0.json")?"extraFeatures"in r&&(t=ys.every(i=>r.extraFeatures&&r.extraFeatures.includes(i))):t=!0,{maxWidth:"maxWidth"in r?r.maxWidth:void 0,maxHeight:"maxHeight"in r?r.maxHeight:void 0,maxArea:"maxArea"in r?r.maxArea:void 0,supportsAnyRegionAndSize:t}}else if(Array.isArray(r.profile)){let e=!1,t=Number.NEGATIVE_INFINITY,i=Number.NEGATIVE_INFINITY,n=Number.NEGATIVE_INFINITY;return r.profile.forEach(s=>{if(typeof s=="string"){const o=ws(s);o&&(e=e||o>=1)}else{const{maxWidth:o,maxHeight:a,maxArea:l,supportsAnyRegionAndSize:c}=ec(s);o!==void 0&&(i=Math.max(o,i)),a!==void 0&&(t=Math.max(a,t)),l!==void 0&&(n=Math.max(l,n)),e=e||c}}),{maxWidth:i>=0?i:void 0,maxHeight:t>=0?t:void 0,maxArea:n>=0?n:void 0,supportsAnyRegionAndSize:e}}else if("profile"in r&&r.profile){const e=Kl(r.profile),t=ws(r.profile);return e?{supportsAnyRegionAndSize:e>=1}:t?{supportsAnyRegionAndSize:t>=1}:{supportsAnyRegionAndSize:!1}}else throw new Error("Invalid Image")}const rc="image";class ic{embedded=!0;uri;type=rc;maxWidth;maxHeight;maxArea;supportsAnyRegionAndSize;width;height;majorVersion;constructor(e,t){if(t){const i=e;let n,s;if(Array.isArray(i.service)?i.service.forEach(o=>{try{const a=tc(o);(!s||a>s)&&(s=a,n=o)}catch{}}):n=i.service,!n)throw new Error("Unsupported IIIF Image Service");if("@id"in n)this.uri=n["@id"];else if("id"in n)this.uri=n.id;else throw new Error("Unsupported IIIF Image Service");if("type"in n&&n.type==="ImageService3")this.majorVersion=3;else if("type"in n&&n.type==="ImageService2"||"@type"in n&&n["@type"]==="ImageService2"||"@context"in n&&n["@context"]===Nr)this.majorVersion=2;else if("@context"in n&&(n["@context"]===Lr||n["@context"]===Zn))this.majorVersion=1;else if("profile"in n){let o;Array.isArray(n.profile)?o=n.profile[0]:o=n.profile,o.match(kr)?this.majorVersion=1:o.match(jr)?this.majorVersion=2:this.majorVersion=3}else throw new Error("Unsupported IIIF Image Service");if("profile"in n){const o=Ii(n);this.supportsAnyRegionAndSize=o.supportsAnyRegionAndSize,this.maxWidth=o.maxWidth,this.maxHeight=o.maxHeight,this.maxArea=o.maxArea}else this.supportsAnyRegionAndSize=!1}else{if("@id"in e)this.uri=e["@id"];else if("id"in e)this.uri=e.id;else throw new Error("Unsupported IIIF Image");if("type"in e&&e.type==="ImageService3")this.majorVersion=3;else if("@type"in e&&e["@type"]==="iiif:Image"||"@context"in e&&e["@context"]===Nr)this.majorVersion=2;else if("@context"in e&&e["@context"]===Lr)this.majorVersion=1;else throw new Error("Unsupported IIIF Image");if("profile"in e){const i=Ii(e);this.supportsAnyRegionAndSize=i.supportsAnyRegionAndSize,this.maxWidth=i.maxWidth,this.maxHeight=i.maxHeight,this.maxArea=i.maxArea}else this.supportsAnyRegionAndSize=!1}if(e.width!==void 0)this.width=e.width;else if(t)this.width=t.width;else throw new Error("Width not present on either Canvas or Image Resource");if(e.height!==void 0)this.height=e.height;else if(t)this.height=t.height;else throw new Error("Height not present on either Canvas or Image Resource")}getImageUrl(e){const{region:t,size:i}=e;let n,s,o,a,l;t?(l=`${t.x},${t.y},${t.width},${t.height}`,o=t.height,a=t.width):(l="full",o=this.height,a=this.width);let c;if(i){n=Math.round(i.width),s=Math.round(i.height);const g=String(n);let y=String(s);const v=a/o,P=s*v/v;s===Math.round(P)&&(y=""),c=`${g},${y}`}else n=this.width,s=this.height,c=this.majorVersion===2?"full":"max";const h=n*s;if(this.maxWidth!==void 0&&n>this.maxWidth)throw new Error(`Width of requested image is too large: ${n} > ${this.maxWidth}`);if(this.maxHeight!==void 0&&s>this.maxHeight)throw new Error(`Height of requested image is too large: ${s} > ${this.maxHeight}`);if(this.maxArea!==void 0&&h>this.maxArea)throw new Error(`Area of requested image is too large: ${h} > ${this.maxArea}`);const u=this.majorVersion===1?"native":"default";return`${this.uri}/${l}/${c}/0/${u}.jpg`}getThumbnail(e,t="cover"){return vs({width:this.width,height:this.height},e,t,{supportsAnyRegionAndSize:this.supportsAnyRegionAndSize,maxWidth:this.maxWidth,maxHeight:this.maxHeight,maxArea:this.maxArea})}}class Ai extends ic{tileZoomLevels;sizes;embedded=!1;constructor(e){super(e);const t=Ii(e);let i;"tiles"in e&&(i=e.tiles),this.tileZoomLevels=Hl({width:this.width,height:this.height},i,t.supportsAnyRegionAndSize),"sizes"in e&&(this.sizes=e.sizes)}static parse(e,t=null){let i;return t===1?i=Hn.parse(e):t===2?i=Pi.parse(e):t===3?i=Si.parse(e):i=gs.parse(e),new Ai(i)}getIiifTile(e,t,i){return ms({width:this.width,height:this.height},e,t,i)}getThumbnail(e,t="cover"){return vs({width:this.width,height:this.height},e,t,{supportsAnyRegionAndSize:this.supportsAnyRegionAndSize,sizes:this.sizes,tileZoomLevels:this.tileZoomLevels,maxWidth:this.maxWidth,maxHeight:this.maxHeight,maxArea:this.maxArea})}}const xs=m.record(m.string(),m.string().array());m.object({label:xs.optional(),value:xs.optional()});var ye=63710088e-1,_s={centimeters:ye*100,centimetres:ye*100,degrees:ye/111325,feet:ye*3.28084,inches:ye*39.37,kilometers:ye/1e3,kilometres:ye/1e3,meters:ye,metres:ye,miles:ye/1609.344,millimeters:ye*1e3,millimetres:ye*1e3,nauticalmiles:ye/1852,radians:1,yards:ye*1.0936};function nc(r,e,t){t===void 0&&(t={});var i={type:"Feature"};return(t.id===0||t.id)&&(i.id=t.id),t.bbox&&(i.bbox=t.bbox),i.properties=e||{},i.geometry=r,i}function sc(r,e,t){if(t===void 0&&(t={}),!r)throw new Error("coordinates is required");if(!Array.isArray(r))throw new Error("coordinates must be an Array");if(r.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!bs(r[0])||!bs(r[1]))throw new Error("coordinates must contain numbers");var i={type:"Point",coordinates:r};return nc(i,e,t)}function oc(r,e){e===void 0&&(e="kilometers");var t=_s[e];if(!t)throw new Error(e+" units is invalid");return r*t}function ac(r,e){e===void 0&&(e="kilometers");var t=_s[e];if(!t)throw new Error(e+" units is invalid");return r/t}function Ci(r){var e=r%(2*Math.PI);return e*180/Math.PI}function ke(r){var e=r%360;return e*Math.PI/180}function bs(r){return!isNaN(r)&&r!==null&&!Array.isArray(r)}function wt(r){if(!r)throw new Error("coord is required");if(!Array.isArray(r)){if(r.type==="Feature"&&r.geometry!==null&&r.geometry.type==="Point")return r.geometry.coordinates;if(r.type==="Point")return r.coordinates}if(Array.isArray(r)&&r.length>=2&&!Array.isArray(r[0])&&!Array.isArray(r[1]))return r;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function lc(r){return r.type==="Feature"?r.geometry:r}function Ms(r,e,t){if(t===void 0&&(t={}),t.final===!0)return cc(r,e);var i=wt(r),n=wt(e),s=ke(i[0]),o=ke(n[0]),a=ke(i[1]),l=ke(n[1]),c=Math.sin(o-s)*Math.cos(l),h=Math.cos(a)*Math.sin(l)-Math.sin(a)*Math.cos(l)*Math.cos(o-s);return Ci(Math.atan2(c,h))}function cc(r,e){var t=Ms(e,r);return t=(t+180)%360,t}function hc(r,e,t,i){i===void 0&&(i={});var n=wt(r),s=ke(n[0]),o=ke(n[1]),a=ke(t),l=ac(e,i.units),c=Math.asin(Math.sin(o)*Math.cos(l)+Math.cos(o)*Math.sin(l)*Math.cos(a)),h=s+Math.atan2(Math.sin(a)*Math.sin(l)*Math.cos(o),Math.cos(l)-Math.sin(o)*Math.sin(c)),u=Ci(h),g=Ci(c);return sc([u,g],i.properties)}function ki(r,e,t){t===void 0&&(t={});var i=wt(r),n=wt(e),s=ke(n[1]-i[1]),o=ke(n[0]-i[0]),a=ke(i[1]),l=ke(n[1]),c=Math.pow(Math.sin(s/2),2)+Math.pow(Math.sin(o/2),2)*Math.cos(a)*Math.cos(l);return oc(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)),t.units)}function Dr(r,e){var t=ki(r,e),i=Ms(r,e),n=hc(r,t/2,i);return n}function Ts(r){if(r.__esModule)return r;var e=r.default;if(typeof e=="function"){var t=function i(){return this instanceof i?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(r).forEach(function(i){var n=Object.getOwnPropertyDescriptor(r,i);Object.defineProperty(t,i,n.get?n:{enumerable:!0,get:function(){return r[i]}})}),t}var q={};const uc=Object.prototype.toString;function Jt(r){const e=uc.call(r);return e.endsWith("Array]")&&!e.includes("Big")}const dc=Object.freeze(Object.defineProperty({__proto__:null,isAnyArray:Jt},Symbol.toStringTag,{value:"Module"})),fc=Ts(dc);function pc(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Jt(r))throw new TypeError("input must be an array");if(r.length===0)throw new TypeError("input must not be empty");var t=e.fromIndex,i=t===void 0?0:t,n=e.toIndex,s=n===void 0?r.length:n;if(i<0||i>=r.length||!Number.isInteger(i))throw new Error("fromIndex must be a positive integer smaller than length");if(s<=i||s>r.length||!Number.isInteger(s))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var o=r[i],a=i+1;a<s;a++)r[a]>o&&(o=r[a]);return o}function gc(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Jt(r))throw new TypeError("input must be an array");if(r.length===0)throw new TypeError("input must not be empty");var t=e.fromIndex,i=t===void 0?0:t,n=e.toIndex,s=n===void 0?r.length:n;if(i<0||i>=r.length||!Number.isInteger(i))throw new Error("fromIndex must be a positive integer smaller than length");if(s<=i||s>r.length||!Number.isInteger(s))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var o=r[i],a=i+1;a<s;a++)r[a]<o&&(o=r[a]);return o}function mc(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(Jt(r)){if(r.length===0)throw new TypeError("input must not be empty")}else throw new TypeError("input must be an array");var t;if(e.output!==void 0){if(!Jt(e.output))throw new TypeError("output option must be an array if specified");t=e.output}else t=new Array(r.length);var i=gc(r),n=pc(r);if(i===n)throw new RangeError("minimum and maximum input values are equal. Cannot rescale a constant array");var s=e.min,o=s===void 0?e.autoMinMax?i:0:s,a=e.max,l=a===void 0?e.autoMinMax?n:1:a;if(o>=l)throw new RangeError("min option must be smaller than max option");for(var c=(l-o)/(n-i),h=0;h<r.length;h++)t[h]=(r[h]-i)*c+o;return t}const vc=Object.freeze(Object.defineProperty({__proto__:null,default:mc},Symbol.toStringTag,{value:"Module"})),yc=Ts(vc);Object.defineProperty(q,"__esModule",{value:!0});var we=fc,Es=yc;const Fr=" ".repeat(2),Ps=" ".repeat(4);function wc(){return Ss(this)}function Ss(r,e={}){const{maxRows:t=15,maxColumns:i=10,maxNumSize:n=8,padMinus:s="auto"}=e;return`${r.constructor.name} {
${Fr}[
${Ps}${xc(r,t,i,n,s)}
${Fr}]
${Fr}rows: ${r.rows}
${Fr}columns: ${r.columns}
}`}function xc(r,e,t,i,n){const{rows:s,columns:o}=r,a=Math.min(s,e),l=Math.min(o,t),c=[];if(n==="auto"){n=!1;e:for(let h=0;h<a;h++)for(let u=0;u<l;u++)if(r.get(h,u)<0){n=!0;break e}}for(let h=0;h<a;h++){let u=[];for(let g=0;g<l;g++)u.push(_c(r.get(h,g),i,n));c.push(`${u.join(" ")}`)}return l!==o&&(c[c.length-1]+=` ... ${o-t} more columns`),a!==s&&c.push(`... ${s-e} more rows`),c.join(`
${Ps}`)}function _c(r,e,t){return(r>=0&&t?` ${Rs(r,e-1)}`:Rs(r,e)).padEnd(e)}function Rs(r,e){let t=r.toString();if(t.length<=e)return t;let i=r.toFixed(e);if(i.length>e&&(i=r.toFixed(Math.max(0,e-(i.length-e)))),i.length<=e&&!i.startsWith("0.000")&&!i.startsWith("-0.000"))return i;let n=r.toExponential(e);return n.length>e&&(n=r.toExponential(Math.max(0,e-(n.length-e)))),n.slice(0)}function bc(r,e){r.prototype.add=function(t){return typeof t=="number"?this.addS(t):this.addM(t)},r.prototype.addS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)+t);return this},r.prototype.addM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)+t.get(i,n));return this},r.add=function(t,i){return new e(t).add(i)},r.prototype.sub=function(t){return typeof t=="number"?this.subS(t):this.subM(t)},r.prototype.subS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)-t);return this},r.prototype.subM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)-t.get(i,n));return this},r.sub=function(t,i){return new e(t).sub(i)},r.prototype.subtract=r.prototype.sub,r.prototype.subtractS=r.prototype.subS,r.prototype.subtractM=r.prototype.subM,r.subtract=r.sub,r.prototype.mul=function(t){return typeof t=="number"?this.mulS(t):this.mulM(t)},r.prototype.mulS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)*t);return this},r.prototype.mulM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)*t.get(i,n));return this},r.mul=function(t,i){return new e(t).mul(i)},r.prototype.multiply=r.prototype.mul,r.prototype.multiplyS=r.prototype.mulS,r.prototype.multiplyM=r.prototype.mulM,r.multiply=r.mul,r.prototype.div=function(t){return typeof t=="number"?this.divS(t):this.divM(t)},r.prototype.divS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)/t);return this},r.prototype.divM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)/t.get(i,n));return this},r.div=function(t,i){return new e(t).div(i)},r.prototype.divide=r.prototype.div,r.prototype.divideS=r.prototype.divS,r.prototype.divideM=r.prototype.divM,r.divide=r.div,r.prototype.mod=function(t){return typeof t=="number"?this.modS(t):this.modM(t)},r.prototype.modS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)%t);return this},r.prototype.modM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)%t.get(i,n));return this},r.mod=function(t,i){return new e(t).mod(i)},r.prototype.modulus=r.prototype.mod,r.prototype.modulusS=r.prototype.modS,r.prototype.modulusM=r.prototype.modM,r.modulus=r.mod,r.prototype.and=function(t){return typeof t=="number"?this.andS(t):this.andM(t)},r.prototype.andS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)&t);return this},r.prototype.andM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)&t.get(i,n));return this},r.and=function(t,i){return new e(t).and(i)},r.prototype.or=function(t){return typeof t=="number"?this.orS(t):this.orM(t)},r.prototype.orS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)|t);return this},r.prototype.orM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)|t.get(i,n));return this},r.or=function(t,i){return new e(t).or(i)},r.prototype.xor=function(t){return typeof t=="number"?this.xorS(t):this.xorM(t)},r.prototype.xorS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)^t);return this},r.prototype.xorM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)^t.get(i,n));return this},r.xor=function(t,i){return new e(t).xor(i)},r.prototype.leftShift=function(t){return typeof t=="number"?this.leftShiftS(t):this.leftShiftM(t)},r.prototype.leftShiftS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)<<t);return this},r.prototype.leftShiftM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)<<t.get(i,n));return this},r.leftShift=function(t,i){return new e(t).leftShift(i)},r.prototype.signPropagatingRightShift=function(t){return typeof t=="number"?this.signPropagatingRightShiftS(t):this.signPropagatingRightShiftM(t)},r.prototype.signPropagatingRightShiftS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)>>t);return this},r.prototype.signPropagatingRightShiftM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)>>t.get(i,n));return this},r.signPropagatingRightShift=function(t,i){return new e(t).signPropagatingRightShift(i)},r.prototype.rightShift=function(t){return typeof t=="number"?this.rightShiftS(t):this.rightShiftM(t)},r.prototype.rightShiftS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)>>>t);return this},r.prototype.rightShiftM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,this.get(i,n)>>>t.get(i,n));return this},r.rightShift=function(t,i){return new e(t).rightShift(i)},r.prototype.zeroFillRightShift=r.prototype.rightShift,r.prototype.zeroFillRightShiftS=r.prototype.rightShiftS,r.prototype.zeroFillRightShiftM=r.prototype.rightShiftM,r.zeroFillRightShift=r.rightShift,r.prototype.not=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,~this.get(t,i));return this},r.not=function(t){return new e(t).not()},r.prototype.abs=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.abs(this.get(t,i)));return this},r.abs=function(t){return new e(t).abs()},r.prototype.acos=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.acos(this.get(t,i)));return this},r.acos=function(t){return new e(t).acos()},r.prototype.acosh=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.acosh(this.get(t,i)));return this},r.acosh=function(t){return new e(t).acosh()},r.prototype.asin=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.asin(this.get(t,i)));return this},r.asin=function(t){return new e(t).asin()},r.prototype.asinh=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.asinh(this.get(t,i)));return this},r.asinh=function(t){return new e(t).asinh()},r.prototype.atan=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.atan(this.get(t,i)));return this},r.atan=function(t){return new e(t).atan()},r.prototype.atanh=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.atanh(this.get(t,i)));return this},r.atanh=function(t){return new e(t).atanh()},r.prototype.cbrt=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.cbrt(this.get(t,i)));return this},r.cbrt=function(t){return new e(t).cbrt()},r.prototype.ceil=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.ceil(this.get(t,i)));return this},r.ceil=function(t){return new e(t).ceil()},r.prototype.clz32=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.clz32(this.get(t,i)));return this},r.clz32=function(t){return new e(t).clz32()},r.prototype.cos=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.cos(this.get(t,i)));return this},r.cos=function(t){return new e(t).cos()},r.prototype.cosh=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.cosh(this.get(t,i)));return this},r.cosh=function(t){return new e(t).cosh()},r.prototype.exp=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.exp(this.get(t,i)));return this},r.exp=function(t){return new e(t).exp()},r.prototype.expm1=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.expm1(this.get(t,i)));return this},r.expm1=function(t){return new e(t).expm1()},r.prototype.floor=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.floor(this.get(t,i)));return this},r.floor=function(t){return new e(t).floor()},r.prototype.fround=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.fround(this.get(t,i)));return this},r.fround=function(t){return new e(t).fround()},r.prototype.log=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.log(this.get(t,i)));return this},r.log=function(t){return new e(t).log()},r.prototype.log1p=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.log1p(this.get(t,i)));return this},r.log1p=function(t){return new e(t).log1p()},r.prototype.log10=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.log10(this.get(t,i)));return this},r.log10=function(t){return new e(t).log10()},r.prototype.log2=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.log2(this.get(t,i)));return this},r.log2=function(t){return new e(t).log2()},r.prototype.round=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.round(this.get(t,i)));return this},r.round=function(t){return new e(t).round()},r.prototype.sign=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.sign(this.get(t,i)));return this},r.sign=function(t){return new e(t).sign()},r.prototype.sin=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.sin(this.get(t,i)));return this},r.sin=function(t){return new e(t).sin()},r.prototype.sinh=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.sinh(this.get(t,i)));return this},r.sinh=function(t){return new e(t).sinh()},r.prototype.sqrt=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.sqrt(this.get(t,i)));return this},r.sqrt=function(t){return new e(t).sqrt()},r.prototype.tan=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.tan(this.get(t,i)));return this},r.tan=function(t){return new e(t).tan()},r.prototype.tanh=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.tanh(this.get(t,i)));return this},r.tanh=function(t){return new e(t).tanh()},r.prototype.trunc=function(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,Math.trunc(this.get(t,i)));return this},r.trunc=function(t){return new e(t).trunc()},r.pow=function(t,i){return new e(t).pow(i)},r.prototype.pow=function(t){return typeof t=="number"?this.powS(t):this.powM(t)},r.prototype.powS=function(t){for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,Math.pow(this.get(i,n),t));return this},r.prototype.powM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.set(i,n,Math.pow(this.get(i,n),t.get(i,n)));return this}}function Me(r,e,t){let i=t?r.rows:r.rows-1;if(e<0||e>i)throw new RangeError("Row index out of range")}function Te(r,e,t){let i=t?r.columns:r.columns-1;if(e<0||e>i)throw new RangeError("Column index out of range")}function xt(r,e){if(e.to1DArray&&(e=e.to1DArray()),e.length!==r.columns)throw new RangeError("vector size must be the same as the number of columns");return e}function _t(r,e){if(e.to1DArray&&(e=e.to1DArray()),e.length!==r.rows)throw new RangeError("vector size must be the same as the number of rows");return e}function Li(r,e){if(!we.isAnyArray(e))throw new TypeError("row indices must be an array");for(let t=0;t<e.length;t++)if(e[t]<0||e[t]>=r.rows)throw new RangeError("row indices are out of range")}function ji(r,e){if(!we.isAnyArray(e))throw new TypeError("column indices must be an array");for(let t=0;t<e.length;t++)if(e[t]<0||e[t]>=r.columns)throw new RangeError("column indices are out of range")}function Oi(r,e,t,i,n){if(arguments.length!==5)throw new RangeError("expected 4 arguments");if(Br("startRow",e),Br("endRow",t),Br("startColumn",i),Br("endColumn",n),e>t||i>n||e<0||e>=r.rows||t<0||t>=r.rows||i<0||i>=r.columns||n<0||n>=r.columns)throw new RangeError("Submatrix indices are out of range")}function Gr(r,e=0){let t=[];for(let i=0;i<r;i++)t.push(e);return t}function Br(r,e){if(typeof e!="number")throw new TypeError(`${r} must be a number`)}function bt(r){if(r.isEmpty())throw new Error("Empty matrix has no elements to index")}function Mc(r){let e=Gr(r.rows);for(let t=0;t<r.rows;++t)for(let i=0;i<r.columns;++i)e[t]+=r.get(t,i);return e}function Tc(r){let e=Gr(r.columns);for(let t=0;t<r.rows;++t)for(let i=0;i<r.columns;++i)e[i]+=r.get(t,i);return e}function Ec(r){let e=0;for(let t=0;t<r.rows;t++)for(let i=0;i<r.columns;i++)e+=r.get(t,i);return e}function Pc(r){let e=Gr(r.rows,1);for(let t=0;t<r.rows;++t)for(let i=0;i<r.columns;++i)e[t]*=r.get(t,i);return e}function Sc(r){let e=Gr(r.columns,1);for(let t=0;t<r.rows;++t)for(let i=0;i<r.columns;++i)e[i]*=r.get(t,i);return e}function Rc(r){let e=1;for(let t=0;t<r.rows;t++)for(let i=0;i<r.columns;i++)e*=r.get(t,i);return e}function Ic(r,e,t){const i=r.rows,n=r.columns,s=[];for(let o=0;o<i;o++){let a=0,l=0,c=0;for(let h=0;h<n;h++)c=r.get(o,h)-t[o],a+=c,l+=c*c;e?s.push((l-a*a/n)/(n-1)):s.push((l-a*a/n)/n)}return s}function Ac(r,e,t){const i=r.rows,n=r.columns,s=[];for(let o=0;o<n;o++){let a=0,l=0,c=0;for(let h=0;h<i;h++)c=r.get(h,o)-t[o],a+=c,l+=c*c;e?s.push((l-a*a/i)/(i-1)):s.push((l-a*a/i)/i)}return s}function Cc(r,e,t){const i=r.rows,n=r.columns,s=i*n;let o=0,a=0,l=0;for(let c=0;c<i;c++)for(let h=0;h<n;h++)l=r.get(c,h)-t,o+=l,a+=l*l;return e?(a-o*o/s)/(s-1):(a-o*o/s)/s}function kc(r,e){for(let t=0;t<r.rows;t++)for(let i=0;i<r.columns;i++)r.set(t,i,r.get(t,i)-e[t])}function Lc(r,e){for(let t=0;t<r.rows;t++)for(let i=0;i<r.columns;i++)r.set(t,i,r.get(t,i)-e[i])}function jc(r,e){for(let t=0;t<r.rows;t++)for(let i=0;i<r.columns;i++)r.set(t,i,r.get(t,i)-e)}function Oc(r){const e=[];for(let t=0;t<r.rows;t++){let i=0;for(let n=0;n<r.columns;n++)i+=Math.pow(r.get(t,n),2)/(r.columns-1);e.push(Math.sqrt(i))}return e}function Nc(r,e){for(let t=0;t<r.rows;t++)for(let i=0;i<r.columns;i++)r.set(t,i,r.get(t,i)/e[t])}function Dc(r){const e=[];for(let t=0;t<r.columns;t++){let i=0;for(let n=0;n<r.rows;n++)i+=Math.pow(r.get(n,t),2)/(r.rows-1);e.push(Math.sqrt(i))}return e}function Fc(r,e){for(let t=0;t<r.rows;t++)for(let i=0;i<r.columns;i++)r.set(t,i,r.get(t,i)/e[i])}function Gc(r){const e=r.size-1;let t=0;for(let i=0;i<r.columns;i++)for(let n=0;n<r.rows;n++)t+=Math.pow(r.get(n,i),2)/e;return Math.sqrt(t)}function Bc(r,e){for(let t=0;t<r.rows;t++)for(let i=0;i<r.columns;i++)r.set(t,i,r.get(t,i)/e)}let re=class ce{static from1DArray(e,t,i){if(e*t!==i.length)throw new RangeError("data length does not match given dimensions");let n=new C(e,t);for(let s=0;s<e;s++)for(let o=0;o<t;o++)n.set(s,o,i[s*t+o]);return n}static rowVector(e){let t=new C(1,e.length);for(let i=0;i<e.length;i++)t.set(0,i,e[i]);return t}static columnVector(e){let t=new C(e.length,1);for(let i=0;i<e.length;i++)t.set(i,0,e[i]);return t}static zeros(e,t){return new C(e,t)}static ones(e,t){return new C(e,t).fill(1)}static rand(e,t,i={}){if(typeof i!="object")throw new TypeError("options must be an object");const{random:n=Math.random}=i;let s=new C(e,t);for(let o=0;o<e;o++)for(let a=0;a<t;a++)s.set(o,a,n());return s}static randInt(e,t,i={}){if(typeof i!="object")throw new TypeError("options must be an object");const{min:n=0,max:s=1e3,random:o=Math.random}=i;if(!Number.isInteger(n))throw new TypeError("min must be an integer");if(!Number.isInteger(s))throw new TypeError("max must be an integer");if(n>=s)throw new RangeError("min must be smaller than max");let a=s-n,l=new C(e,t);for(let c=0;c<e;c++)for(let h=0;h<t;h++){let u=n+Math.round(o()*a);l.set(c,h,u)}return l}static eye(e,t,i){t===void 0&&(t=e),i===void 0&&(i=1);let n=Math.min(e,t),s=this.zeros(e,t);for(let o=0;o<n;o++)s.set(o,o,i);return s}static diag(e,t,i){let n=e.length;t===void 0&&(t=n),i===void 0&&(i=t);let s=Math.min(n,t,i),o=this.zeros(t,i);for(let a=0;a<s;a++)o.set(a,a,e[a]);return o}static min(e,t){e=this.checkMatrix(e),t=this.checkMatrix(t);let i=e.rows,n=e.columns,s=new C(i,n);for(let o=0;o<i;o++)for(let a=0;a<n;a++)s.set(o,a,Math.min(e.get(o,a),t.get(o,a)));return s}static max(e,t){e=this.checkMatrix(e),t=this.checkMatrix(t);let i=e.rows,n=e.columns,s=new this(i,n);for(let o=0;o<i;o++)for(let a=0;a<n;a++)s.set(o,a,Math.max(e.get(o,a),t.get(o,a)));return s}static checkMatrix(e){return ce.isMatrix(e)?e:new C(e)}static isMatrix(e){return e!=null&&e.klass==="Matrix"}get size(){return this.rows*this.columns}apply(e){if(typeof e!="function")throw new TypeError("callback must be a function");for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)e.call(this,t,i);return this}to1DArray(){let e=[];for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)e.push(this.get(t,i));return e}to2DArray(){let e=[];for(let t=0;t<this.rows;t++){e.push([]);for(let i=0;i<this.columns;i++)e[t].push(this.get(t,i))}return e}toJSON(){return this.to2DArray()}isRowVector(){return this.rows===1}isColumnVector(){return this.columns===1}isVector(){return this.rows===1||this.columns===1}isSquare(){return this.rows===this.columns}isEmpty(){return this.rows===0||this.columns===0}isSymmetric(){if(this.isSquare()){for(let e=0;e<this.rows;e++)for(let t=0;t<=e;t++)if(this.get(e,t)!==this.get(t,e))return!1;return!0}return!1}isDistance(){if(!this.isSymmetric())return!1;for(let e=0;e<this.rows;e++)if(this.get(e,e)!==0)return!1;return!0}isEchelonForm(){let e=0,t=0,i=-1,n=!0,s=!1;for(;e<this.rows&&n;){for(t=0,s=!1;t<this.columns&&s===!1;)this.get(e,t)===0?t++:this.get(e,t)===1&&t>i?(s=!0,i=t):(n=!1,s=!0);e++}return n}isReducedEchelonForm(){let e=0,t=0,i=-1,n=!0,s=!1;for(;e<this.rows&&n;){for(t=0,s=!1;t<this.columns&&s===!1;)this.get(e,t)===0?t++:this.get(e,t)===1&&t>i?(s=!0,i=t):(n=!1,s=!0);for(let o=t+1;o<this.rows;o++)this.get(e,o)!==0&&(n=!1);e++}return n}echelonForm(){let e=this.clone(),t=0,i=0;for(;t<e.rows&&i<e.columns;){let n=t;for(let s=t;s<e.rows;s++)e.get(s,i)>e.get(n,i)&&(n=s);if(e.get(n,i)===0)i++;else{e.swapRows(t,n);let s=e.get(t,i);for(let o=i;o<e.columns;o++)e.set(t,o,e.get(t,o)/s);for(let o=t+1;o<e.rows;o++){let a=e.get(o,i)/e.get(t,i);e.set(o,i,0);for(let l=i+1;l<e.columns;l++)e.set(o,l,e.get(o,l)-e.get(t,l)*a)}t++,i++}}return e}reducedEchelonForm(){let e=this.echelonForm(),t=e.columns,i=e.rows,n=i-1;for(;n>=0;)if(e.maxRow(n)===0)n--;else{let s=0,o=!1;for(;s<i&&o===!1;)e.get(n,s)===1?o=!0:s++;for(let a=0;a<n;a++){let l=e.get(a,s);for(let c=s;c<t;c++){let h=e.get(a,c)-l*e.get(n,c);e.set(a,c,h)}}n--}return e}set(){throw new Error("set method is unimplemented")}get(){throw new Error("get method is unimplemented")}repeat(e={}){if(typeof e!="object")throw new TypeError("options must be an object");const{rows:t=1,columns:i=1}=e;if(!Number.isInteger(t)||t<=0)throw new TypeError("rows must be a positive integer");if(!Number.isInteger(i)||i<=0)throw new TypeError("columns must be a positive integer");let n=new C(this.rows*t,this.columns*i);for(let s=0;s<t;s++)for(let o=0;o<i;o++)n.setSubMatrix(this,this.rows*s,this.columns*o);return n}fill(e){for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,e);return this}neg(){return this.mulS(-1)}getRow(e){Me(this,e);let t=[];for(let i=0;i<this.columns;i++)t.push(this.get(e,i));return t}getRowVector(e){return C.rowVector(this.getRow(e))}setRow(e,t){Me(this,e),t=xt(this,t);for(let i=0;i<this.columns;i++)this.set(e,i,t[i]);return this}swapRows(e,t){Me(this,e),Me(this,t);for(let i=0;i<this.columns;i++){let n=this.get(e,i);this.set(e,i,this.get(t,i)),this.set(t,i,n)}return this}getColumn(e){Te(this,e);let t=[];for(let i=0;i<this.rows;i++)t.push(this.get(i,e));return t}getColumnVector(e){return C.columnVector(this.getColumn(e))}setColumn(e,t){Te(this,e),t=_t(this,t);for(let i=0;i<this.rows;i++)this.set(i,e,t[i]);return this}swapColumns(e,t){Te(this,e),Te(this,t);for(let i=0;i<this.rows;i++){let n=this.get(i,e);this.set(i,e,this.get(i,t)),this.set(i,t,n)}return this}addRowVector(e){e=xt(this,e);for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,this.get(t,i)+e[i]);return this}subRowVector(e){e=xt(this,e);for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,this.get(t,i)-e[i]);return this}mulRowVector(e){e=xt(this,e);for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,this.get(t,i)*e[i]);return this}divRowVector(e){e=xt(this,e);for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,this.get(t,i)/e[i]);return this}addColumnVector(e){e=_t(this,e);for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,this.get(t,i)+e[t]);return this}subColumnVector(e){e=_t(this,e);for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,this.get(t,i)-e[t]);return this}mulColumnVector(e){e=_t(this,e);for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,this.get(t,i)*e[t]);return this}divColumnVector(e){e=_t(this,e);for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)this.set(t,i,this.get(t,i)/e[t]);return this}mulRow(e,t){Me(this,e);for(let i=0;i<this.columns;i++)this.set(e,i,this.get(e,i)*t);return this}mulColumn(e,t){Te(this,e);for(let i=0;i<this.rows;i++)this.set(i,e,this.get(i,e)*t);return this}max(e){if(this.isEmpty())return NaN;switch(e){case"row":{const t=new Array(this.rows).fill(Number.NEGATIVE_INFINITY);for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.get(i,n)>t[i]&&(t[i]=this.get(i,n));return t}case"column":{const t=new Array(this.columns).fill(Number.NEGATIVE_INFINITY);for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.get(i,n)>t[n]&&(t[n]=this.get(i,n));return t}case void 0:{let t=this.get(0,0);for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.get(i,n)>t&&(t=this.get(i,n));return t}default:throw new Error(`invalid option: ${e}`)}}maxIndex(){bt(this);let e=this.get(0,0),t=[0,0];for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.get(i,n)>e&&(e=this.get(i,n),t[0]=i,t[1]=n);return t}min(e){if(this.isEmpty())return NaN;switch(e){case"row":{const t=new Array(this.rows).fill(Number.POSITIVE_INFINITY);for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.get(i,n)<t[i]&&(t[i]=this.get(i,n));return t}case"column":{const t=new Array(this.columns).fill(Number.POSITIVE_INFINITY);for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.get(i,n)<t[n]&&(t[n]=this.get(i,n));return t}case void 0:{let t=this.get(0,0);for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.get(i,n)<t&&(t=this.get(i,n));return t}default:throw new Error(`invalid option: ${e}`)}}minIndex(){bt(this);let e=this.get(0,0),t=[0,0];for(let i=0;i<this.rows;i++)for(let n=0;n<this.columns;n++)this.get(i,n)<e&&(e=this.get(i,n),t[0]=i,t[1]=n);return t}maxRow(e){if(Me(this,e),this.isEmpty())return NaN;let t=this.get(e,0);for(let i=1;i<this.columns;i++)this.get(e,i)>t&&(t=this.get(e,i));return t}maxRowIndex(e){Me(this,e),bt(this);let t=this.get(e,0),i=[e,0];for(let n=1;n<this.columns;n++)this.get(e,n)>t&&(t=this.get(e,n),i[1]=n);return i}minRow(e){if(Me(this,e),this.isEmpty())return NaN;let t=this.get(e,0);for(let i=1;i<this.columns;i++)this.get(e,i)<t&&(t=this.get(e,i));return t}minRowIndex(e){Me(this,e),bt(this);let t=this.get(e,0),i=[e,0];for(let n=1;n<this.columns;n++)this.get(e,n)<t&&(t=this.get(e,n),i[1]=n);return i}maxColumn(e){if(Te(this,e),this.isEmpty())return NaN;let t=this.get(0,e);for(let i=1;i<this.rows;i++)this.get(i,e)>t&&(t=this.get(i,e));return t}maxColumnIndex(e){Te(this,e),bt(this);let t=this.get(0,e),i=[0,e];for(let n=1;n<this.rows;n++)this.get(n,e)>t&&(t=this.get(n,e),i[0]=n);return i}minColumn(e){if(Te(this,e),this.isEmpty())return NaN;let t=this.get(0,e);for(let i=1;i<this.rows;i++)this.get(i,e)<t&&(t=this.get(i,e));return t}minColumnIndex(e){Te(this,e),bt(this);let t=this.get(0,e),i=[0,e];for(let n=1;n<this.rows;n++)this.get(n,e)<t&&(t=this.get(n,e),i[0]=n);return i}diag(){let e=Math.min(this.rows,this.columns),t=[];for(let i=0;i<e;i++)t.push(this.get(i,i));return t}norm(e="frobenius"){switch(e){case"max":return this.max();case"frobenius":return Math.sqrt(this.dot(this));default:throw new RangeError(`unknown norm type: ${e}`)}}cumulativeSum(){let e=0;for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)e+=this.get(t,i),this.set(t,i,e);return this}dot(e){ce.isMatrix(e)&&(e=e.to1DArray());let t=this.to1DArray();if(t.length!==e.length)throw new RangeError("vectors do not have the same size");let i=0;for(let n=0;n<t.length;n++)i+=t[n]*e[n];return i}mmul(e){e=C.checkMatrix(e);let t=this.rows,i=this.columns,n=e.columns,s=new C(t,n),o=new Float64Array(i);for(let a=0;a<n;a++){for(let l=0;l<i;l++)o[l]=e.get(l,a);for(let l=0;l<t;l++){let c=0;for(let h=0;h<i;h++)c+=this.get(l,h)*o[h];s.set(l,a,c)}}return s}strassen2x2(e){e=C.checkMatrix(e);let t=new C(2,2);const i=this.get(0,0),n=e.get(0,0),s=this.get(0,1),o=e.get(0,1),a=this.get(1,0),l=e.get(1,0),c=this.get(1,1),h=e.get(1,1),u=(i+c)*(n+h),g=(a+c)*n,y=i*(o-h),v=c*(l-n),E=(i+s)*h,P=(a-i)*(n+o),w=(s-c)*(l+h),S=u+v-E+w,d=y+E,p=g+v,_=u-g+y+P;return t.set(0,0,S),t.set(0,1,d),t.set(1,0,p),t.set(1,1,_),t}strassen3x3(e){e=C.checkMatrix(e);let t=new C(3,3);const i=this.get(0,0),n=this.get(0,1),s=this.get(0,2),o=this.get(1,0),a=this.get(1,1),l=this.get(1,2),c=this.get(2,0),h=this.get(2,1),u=this.get(2,2),g=e.get(0,0),y=e.get(0,1),v=e.get(0,2),E=e.get(1,0),P=e.get(1,1),w=e.get(1,2),S=e.get(2,0),d=e.get(2,1),p=e.get(2,2),_=(i+n+s-o-a-h-u)*P,R=(i-o)*(-y+P),A=a*(-g+y+E-P-w-S+p),M=(-i+o+a)*(g-y+P),f=(o+a)*(-g+y),x=i*g,T=(-i+c+h)*(g-v+w),b=(-i+c)*(v-w),$=(c+h)*(-g+v),Y=(i+n+s-a-l-c-h)*w,X=h*(-g+v+E-P-w-S+d),V=(-s+h+u)*(P+S-d),oe=(s-u)*(P-d),he=s*S,me=(h+u)*(-S+d),ee=(-s+a+l)*(w+S-p),Pe=(s-l)*(w-p),z=(a+l)*(-S+p),ne=n*E,ve=l*d,fe=o*v,le=c*y,Uf=u*p,Wf=x+he+ne,zf=_+M+f+x+V+he+me,Vf=x+T+$+Y+he+ee+z,$f=R+A+M+x+he+ee+Pe,qf=R+M+f+x+ve,Zf=he+ee+Pe+z+fe,Xf=x+T+b+X+V+oe+he,Hf=V+oe+he+me+le,Yf=x+T+b+$+Uf;return t.set(0,0,Wf),t.set(0,1,zf),t.set(0,2,Vf),t.set(1,0,$f),t.set(1,1,qf),t.set(1,2,Zf),t.set(2,0,Xf),t.set(2,1,Hf),t.set(2,2,Yf),t}mmulStrassen(e){e=C.checkMatrix(e);let t=this.clone(),i=t.rows,n=t.columns,s=e.rows,o=e.columns;n!==s&&console.warn(`Multiplying ${i} x ${n} and ${s} x ${o} matrix: dimensions do not match.`);function a(u,g,y){let v=u.rows,E=u.columns;if(v===g&&E===y)return u;{let P=ce.zeros(g,y);return P=P.setSubMatrix(u,0,0),P}}let l=Math.max(i,s),c=Math.max(n,o);t=a(t,l,c),e=a(e,l,c);function h(u,g,y,v){if(y<=512||v<=512)return u.mmul(g);y%2===1&&v%2===1?(u=a(u,y+1,v+1),g=a(g,y+1,v+1)):y%2===1?(u=a(u,y+1,v),g=a(g,y+1,v)):v%2===1&&(u=a(u,y,v+1),g=a(g,y,v+1));let E=parseInt(u.rows/2,10),P=parseInt(u.columns/2,10),w=u.subMatrix(0,E-1,0,P-1),S=g.subMatrix(0,E-1,0,P-1),d=u.subMatrix(0,E-1,P,u.columns-1),p=g.subMatrix(0,E-1,P,g.columns-1),_=u.subMatrix(E,u.rows-1,0,P-1),R=g.subMatrix(E,g.rows-1,0,P-1),A=u.subMatrix(E,u.rows-1,P,u.columns-1),M=g.subMatrix(E,g.rows-1,P,g.columns-1),f=h(ce.add(w,A),ce.add(S,M),E,P),x=h(ce.add(_,A),S,E,P),T=h(w,ce.sub(p,M),E,P),b=h(A,ce.sub(R,S),E,P),$=h(ce.add(w,d),M,E,P),Y=h(ce.sub(_,w),ce.add(S,p),E,P),X=h(ce.sub(d,A),ce.add(R,M),E,P),V=ce.add(f,b);V.sub($),V.add(X);let oe=ce.add(T,$),he=ce.add(x,b),me=ce.sub(f,x);me.add(T),me.add(Y);let ee=ce.zeros(2*V.rows,2*V.columns);return ee=ee.setSubMatrix(V,0,0),ee=ee.setSubMatrix(oe,V.rows,0),ee=ee.setSubMatrix(he,0,V.columns),ee=ee.setSubMatrix(me,V.rows,V.columns),ee.subMatrix(0,y-1,0,v-1)}return h(t,e,l,c)}scaleRows(e={}){if(typeof e!="object")throw new TypeError("options must be an object");const{min:t=0,max:i=1}=e;if(!Number.isFinite(t))throw new TypeError("min must be a number");if(!Number.isFinite(i))throw new TypeError("max must be a number");if(t>=i)throw new RangeError("min must be smaller than max");let n=new C(this.rows,this.columns);for(let s=0;s<this.rows;s++){const o=this.getRow(s);o.length>0&&Es(o,{min:t,max:i,output:o}),n.setRow(s,o)}return n}scaleColumns(e={}){if(typeof e!="object")throw new TypeError("options must be an object");const{min:t=0,max:i=1}=e;if(!Number.isFinite(t))throw new TypeError("min must be a number");if(!Number.isFinite(i))throw new TypeError("max must be a number");if(t>=i)throw new RangeError("min must be smaller than max");let n=new C(this.rows,this.columns);for(let s=0;s<this.columns;s++){const o=this.getColumn(s);o.length&&Es(o,{min:t,max:i,output:o}),n.setColumn(s,o)}return n}flipRows(){const e=Math.ceil(this.columns/2);for(let t=0;t<this.rows;t++)for(let i=0;i<e;i++){let n=this.get(t,i),s=this.get(t,this.columns-1-i);this.set(t,i,s),this.set(t,this.columns-1-i,n)}return this}flipColumns(){const e=Math.ceil(this.rows/2);for(let t=0;t<this.columns;t++)for(let i=0;i<e;i++){let n=this.get(i,t),s=this.get(this.rows-1-i,t);this.set(i,t,s),this.set(this.rows-1-i,t,n)}return this}kroneckerProduct(e){e=C.checkMatrix(e);let t=this.rows,i=this.columns,n=e.rows,s=e.columns,o=new C(t*n,i*s);for(let a=0;a<t;a++)for(let l=0;l<i;l++)for(let c=0;c<n;c++)for(let h=0;h<s;h++)o.set(n*a+c,s*l+h,this.get(a,l)*e.get(c,h));return o}kroneckerSum(e){if(e=C.checkMatrix(e),!this.isSquare()||!e.isSquare())throw new Error("Kronecker Sum needs two Square Matrices");let t=this.rows,i=e.rows,n=this.kroneckerProduct(C.eye(i,i)),s=C.eye(t,t).kroneckerProduct(e);return n.add(s)}transpose(){let e=new C(this.columns,this.rows);for(let t=0;t<this.rows;t++)for(let i=0;i<this.columns;i++)e.set(i,t,this.get(t,i));return e}sortRows(e=Is){for(let t=0;t<this.rows;t++)this.setRow(t,this.getRow(t).sort(e));return this}sortColumns(e=Is){for(let t=0;t<this.columns;t++)this.setColumn(t,this.getColumn(t).sort(e));return this}subMatrix(e,t,i,n){Oi(this,e,t,i,n);let s=new C(t-e+1,n-i+1);for(let o=e;o<=t;o++)for(let a=i;a<=n;a++)s.set(o-e,a-i,this.get(o,a));return s}subMatrixRow(e,t,i){if(t===void 0&&(t=0),i===void 0&&(i=this.columns-1),t>i||t<0||t>=this.columns||i<0||i>=this.columns)throw new RangeError("Argument out of range");let n=new C(e.length,i-t+1);for(let s=0;s<e.length;s++)for(let o=t;o<=i;o++){if(e[s]<0||e[s]>=this.rows)throw new RangeError(`Row index out of range: ${e[s]}`);n.set(s,o-t,this.get(e[s],o))}return n}subMatrixColumn(e,t,i){if(t===void 0&&(t=0),i===void 0&&(i=this.rows-1),t>i||t<0||t>=this.rows||i<0||i>=this.rows)throw new RangeError("Argument out of range");let n=new C(i-t+1,e.length);for(let s=0;s<e.length;s++)for(let o=t;o<=i;o++){if(e[s]<0||e[s]>=this.columns)throw new RangeError(`Column index out of range: ${e[s]}`);n.set(o-t,s,this.get(o,e[s]))}return n}setSubMatrix(e,t,i){if(e=C.checkMatrix(e),e.isEmpty())return this;let n=t+e.rows-1,s=i+e.columns-1;Oi(this,t,n,i,s);for(let o=0;o<e.rows;o++)for(let a=0;a<e.columns;a++)this.set(t+o,i+a,e.get(o,a));return this}selection(e,t){Li(this,e),ji(this,t);let i=new C(e.length,t.length);for(let n=0;n<e.length;n++){let s=e[n];for(let o=0;o<t.length;o++){let a=t[o];i.set(n,o,this.get(s,a))}}return i}trace(){let e=Math.min(this.rows,this.columns),t=0;for(let i=0;i<e;i++)t+=this.get(i,i);return t}clone(){return this.constructor.copy(this,new C(this.rows,this.columns))}static copy(e,t){for(const[i,n,s]of e.entries())t.set(i,n,s);return t}sum(e){switch(e){case"row":return Mc(this);case"column":return Tc(this);case void 0:return Ec(this);default:throw new Error(`invalid option: ${e}`)}}product(e){switch(e){case"row":return Pc(this);case"column":return Sc(this);case void 0:return Rc(this);default:throw new Error(`invalid option: ${e}`)}}mean(e){const t=this.sum(e);switch(e){case"row":{for(let i=0;i<this.rows;i++)t[i]/=this.columns;return t}case"column":{for(let i=0;i<this.columns;i++)t[i]/=this.rows;return t}case void 0:return t/this.size;default:throw new Error(`invalid option: ${e}`)}}variance(e,t={}){if(typeof e=="object"&&(t=e,e=void 0),typeof t!="object")throw new TypeError("options must be an object");const{unbiased:i=!0,mean:n=this.mean(e)}=t;if(typeof i!="boolean")throw new TypeError("unbiased must be a boolean");switch(e){case"row":{if(!we.isAnyArray(n))throw new TypeError("mean must be an array");return Ic(this,i,n)}case"column":{if(!we.isAnyArray(n))throw new TypeError("mean must be an array");return Ac(this,i,n)}case void 0:{if(typeof n!="number")throw new TypeError("mean must be a number");return Cc(this,i,n)}default:throw new Error(`invalid option: ${e}`)}}standardDeviation(e,t){typeof e=="object"&&(t=e,e=void 0);const i=this.variance(e,t);if(e===void 0)return Math.sqrt(i);for(let n=0;n<i.length;n++)i[n]=Math.sqrt(i[n]);return i}center(e,t={}){if(typeof e=="object"&&(t=e,e=void 0),typeof t!="object")throw new TypeError("options must be an object");const{center:i=this.mean(e)}=t;switch(e){case"row":{if(!we.isAnyArray(i))throw new TypeError("center must be an array");return kc(this,i),this}case"column":{if(!we.isAnyArray(i))throw new TypeError("center must be an array");return Lc(this,i),this}case void 0:{if(typeof i!="number")throw new TypeError("center must be a number");return jc(this,i),this}default:throw new Error(`invalid option: ${e}`)}}scale(e,t={}){if(typeof e=="object"&&(t=e,e=void 0),typeof t!="object")throw new TypeError("options must be an object");let i=t.scale;switch(e){case"row":{if(i===void 0)i=Oc(this);else if(!we.isAnyArray(i))throw new TypeError("scale must be an array");return Nc(this,i),this}case"column":{if(i===void 0)i=Dc(this);else if(!we.isAnyArray(i))throw new TypeError("scale must be an array");return Fc(this,i),this}case void 0:{if(i===void 0)i=Gc(this);else if(typeof i!="number")throw new TypeError("scale must be a number");return Bc(this,i),this}default:throw new Error(`invalid option: ${e}`)}}toString(e){return Ss(this,e)}[Symbol.iterator](){return this.entries()}*entries(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)yield[e,t,this.get(e,t)]}*values(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.columns;t++)yield this.get(e,t)}};re.prototype.klass="Matrix",typeof Symbol<"u"&&(re.prototype[Symbol.for("nodejs.util.inspect.custom")]=wc);function Is(r,e){return r-e}function Uc(r){return r.every(e=>typeof e=="number")}re.random=re.rand,re.randomInt=re.randInt,re.diagonal=re.diag,re.prototype.diagonal=re.prototype.diag,re.identity=re.eye,re.prototype.negate=re.prototype.neg,re.prototype.tensorProduct=re.prototype.kroneckerProduct;let C=class vn extends re{data;#e(e,t){if(this.data=[],Number.isInteger(t)&&t>=0)for(let i=0;i<e;i++)this.data.push(new Float64Array(t));else throw new TypeError("nColumns must be a positive integer");this.rows=e,this.columns=t}constructor(e,t){if(super(),vn.isMatrix(e))this.#e(e.rows,e.columns),vn.copy(e,this);else if(Number.isInteger(e)&&e>=0)this.#e(e,t);else if(we.isAnyArray(e)){const i=e;if(e=i.length,t=e?i[0].length:0,typeof t!="number")throw new TypeError("Data must be a 2D array with at least one element");this.data=[];for(let n=0;n<e;n++){if(i[n].length!==t)throw new RangeError("Inconsistent array dimensions");if(!Uc(i[n]))throw new TypeError("Input data contains non-numeric values");this.data.push(Float64Array.from(i[n]))}this.rows=e,this.columns=t}else throw new TypeError("First argument must be a positive number or an array")}set(e,t,i){return this.data[e][t]=i,this}get(e,t){return this.data[e][t]}removeRow(e){return Me(this,e),this.data.splice(e,1),this.rows-=1,this}addRow(e,t){return t===void 0&&(t=e,e=this.rows),Me(this,e,!0),t=Float64Array.from(xt(this,t)),this.data.splice(e,0,t),this.rows+=1,this}removeColumn(e){Te(this,e);for(let t=0;t<this.rows;t++){const i=new Float64Array(this.columns-1);for(let n=0;n<e;n++)i[n]=this.data[t][n];for(let n=e+1;n<this.columns;n++)i[n-1]=this.data[t][n];this.data[t]=i}return this.columns-=1,this}addColumn(e,t){typeof t>"u"&&(t=e,e=this.columns),Te(this,e,!0),t=_t(this,t);for(let i=0;i<this.rows;i++){const n=new Float64Array(this.columns+1);let s=0;for(;s<e;s++)n[s]=this.data[i][s];for(n[s++]=t[i];s<this.columns+1;s++)n[s]=this.data[i][s-1];this.data[i]=n}return this.columns+=1,this}};bc(re,C);class it extends re{#e;get size(){return this.#e.size}get rows(){return this.#e.rows}get columns(){return this.#e.columns}get diagonalSize(){return this.rows}static isSymmetricMatrix(e){return C.isMatrix(e)&&e.klassType==="SymmetricMatrix"}static zeros(e){return new this(e)}static ones(e){return new this(e).fill(1)}constructor(e){if(super(),C.isMatrix(e)){if(!e.isSymmetric())throw new TypeError("not symmetric data");this.#e=C.copy(e,new C(e.rows,e.rows))}else if(Number.isInteger(e)&&e>=0)this.#e=new C(e,e);else if(this.#e=new C(e),!this.isSymmetric())throw new TypeError("not symmetric data")}clone(){const e=new it(this.diagonalSize);for(const[t,i,n]of this.upperRightEntries())e.set(t,i,n);return e}toMatrix(){return new C(this)}get(e,t){return this.#e.get(e,t)}set(e,t,i){return this.#e.set(e,t,i),this.#e.set(t,e,i),this}removeCross(e){return this.#e.removeRow(e),this.#e.removeColumn(e),this}addCross(e,t){t===void 0&&(t=e,e=this.diagonalSize);const i=t.slice();return i.splice(e,1),this.#e.addRow(e,i),this.#e.addColumn(e,t),this}applyMask(e){if(e.length!==this.diagonalSize)throw new RangeError("Mask size do not match with matrix size");const t=[];for(const[i,n]of e.entries())n||t.push(i);t.reverse();for(const i of t)this.removeCross(i);return this}toCompact(){const{diagonalSize:e}=this,t=new Array(e*(e+1)/2);for(let i=0,n=0,s=0;s<t.length;s++)t[s]=this.get(n,i),++i>=e&&(i=++n);return t}static fromCompact(e){const t=e.length,i=(Math.sqrt(8*t+1)-1)/2;if(!Number.isInteger(i))throw new TypeError(`This array is not a compact representation of a Symmetric Matrix, ${JSON.stringify(e)}`);const n=new it(i);for(let s=0,o=0,a=0;a<t;a++)n.set(s,o,e[a]),++s>=i&&(s=++o);return n}*upperRightEntries(){for(let e=0,t=0;e<this.diagonalSize;void 0){const i=this.get(e,t);yield[e,t,i],++t>=this.diagonalSize&&(t=++e)}}*upperRightValues(){for(let e=0,t=0;e<this.diagonalSize;void 0)yield this.get(e,t),++t>=this.diagonalSize&&(t=++e)}}it.prototype.klassType="SymmetricMatrix";class Ur extends it{static isDistanceMatrix(e){return it.isSymmetricMatrix(e)&&e.klassSubType==="DistanceMatrix"}constructor(e){if(super(e),!this.isDistance())throw new TypeError("Provided arguments do no produce a distance matrix")}set(e,t,i){return e===t&&(i=0),super.set(e,t,i)}addCross(e,t){return t===void 0&&(t=e,e=this.diagonalSize),t=t.slice(),t[e]=0,super.addCross(e,t)}toSymmetricMatrix(){return new it(this)}clone(){const e=new Ur(this.diagonalSize);for(const[t,i,n]of this.upperRightEntries())t!==i&&e.set(t,i,n);return e}toCompact(){const{diagonalSize:e}=this,t=(e-1)*e/2,i=new Array(t);for(let n=1,s=0,o=0;o<i.length;o++)i[o]=this.get(s,n),++n>=e&&(n=++s+1);return i}static fromCompact(e){const t=e.length,i=(Math.sqrt(8*t+1)+1)/2;if(!Number.isInteger(i))throw new TypeError(`This array is not a compact representation of a DistanceMatrix, ${JSON.stringify(e)}`);const n=new this(i);for(let s=1,o=0,a=0;a<t;a++)n.set(s,o,e[a]),++s>=i&&(s=++o+1);return n}}Ur.prototype.klassSubType="DistanceMatrix";class He extends re{constructor(e,t,i){super(),this.matrix=e,this.rows=t,this.columns=i}}class Wc extends He{constructor(e,t){Te(e,t),super(e,e.rows,1),this.column=t}set(e,t,i){return this.matrix.set(e,this.column,i),this}get(e){return this.matrix.get(e,this.column)}}class zc extends He{constructor(e,t){ji(e,t),super(e,e.rows,t.length),this.columnIndices=t}set(e,t,i){return this.matrix.set(e,this.columnIndices[t],i),this}get(e,t){return this.matrix.get(e,this.columnIndices[t])}}class Vc extends He{constructor(e){super(e,e.rows,e.columns)}set(e,t,i){return this.matrix.set(e,this.columns-t-1,i),this}get(e,t){return this.matrix.get(e,this.columns-t-1)}}class $c extends He{constructor(e){super(e,e.rows,e.columns)}set(e,t,i){return this.matrix.set(this.rows-e-1,t,i),this}get(e,t){return this.matrix.get(this.rows-e-1,t)}}class qc extends He{constructor(e,t){Me(e,t),super(e,1,e.columns),this.row=t}set(e,t,i){return this.matrix.set(this.row,t,i),this}get(e,t){return this.matrix.get(this.row,t)}}class Zc extends He{constructor(e,t){Li(e,t),super(e,t.length,e.columns),this.rowIndices=t}set(e,t,i){return this.matrix.set(this.rowIndices[e],t,i),this}get(e,t){return this.matrix.get(this.rowIndices[e],t)}}class Wr extends He{constructor(e,t,i){Li(e,t),ji(e,i),super(e,t.length,i.length),this.rowIndices=t,this.columnIndices=i}set(e,t,i){return this.matrix.set(this.rowIndices[e],this.columnIndices[t],i),this}get(e,t){return this.matrix.get(this.rowIndices[e],this.columnIndices[t])}}class Xc extends He{constructor(e,t,i,n,s){Oi(e,t,i,n,s),super(e,i-t+1,s-n+1),this.startRow=t,this.startColumn=n}set(e,t,i){return this.matrix.set(this.startRow+e,this.startColumn+t,i),this}get(e,t){return this.matrix.get(this.startRow+e,this.startColumn+t)}}class Hc extends He{constructor(e){super(e,e.columns,e.rows)}set(e,t,i){return this.matrix.set(t,e,i),this}get(e,t){return this.matrix.get(t,e)}}class As extends re{constructor(e,t={}){const{rows:i=1}=t;if(e.length%i!==0)throw new Error("the data length is not divisible by the number of rows");super(),this.rows=i,this.columns=e.length/i,this.data=e}set(e,t,i){let n=this._calculateIndex(e,t);return this.data[n]=i,this}get(e,t){let i=this._calculateIndex(e,t);return this.data[i]}_calculateIndex(e,t){return e*this.columns+t}}let be=class extends re{constructor(e){super(),this.data=e,this.rows=e.length,this.columns=e[0].length}set(e,t,i){return this.data[e][t]=i,this}get(e,t){return this.data[e][t]}};function Yc(r,e){if(we.isAnyArray(r))return r[0]&&we.isAnyArray(r[0])?new be(r):new As(r,e);throw new Error("the argument is not an array")}class zr{constructor(e){e=be.checkMatrix(e);let t=e.clone(),i=t.rows,n=t.columns,s=new Float64Array(i),o=1,a,l,c,h,u,g,y,v,E;for(a=0;a<i;a++)s[a]=a;for(v=new Float64Array(i),l=0;l<n;l++){for(a=0;a<i;a++)v[a]=t.get(a,l);for(a=0;a<i;a++){for(E=Math.min(a,l),u=0,c=0;c<E;c++)u+=t.get(a,c)*v[c];v[a]-=u,t.set(a,l,v[a])}for(h=l,a=l+1;a<i;a++)Math.abs(v[a])>Math.abs(v[h])&&(h=a);if(h!==l){for(c=0;c<n;c++)g=t.get(h,c),t.set(h,c,t.get(l,c)),t.set(l,c,g);y=s[h],s[h]=s[l],s[l]=y,o=-o}if(l<i&&t.get(l,l)!==0)for(a=l+1;a<i;a++)t.set(a,l,t.get(a,l)/t.get(l,l))}this.LU=t,this.pivotVector=s,this.pivotSign=o}isSingular(){let e=this.LU,t=e.columns;for(let i=0;i<t;i++)if(e.get(i,i)===0)return!0;return!1}solve(e){e=C.checkMatrix(e);let t=this.LU;if(t.rows!==e.rows)throw new Error("Invalid matrix dimensions");if(this.isSingular())throw new Error("LU matrix is singular");let i=e.columns,n=e.subMatrixRow(this.pivotVector,0,i-1),s=t.columns,o,a,l;for(l=0;l<s;l++)for(o=l+1;o<s;o++)for(a=0;a<i;a++)n.set(o,a,n.get(o,a)-n.get(l,a)*t.get(o,l));for(l=s-1;l>=0;l--){for(a=0;a<i;a++)n.set(l,a,n.get(l,a)/t.get(l,l));for(o=0;o<l;o++)for(a=0;a<i;a++)n.set(o,a,n.get(o,a)-n.get(l,a)*t.get(o,l))}return n}get determinant(){let e=this.LU;if(!e.isSquare())throw new Error("Matrix must be square");let t=this.pivotSign,i=e.columns;for(let n=0;n<i;n++)t*=e.get(n,n);return t}get lowerTriangularMatrix(){let e=this.LU,t=e.rows,i=e.columns,n=new C(t,i);for(let s=0;s<t;s++)for(let o=0;o<i;o++)s>o?n.set(s,o,e.get(s,o)):s===o?n.set(s,o,1):n.set(s,o,0);return n}get upperTriangularMatrix(){let e=this.LU,t=e.rows,i=e.columns,n=new C(t,i);for(let s=0;s<t;s++)for(let o=0;o<i;o++)s<=o?n.set(s,o,e.get(s,o)):n.set(s,o,0);return n}get pivotPermutationVector(){return Array.from(this.pivotVector)}}function Ye(r,e){let t=0;return Math.abs(r)>Math.abs(e)?(t=e/r,Math.abs(r)*Math.sqrt(1+t*t)):e!==0?(t=r/e,Math.abs(e)*Math.sqrt(1+t*t)):0}class Ni{constructor(e){e=be.checkMatrix(e);let t=e.clone(),i=e.rows,n=e.columns,s=new Float64Array(n),o,a,l,c;for(l=0;l<n;l++){let h=0;for(o=l;o<i;o++)h=Ye(h,t.get(o,l));if(h!==0){for(t.get(l,l)<0&&(h=-h),o=l;o<i;o++)t.set(o,l,t.get(o,l)/h);for(t.set(l,l,t.get(l,l)+1),a=l+1;a<n;a++){for(c=0,o=l;o<i;o++)c+=t.get(o,l)*t.get(o,a);for(c=-c/t.get(l,l),o=l;o<i;o++)t.set(o,a,t.get(o,a)+c*t.get(o,l))}}s[l]=-h}this.QR=t,this.Rdiag=s}solve(e){e=C.checkMatrix(e);let t=this.QR,i=t.rows;if(e.rows!==i)throw new Error("Matrix row dimensions must agree");if(!this.isFullRank())throw new Error("Matrix is rank deficient");let n=e.columns,s=e.clone(),o=t.columns,a,l,c,h;for(c=0;c<o;c++)for(l=0;l<n;l++){for(h=0,a=c;a<i;a++)h+=t.get(a,c)*s.get(a,l);for(h=-h/t.get(c,c),a=c;a<i;a++)s.set(a,l,s.get(a,l)+h*t.get(a,c))}for(c=o-1;c>=0;c--){for(l=0;l<n;l++)s.set(c,l,s.get(c,l)/this.Rdiag[c]);for(a=0;a<c;a++)for(l=0;l<n;l++)s.set(a,l,s.get(a,l)-s.get(c,l)*t.get(a,c))}return s.subMatrix(0,o-1,0,n-1)}isFullRank(){let e=this.QR.columns;for(let t=0;t<e;t++)if(this.Rdiag[t]===0)return!1;return!0}get upperTriangularMatrix(){let e=this.QR,t=e.columns,i=new C(t,t),n,s;for(n=0;n<t;n++)for(s=0;s<t;s++)n<s?i.set(n,s,e.get(n,s)):n===s?i.set(n,s,this.Rdiag[n]):i.set(n,s,0);return i}get orthogonalMatrix(){let e=this.QR,t=e.rows,i=e.columns,n=new C(t,i),s,o,a,l;for(a=i-1;a>=0;a--){for(s=0;s<t;s++)n.set(s,a,0);for(n.set(a,a,1),o=a;o<i;o++)if(e.get(a,a)!==0){for(l=0,s=a;s<t;s++)l+=e.get(s,a)*n.get(s,o);for(l=-l/e.get(a,a),s=a;s<t;s++)n.set(s,o,n.get(s,o)+l*e.get(s,a))}}return n}}let Mt=class{constructor(r,e={}){if(r=be.checkMatrix(r),r.isEmpty())throw new Error("Matrix must be non-empty");let t=r.rows,i=r.columns;const{computeLeftSingularVectors:n=!0,computeRightSingularVectors:s=!0,autoTranspose:o=!1}=e;let a=!!n,l=!!s,c=!1,h;if(t<i)if(!o)h=r.clone(),console.warn("Computing SVD on a matrix with more columns than rows. Consider enabling autoTranspose");else{h=r.transpose(),t=h.rows,i=h.columns,c=!0;let f=a;a=l,l=f}else h=r.clone();let u=Math.min(t,i),g=Math.min(t+1,i),y=new Float64Array(g),v=new C(t,u),E=new C(i,i),P=new Float64Array(i),w=new Float64Array(t),S=new Float64Array(g);for(let f=0;f<g;f++)S[f]=f;let d=Math.min(t-1,i),p=Math.max(0,Math.min(i-2,t)),_=Math.max(d,p);for(let f=0;f<_;f++){if(f<d){y[f]=0;for(let x=f;x<t;x++)y[f]=Ye(y[f],h.get(x,f));if(y[f]!==0){h.get(f,f)<0&&(y[f]=-y[f]);for(let x=f;x<t;x++)h.set(x,f,h.get(x,f)/y[f]);h.set(f,f,h.get(f,f)+1)}y[f]=-y[f]}for(let x=f+1;x<i;x++){if(f<d&&y[f]!==0){let T=0;for(let b=f;b<t;b++)T+=h.get(b,f)*h.get(b,x);T=-T/h.get(f,f);for(let b=f;b<t;b++)h.set(b,x,h.get(b,x)+T*h.get(b,f))}P[x]=h.get(f,x)}if(a&&f<d)for(let x=f;x<t;x++)v.set(x,f,h.get(x,f));if(f<p){P[f]=0;for(let x=f+1;x<i;x++)P[f]=Ye(P[f],P[x]);if(P[f]!==0){P[f+1]<0&&(P[f]=0-P[f]);for(let x=f+1;x<i;x++)P[x]/=P[f];P[f+1]+=1}if(P[f]=-P[f],f+1<t&&P[f]!==0){for(let x=f+1;x<t;x++)w[x]=0;for(let x=f+1;x<t;x++)for(let T=f+1;T<i;T++)w[x]+=P[T]*h.get(x,T);for(let x=f+1;x<i;x++){let T=-P[x]/P[f+1];for(let b=f+1;b<t;b++)h.set(b,x,h.get(b,x)+T*w[b])}}if(l)for(let x=f+1;x<i;x++)E.set(x,f,P[x])}}let R=Math.min(i,t+1);if(d<i&&(y[d]=h.get(d,d)),t<R&&(y[R-1]=0),p+1<R&&(P[p]=h.get(p,R-1)),P[R-1]=0,a){for(let f=d;f<u;f++){for(let x=0;x<t;x++)v.set(x,f,0);v.set(f,f,1)}for(let f=d-1;f>=0;f--)if(y[f]!==0){for(let x=f+1;x<u;x++){let T=0;for(let b=f;b<t;b++)T+=v.get(b,f)*v.get(b,x);T=-T/v.get(f,f);for(let b=f;b<t;b++)v.set(b,x,v.get(b,x)+T*v.get(b,f))}for(let x=f;x<t;x++)v.set(x,f,-v.get(x,f));v.set(f,f,1+v.get(f,f));for(let x=0;x<f-1;x++)v.set(x,f,0)}else{for(let x=0;x<t;x++)v.set(x,f,0);v.set(f,f,1)}}if(l)for(let f=i-1;f>=0;f--){if(f<p&&P[f]!==0)for(let x=f+1;x<i;x++){let T=0;for(let b=f+1;b<i;b++)T+=E.get(b,f)*E.get(b,x);T=-T/E.get(f+1,f);for(let b=f+1;b<i;b++)E.set(b,x,E.get(b,x)+T*E.get(b,f))}for(let x=0;x<i;x++)E.set(x,f,0);E.set(f,f,1)}let A=R-1,M=Number.EPSILON;for(;R>0;){let f,x;for(f=R-2;f>=-1&&f!==-1;f--){const T=Number.MIN_VALUE+M*Math.abs(y[f]+Math.abs(y[f+1]));if(Math.abs(P[f])<=T||Number.isNaN(P[f])){P[f]=0;break}}if(f===R-2)x=4;else{let T;for(T=R-1;T>=f&&T!==f;T--){let b=(T!==R?Math.abs(P[T]):0)+(T!==f+1?Math.abs(P[T-1]):0);if(Math.abs(y[T])<=M*b){y[T]=0;break}}T===f?x=3:T===R-1?x=1:(x=2,f=T)}switch(f++,x){case 1:{let T=P[R-2];P[R-2]=0;for(let b=R-2;b>=f;b--){let $=Ye(y[b],T),Y=y[b]/$,X=T/$;if(y[b]=$,b!==f&&(T=-X*P[b-1],P[b-1]=Y*P[b-1]),l)for(let V=0;V<i;V++)$=Y*E.get(V,b)+X*E.get(V,R-1),E.set(V,R-1,-X*E.get(V,b)+Y*E.get(V,R-1)),E.set(V,b,$)}break}case 2:{let T=P[f-1];P[f-1]=0;for(let b=f;b<R;b++){let $=Ye(y[b],T),Y=y[b]/$,X=T/$;if(y[b]=$,T=-X*P[b],P[b]=Y*P[b],a)for(let V=0;V<t;V++)$=Y*v.get(V,b)+X*v.get(V,f-1),v.set(V,f-1,-X*v.get(V,b)+Y*v.get(V,f-1)),v.set(V,b,$)}break}case 3:{const T=Math.max(Math.abs(y[R-1]),Math.abs(y[R-2]),Math.abs(P[R-2]),Math.abs(y[f]),Math.abs(P[f])),b=y[R-1]/T,$=y[R-2]/T,Y=P[R-2]/T,X=y[f]/T,V=P[f]/T,oe=(($+b)*($-b)+Y*Y)/2,he=b*Y*(b*Y);let me=0;(oe!==0||he!==0)&&(oe<0?me=0-Math.sqrt(oe*oe+he):me=Math.sqrt(oe*oe+he),me=he/(oe+me));let ee=(X+b)*(X-b)+me,Pe=X*V;for(let z=f;z<R-1;z++){let ne=Ye(ee,Pe);ne===0&&(ne=Number.MIN_VALUE);let ve=ee/ne,fe=Pe/ne;if(z!==f&&(P[z-1]=ne),ee=ve*y[z]+fe*P[z],P[z]=ve*P[z]-fe*y[z],Pe=fe*y[z+1],y[z+1]=ve*y[z+1],l)for(let le=0;le<i;le++)ne=ve*E.get(le,z)+fe*E.get(le,z+1),E.set(le,z+1,-fe*E.get(le,z)+ve*E.get(le,z+1)),E.set(le,z,ne);if(ne=Ye(ee,Pe),ne===0&&(ne=Number.MIN_VALUE),ve=ee/ne,fe=Pe/ne,y[z]=ne,ee=ve*P[z]+fe*y[z+1],y[z+1]=-fe*P[z]+ve*y[z+1],Pe=fe*P[z+1],P[z+1]=ve*P[z+1],a&&z<t-1)for(let le=0;le<t;le++)ne=ve*v.get(le,z)+fe*v.get(le,z+1),v.set(le,z+1,-fe*v.get(le,z)+ve*v.get(le,z+1)),v.set(le,z,ne)}P[R-2]=ee;break}case 4:{if(y[f]<=0&&(y[f]=y[f]<0?-y[f]:0,l))for(let T=0;T<=A;T++)E.set(T,f,-E.get(T,f));for(;f<A&&!(y[f]>=y[f+1]);){let T=y[f];if(y[f]=y[f+1],y[f+1]=T,l&&f<i-1)for(let b=0;b<i;b++)T=E.get(b,f+1),E.set(b,f+1,E.get(b,f)),E.set(b,f,T);if(a&&f<t-1)for(let b=0;b<t;b++)T=v.get(b,f+1),v.set(b,f+1,v.get(b,f)),v.set(b,f,T);f++}R--;break}}}if(c){let f=E;E=v,v=f}this.m=t,this.n=i,this.s=y,this.U=v,this.V=E}solve(r){let e=r,t=this.threshold,i=this.s.length,n=C.zeros(i,i);for(let u=0;u<i;u++)Math.abs(this.s[u])<=t?n.set(u,u,0):n.set(u,u,1/this.s[u]);let s=this.U,o=this.rightSingularVectors,a=o.mmul(n),l=o.rows,c=s.rows,h=C.zeros(l,c);for(let u=0;u<l;u++)for(let g=0;g<c;g++){let y=0;for(let v=0;v<i;v++)y+=a.get(u,v)*s.get(g,v);h.set(u,g,y)}return h.mmul(e)}solveForDiagonal(r){return this.solve(C.diag(r))}inverse(){let r=this.V,e=this.threshold,t=r.rows,i=r.columns,n=new C(t,this.s.length);for(let c=0;c<t;c++)for(let h=0;h<i;h++)Math.abs(this.s[h])>e&&n.set(c,h,r.get(c,h)/this.s[h]);let s=this.U,o=s.rows,a=s.columns,l=new C(t,o);for(let c=0;c<t;c++)for(let h=0;h<o;h++){let u=0;for(let g=0;g<a;g++)u+=n.get(c,g)*s.get(h,g);l.set(c,h,u)}return l}get condition(){return this.s[0]/this.s[Math.min(this.m,this.n)-1]}get norm2(){return this.s[0]}get rank(){let r=Math.max(this.m,this.n)*this.s[0]*Number.EPSILON,e=0,t=this.s;for(let i=0,n=t.length;i<n;i++)t[i]>r&&e++;return e}get diagonal(){return Array.from(this.s)}get threshold(){return Number.EPSILON/2*Math.max(this.m,this.n)*this.s[0]}get leftSingularVectors(){return this.U}get rightSingularVectors(){return this.V}get diagonalMatrix(){return C.diag(this.s)}};function Jc(r,e=!1){return r=be.checkMatrix(r),e?new Mt(r).inverse():Cs(r,C.eye(r.rows))}function Cs(r,e,t=!1){return r=be.checkMatrix(r),e=be.checkMatrix(e),t?new Mt(r).solve(e):r.isSquare()?new zr(r).solve(e):new Ni(r).solve(e)}function Vr(r){if(r=C.checkMatrix(r),r.isSquare()){if(r.columns===0)return 1;let e,t,i,n;if(r.columns===2)return e=r.get(0,0),t=r.get(0,1),i=r.get(1,0),n=r.get(1,1),e*n-t*i;if(r.columns===3){let s,o,a;return s=new Wr(r,[1,2],[1,2]),o=new Wr(r,[1,2],[0,2]),a=new Wr(r,[1,2],[0,1]),e=r.get(0,0),t=r.get(0,1),i=r.get(0,2),e*Vr(s)-t*Vr(o)+i*Vr(a)}else return new zr(r).determinant}else throw Error("determinant can only be calculated for a square matrix")}function Qc(r,e){let t=[];for(let i=0;i<r;i++)i!==e&&t.push(i);return t}function Kc(r,e,t,i=1e-9,n=1e-9){if(r>n)return new Array(e.rows+1).fill(0);{let s=e.addRow(t,[0]);for(let o=0;o<s.rows;o++)Math.abs(s.get(o,0))<i&&s.set(o,0,0);return s.to1DArray()}}function eh(r,e={}){const{thresholdValue:t=1e-9,thresholdError:i=1e-9}=e;r=C.checkMatrix(r);let n=r.rows,s=new C(n,n);for(let o=0;o<n;o++){let a=C.columnVector(r.getRow(o)),l=r.subMatrixRow(Qc(n,o)).transpose(),c=new Mt(l).solve(a),h=C.sub(a,l.mmul(c)).abs().max();s.setRow(o,Kc(h,c,o,t,i))}return s}function th(r,e=Number.EPSILON){if(r=C.checkMatrix(r),r.isEmpty())return r.transpose();let t=new Mt(r,{autoTranspose:!0}),i=t.leftSingularVectors,n=t.rightSingularVectors,s=t.diagonal;for(let o=0;o<s.length;o++)Math.abs(s[o])>e?s[o]=1/s[o]:s[o]=0;return n.mmul(C.diag(s).mmul(i.transpose()))}function rh(r,e=r,t={}){r=new C(r);let i=!1;if(typeof e=="object"&&!C.isMatrix(e)&&!we.isAnyArray(e)?(t=e,e=r,i=!0):e=new C(e),r.rows!==e.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:n=!0}=t;n&&(r=r.center("column"),i||(e=e.center("column")));const s=r.transpose().mmul(e);for(let o=0;o<s.rows;o++)for(let a=0;a<s.columns;a++)s.set(o,a,s.get(o,a)*(1/(r.rows-1)));return s}function ih(r,e=r,t={}){r=new C(r);let i=!1;if(typeof e=="object"&&!C.isMatrix(e)&&!we.isAnyArray(e)?(t=e,e=r,i=!0):e=new C(e),r.rows!==e.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:n=!0,scale:s=!0}=t;n&&(r.center("column"),i||e.center("column")),s&&(r.scale("column"),i||e.scale("column"));const o=r.standardDeviation("column",{unbiased:!0}),a=i?o:e.standardDeviation("column",{unbiased:!0}),l=r.transpose().mmul(e);for(let c=0;c<l.rows;c++)for(let h=0;h<l.columns;h++)l.set(c,h,l.get(c,h)*(1/(o[c]*a[h]))*(1/(r.rows-1)));return l}class ks{constructor(e,t={}){const{assumeSymmetric:i=!1}=t;if(e=be.checkMatrix(e),!e.isSquare())throw new Error("Matrix is not a square matrix");if(e.isEmpty())throw new Error("Matrix must be non-empty");let n=e.columns,s=new C(n,n),o=new Float64Array(n),a=new Float64Array(n),l=e,c,h,u=!1;if(i?u=!0:u=e.isSymmetric(),u){for(c=0;c<n;c++)for(h=0;h<n;h++)s.set(c,h,l.get(c,h));nh(n,a,o,s),sh(n,a,o,s)}else{let g=new C(n,n),y=new Float64Array(n);for(h=0;h<n;h++)for(c=0;c<n;c++)g.set(c,h,l.get(c,h));oh(n,g,y,s),ah(n,a,o,s,g)}this.n=n,this.e=a,this.d=o,this.V=s}get realEigenvalues(){return Array.from(this.d)}get imaginaryEigenvalues(){return Array.from(this.e)}get eigenvectorMatrix(){return this.V}get diagonalMatrix(){let e=this.n,t=this.e,i=this.d,n=new C(e,e),s,o;for(s=0;s<e;s++){for(o=0;o<e;o++)n.set(s,o,0);n.set(s,s,i[s]),t[s]>0?n.set(s,s+1,t[s]):t[s]<0&&n.set(s,s-1,t[s])}return n}}function nh(r,e,t,i){let n,s,o,a,l,c,h,u;for(l=0;l<r;l++)t[l]=i.get(r-1,l);for(a=r-1;a>0;a--){for(u=0,o=0,c=0;c<a;c++)u=u+Math.abs(t[c]);if(u===0)for(e[a]=t[a-1],l=0;l<a;l++)t[l]=i.get(a-1,l),i.set(a,l,0),i.set(l,a,0);else{for(c=0;c<a;c++)t[c]/=u,o+=t[c]*t[c];for(n=t[a-1],s=Math.sqrt(o),n>0&&(s=-s),e[a]=u*s,o=o-n*s,t[a-1]=n-s,l=0;l<a;l++)e[l]=0;for(l=0;l<a;l++){for(n=t[l],i.set(l,a,n),s=e[l]+i.get(l,l)*n,c=l+1;c<=a-1;c++)s+=i.get(c,l)*t[c],e[c]+=i.get(c,l)*n;e[l]=s}for(n=0,l=0;l<a;l++)e[l]/=o,n+=e[l]*t[l];for(h=n/(o+o),l=0;l<a;l++)e[l]-=h*t[l];for(l=0;l<a;l++){for(n=t[l],s=e[l],c=l;c<=a-1;c++)i.set(c,l,i.get(c,l)-(n*e[c]+s*t[c]));t[l]=i.get(a-1,l),i.set(a,l,0)}}t[a]=o}for(a=0;a<r-1;a++){if(i.set(r-1,a,i.get(a,a)),i.set(a,a,1),o=t[a+1],o!==0){for(c=0;c<=a;c++)t[c]=i.get(c,a+1)/o;for(l=0;l<=a;l++){for(s=0,c=0;c<=a;c++)s+=i.get(c,a+1)*i.get(c,l);for(c=0;c<=a;c++)i.set(c,l,i.get(c,l)-s*t[c])}}for(c=0;c<=a;c++)i.set(c,a+1,0)}for(l=0;l<r;l++)t[l]=i.get(r-1,l),i.set(r-1,l,0);i.set(r-1,r-1,1),e[0]=0}function sh(r,e,t,i){let n,s,o,a,l,c,h,u,g,y,v,E,P,w,S,d;for(o=1;o<r;o++)e[o-1]=e[o];e[r-1]=0;let p=0,_=0,R=Number.EPSILON;for(c=0;c<r;c++){for(_=Math.max(_,Math.abs(t[c])+Math.abs(e[c])),h=c;h<r&&!(Math.abs(e[h])<=R*_);)h++;if(h>c)do{for(n=t[c],u=(t[c+1]-n)/(2*e[c]),g=Ye(u,1),u<0&&(g=-g),t[c]=e[c]/(u+g),t[c+1]=e[c]*(u+g),y=t[c+1],s=n-t[c],o=c+2;o<r;o++)t[o]-=s;for(p=p+s,u=t[h],v=1,E=v,P=v,w=e[c+1],S=0,d=0,o=h-1;o>=c;o--)for(P=E,E=v,d=S,n=v*e[o],s=v*u,g=Ye(u,e[o]),e[o+1]=S*g,S=e[o]/g,v=u/g,u=v*t[o]-S*n,t[o+1]=s+S*(v*n+S*t[o]),l=0;l<r;l++)s=i.get(l,o+1),i.set(l,o+1,S*i.get(l,o)+v*s),i.set(l,o,v*i.get(l,o)-S*s);u=-S*d*P*w*e[c]/y,e[c]=S*u,t[c]=v*u}while(Math.abs(e[c])>R*_);t[c]=t[c]+p,e[c]=0}for(o=0;o<r-1;o++){for(l=o,u=t[o],a=o+1;a<r;a++)t[a]<u&&(l=a,u=t[a]);if(l!==o)for(t[l]=t[o],t[o]=u,a=0;a<r;a++)u=i.get(a,o),i.set(a,o,i.get(a,l)),i.set(a,l,u)}}function oh(r,e,t,i){let n=0,s=r-1,o,a,l,c,h,u,g;for(u=n+1;u<=s-1;u++){for(g=0,c=u;c<=s;c++)g=g+Math.abs(e.get(c,u-1));if(g!==0){for(l=0,c=s;c>=u;c--)t[c]=e.get(c,u-1)/g,l+=t[c]*t[c];for(a=Math.sqrt(l),t[u]>0&&(a=-a),l=l-t[u]*a,t[u]=t[u]-a,h=u;h<r;h++){for(o=0,c=s;c>=u;c--)o+=t[c]*e.get(c,h);for(o=o/l,c=u;c<=s;c++)e.set(c,h,e.get(c,h)-o*t[c])}for(c=0;c<=s;c++){for(o=0,h=s;h>=u;h--)o+=t[h]*e.get(c,h);for(o=o/l,h=u;h<=s;h++)e.set(c,h,e.get(c,h)-o*t[h])}t[u]=g*t[u],e.set(u,u-1,g*a)}}for(c=0;c<r;c++)for(h=0;h<r;h++)i.set(c,h,c===h?1:0);for(u=s-1;u>=n+1;u--)if(e.get(u,u-1)!==0){for(c=u+1;c<=s;c++)t[c]=e.get(c,u-1);for(h=u;h<=s;h++){for(a=0,c=u;c<=s;c++)a+=t[c]*i.get(c,h);for(a=a/t[u]/e.get(u,u-1),c=u;c<=s;c++)i.set(c,h,i.get(c,h)+a*t[c])}}}function ah(r,e,t,i,n){let s=r-1,o=0,a=r-1,l=Number.EPSILON,c=0,h=0,u=0,g=0,y=0,v=0,E=0,P=0,w,S,d,p,_,R,A,M,f,x,T,b,$,Y,X;for(w=0;w<r;w++)for((w<o||w>a)&&(t[w]=n.get(w,w),e[w]=0),S=Math.max(w-1,0);S<r;S++)h=h+Math.abs(n.get(w,S));for(;s>=o;){for(p=s;p>o&&(v=Math.abs(n.get(p-1,p-1))+Math.abs(n.get(p,p)),v===0&&(v=h),!(Math.abs(n.get(p,p-1))<l*v));)p--;if(p===s)n.set(s,s,n.get(s,s)+c),t[s]=n.get(s,s),e[s]=0,s--,P=0;else if(p===s-1){if(A=n.get(s,s-1)*n.get(s-1,s),u=(n.get(s-1,s-1)-n.get(s,s))/2,g=u*u+A,E=Math.sqrt(Math.abs(g)),n.set(s,s,n.get(s,s)+c),n.set(s-1,s-1,n.get(s-1,s-1)+c),M=n.get(s,s),g>=0){for(E=u>=0?u+E:u-E,t[s-1]=M+E,t[s]=t[s-1],E!==0&&(t[s]=M-A/E),e[s-1]=0,e[s]=0,M=n.get(s,s-1),v=Math.abs(M)+Math.abs(E),u=M/v,g=E/v,y=Math.sqrt(u*u+g*g),u=u/y,g=g/y,S=s-1;S<r;S++)E=n.get(s-1,S),n.set(s-1,S,g*E+u*n.get(s,S)),n.set(s,S,g*n.get(s,S)-u*E);for(w=0;w<=s;w++)E=n.get(w,s-1),n.set(w,s-1,g*E+u*n.get(w,s)),n.set(w,s,g*n.get(w,s)-u*E);for(w=o;w<=a;w++)E=i.get(w,s-1),i.set(w,s-1,g*E+u*i.get(w,s)),i.set(w,s,g*i.get(w,s)-u*E)}else t[s-1]=M+u,t[s]=M+u,e[s-1]=E,e[s]=-E;s=s-2,P=0}else{if(M=n.get(s,s),f=0,A=0,p<s&&(f=n.get(s-1,s-1),A=n.get(s,s-1)*n.get(s-1,s)),P===10){for(c+=M,w=o;w<=s;w++)n.set(w,w,n.get(w,w)-M);v=Math.abs(n.get(s,s-1))+Math.abs(n.get(s-1,s-2)),M=f=.75*v,A=-.4375*v*v}if(P===30&&(v=(f-M)/2,v=v*v+A,v>0)){for(v=Math.sqrt(v),f<M&&(v=-v),v=M-A/((f-M)/2+v),w=o;w<=s;w++)n.set(w,w,n.get(w,w)-v);c+=v,M=f=A=.964}for(P=P+1,_=s-2;_>=p&&(E=n.get(_,_),y=M-E,v=f-E,u=(y*v-A)/n.get(_+1,_)+n.get(_,_+1),g=n.get(_+1,_+1)-E-y-v,y=n.get(_+2,_+1),v=Math.abs(u)+Math.abs(g)+Math.abs(y),u=u/v,g=g/v,y=y/v,!(_===p||Math.abs(n.get(_,_-1))*(Math.abs(g)+Math.abs(y))<l*(Math.abs(u)*(Math.abs(n.get(_-1,_-1))+Math.abs(E)+Math.abs(n.get(_+1,_+1))))));)_--;for(w=_+2;w<=s;w++)n.set(w,w-2,0),w>_+2&&n.set(w,w-3,0);for(d=_;d<=s-1&&(Y=d!==s-1,d!==_&&(u=n.get(d,d-1),g=n.get(d+1,d-1),y=Y?n.get(d+2,d-1):0,M=Math.abs(u)+Math.abs(g)+Math.abs(y),M!==0&&(u=u/M,g=g/M,y=y/M)),M!==0);d++)if(v=Math.sqrt(u*u+g*g+y*y),u<0&&(v=-v),v!==0){for(d!==_?n.set(d,d-1,-v*M):p!==_&&n.set(d,d-1,-n.get(d,d-1)),u=u+v,M=u/v,f=g/v,E=y/v,g=g/u,y=y/u,S=d;S<r;S++)u=n.get(d,S)+g*n.get(d+1,S),Y&&(u=u+y*n.get(d+2,S),n.set(d+2,S,n.get(d+2,S)-u*E)),n.set(d,S,n.get(d,S)-u*M),n.set(d+1,S,n.get(d+1,S)-u*f);for(w=0;w<=Math.min(s,d+3);w++)u=M*n.get(w,d)+f*n.get(w,d+1),Y&&(u=u+E*n.get(w,d+2),n.set(w,d+2,n.get(w,d+2)-u*y)),n.set(w,d,n.get(w,d)-u),n.set(w,d+1,n.get(w,d+1)-u*g);for(w=o;w<=a;w++)u=M*i.get(w,d)+f*i.get(w,d+1),Y&&(u=u+E*i.get(w,d+2),i.set(w,d+2,i.get(w,d+2)-u*y)),i.set(w,d,i.get(w,d)-u),i.set(w,d+1,i.get(w,d+1)-u*g)}}}if(h!==0){for(s=r-1;s>=0;s--)if(u=t[s],g=e[s],g===0)for(p=s,n.set(s,s,1),w=s-1;w>=0;w--){for(A=n.get(w,w)-u,y=0,S=p;S<=s;S++)y=y+n.get(w,S)*n.get(S,s);if(e[w]<0)E=A,v=y;else if(p=w,e[w]===0?n.set(w,s,A!==0?-y/A:-y/(l*h)):(M=n.get(w,w+1),f=n.get(w+1,w),g=(t[w]-u)*(t[w]-u)+e[w]*e[w],R=(M*v-E*y)/g,n.set(w,s,R),n.set(w+1,s,Math.abs(M)>Math.abs(E)?(-y-A*R)/M:(-v-f*R)/E)),R=Math.abs(n.get(w,s)),l*R*R>1)for(S=w;S<=s;S++)n.set(S,s,n.get(S,s)/R)}else if(g<0)for(p=s-1,Math.abs(n.get(s,s-1))>Math.abs(n.get(s-1,s))?(n.set(s-1,s-1,g/n.get(s,s-1)),n.set(s-1,s,-(n.get(s,s)-u)/n.get(s,s-1))):(X=$r(0,-n.get(s-1,s),n.get(s-1,s-1)-u,g),n.set(s-1,s-1,X[0]),n.set(s-1,s,X[1])),n.set(s,s-1,0),n.set(s,s,1),w=s-2;w>=0;w--){for(x=0,T=0,S=p;S<=s;S++)x=x+n.get(w,S)*n.get(S,s-1),T=T+n.get(w,S)*n.get(S,s);if(A=n.get(w,w)-u,e[w]<0)E=A,y=x,v=T;else if(p=w,e[w]===0?(X=$r(-x,-T,A,g),n.set(w,s-1,X[0]),n.set(w,s,X[1])):(M=n.get(w,w+1),f=n.get(w+1,w),b=(t[w]-u)*(t[w]-u)+e[w]*e[w]-g*g,$=(t[w]-u)*2*g,b===0&&$===0&&(b=l*h*(Math.abs(A)+Math.abs(g)+Math.abs(M)+Math.abs(f)+Math.abs(E))),X=$r(M*y-E*x+g*T,M*v-E*T-g*x,b,$),n.set(w,s-1,X[0]),n.set(w,s,X[1]),Math.abs(M)>Math.abs(E)+Math.abs(g)?(n.set(w+1,s-1,(-x-A*n.get(w,s-1)+g*n.get(w,s))/M),n.set(w+1,s,(-T-A*n.get(w,s)-g*n.get(w,s-1))/M)):(X=$r(-y-f*n.get(w,s-1),-v-f*n.get(w,s),E,g),n.set(w+1,s-1,X[0]),n.set(w+1,s,X[1]))),R=Math.max(Math.abs(n.get(w,s-1)),Math.abs(n.get(w,s))),l*R*R>1)for(S=w;S<=s;S++)n.set(S,s-1,n.get(S,s-1)/R),n.set(S,s,n.get(S,s)/R)}for(w=0;w<r;w++)if(w<o||w>a)for(S=w;S<r;S++)i.set(w,S,n.get(w,S));for(S=r-1;S>=o;S--)for(w=o;w<=a;w++){for(E=0,d=o;d<=Math.min(S,a);d++)E=E+i.get(w,d)*n.get(d,S);i.set(w,S,E)}}}function $r(r,e,t,i){let n,s;return Math.abs(t)>Math.abs(i)?(n=i/t,s=t+n*i,[(r+n*e)/s,(e-n*r)/s]):(n=t/i,s=i+n*t,[(n*r+e)/s,(n*e-r)/s])}class Ls{constructor(e){if(e=be.checkMatrix(e),!e.isSymmetric())throw new Error("Matrix is not symmetric");let t=e,i=t.rows,n=new C(i,i),s=!0,o,a,l;for(a=0;a<i;a++){let c=0;for(l=0;l<a;l++){let h=0;for(o=0;o<l;o++)h+=n.get(l,o)*n.get(a,o);h=(t.get(a,l)-h)/n.get(l,l),n.set(a,l,h),c=c+h*h}for(c=t.get(a,a)-c,s&=c>0,n.set(a,a,Math.sqrt(Math.max(c,0))),l=a+1;l<i;l++)n.set(a,l,0)}this.L=n,this.positiveDefinite=!!s}isPositiveDefinite(){return this.positiveDefinite}solve(e){e=be.checkMatrix(e);let t=this.L,i=t.rows;if(e.rows!==i)throw new Error("Matrix dimensions do not match");if(this.isPositiveDefinite()===!1)throw new Error("Matrix is not positive definite");let n=e.columns,s=e.clone(),o,a,l;for(l=0;l<i;l++)for(a=0;a<n;a++){for(o=0;o<l;o++)s.set(l,a,s.get(l,a)-s.get(o,a)*t.get(l,o));s.set(l,a,s.get(l,a)/t.get(l,l))}for(l=i-1;l>=0;l--)for(a=0;a<n;a++){for(o=l+1;o<i;o++)s.set(l,a,s.get(l,a)-s.get(o,a)*t.get(o,l));s.set(l,a,s.get(l,a)/t.get(l,l))}return s}get lowerTriangularMatrix(){return this.L}}class js{constructor(e,t={}){e=be.checkMatrix(e);let{Y:i}=t;const{scaleScores:n=!1,maxIterations:s=1e3,terminationCriteria:o=1e-10}=t;let a;if(i){if(we.isAnyArray(i)&&typeof i[0]=="number"?i=C.columnVector(i):i=be.checkMatrix(i),i.rows!==e.rows)throw new Error("Y should have the same number of rows as X");a=i.getColumnVector(0)}else a=e.getColumnVector(0);let l=1,c,h,u,g;for(let y=0;y<s&&l>o;y++)u=e.transpose().mmul(a).div(a.transpose().mmul(a).get(0,0)),u=u.div(u.norm()),c=e.mmul(u).div(u.transpose().mmul(u).get(0,0)),y>0&&(l=c.clone().sub(g).pow(2).sum()),g=c.clone(),i?(h=i.transpose().mmul(c).div(c.transpose().mmul(c).get(0,0)),h=h.div(h.norm()),a=i.mmul(h).div(h.transpose().mmul(h).get(0,0))):a=c;if(i){let y=e.transpose().mmul(c).div(c.transpose().mmul(c).get(0,0));y=y.div(y.norm());let v=e.clone().sub(c.clone().mmul(y.transpose())),E=a.transpose().mmul(c).div(c.transpose().mmul(c).get(0,0)),P=i.clone().sub(c.clone().mulS(E.get(0,0)).mmul(h.transpose()));this.t=c,this.p=y.transpose(),this.w=u.transpose(),this.q=h,this.u=a,this.s=c.transpose().mmul(c),this.xResidual=v,this.yResidual=P,this.betas=E}else this.w=u.transpose(),this.s=c.transpose().mmul(c).sqrt(),n?this.t=c.clone().div(this.s.get(0,0)):this.t=c,this.xResidual=e.sub(c.mmul(u.transpose()))}}q.AbstractMatrix=re,q.CHO=Ls,q.CholeskyDecomposition=Ls,q.DistanceMatrix=Ur,q.EVD=ks,q.EigenvalueDecomposition=ks,q.LU=zr,q.LuDecomposition=zr;var lh=q.Matrix=C;q.MatrixColumnSelectionView=zc,q.MatrixColumnView=Wc,q.MatrixFlipColumnView=Vc,q.MatrixFlipRowView=$c,q.MatrixRowSelectionView=Zc,q.MatrixRowView=qc,q.MatrixSelectionView=Wr,q.MatrixSubView=Xc,q.MatrixTransposeView=Hc,q.NIPALS=js,q.Nipals=js,q.QR=Ni,q.QrDecomposition=Ni,q.SVD=Mt;var ch=q.SingularValueDecomposition=Mt;q.SymmetricMatrix=it,q.WrapperMatrix1D=As,q.WrapperMatrix2D=be,q.correlation=ih,q.covariance=rh;var Os=q.default=C;q.determinant=Vr;var hh=q.inverse=Jc;q.linearDependencies=eh;var uh=q.pseudoInverse=th;q.solve=Cs,q.wrap=Yc;const Ee=lh,dh=ch;Os.Matrix&&Os.Matrix;const fh=hh,Ns=uh;class Qt{sourcePoints;destinationPoints;pointCount;pointCountMinimum;type;constructor(e,t,i,n){if(this.sourcePoints=e,this.destinationPoints=t,this.pointCount=this.sourcePoints.length,this.type=i,this.pointCountMinimum=n,this.pointCount<this.pointCountMinimum)throw new Error("Not enough control points. A "+this.type+" transformation requires a minimum of "+this.pointCountMinimum+" points, but "+this.pointCount+" are given.")}evaluate(e,t="function"){if(t=="function")return this.evaluateFunction(e);if(t=="partialDerivativeX")return this.evaluatePartialDerivativeX(e);if(t=="partialDerivativeY")return this.evaluatePartialDerivativeY(e);throw new Error("Evaluation of type "+t+" not supported")}}class Ds extends Qt{helmertParametersMatrix;helmertParameters;scale;rotation;translation;constructor(e,t){super(e,t,"helmert",2);const i=Ee.columnVector(t.flat()),n=Ee.zeros(2*this.pointCount,4);for(let o=0;o<this.pointCount;o++)n.set(2*o,0,1),n.set(2*o,1,0),n.set(2*o,2,this.sourcePoints[o][0]),n.set(2*o,3,-this.sourcePoints[o][1]),n.set(2*o+1,0,0),n.set(2*o+1,1,1),n.set(2*o+1,2,this.sourcePoints[o][1]),n.set(2*o+1,3,this.sourcePoints[o][0]);const s=Ns(n);this.helmertParametersMatrix=s.mmul(i),this.helmertParameters=this.helmertParametersMatrix.to1DArray(),this.scale=Math.sqrt(this.helmertParameters[2]**2+this.helmertParameters[3]**2),this.rotation=Math.atan2(this.helmertParameters[3],this.helmertParameters[2]),this.translation=[this.helmertParameters[0],this.helmertParameters[1]]}evaluateFunction(e){if(!this.helmertParameters)throw new Error("Helmert parameters not computed");return[this.helmertParameters[0]+this.helmertParameters[2]*e[0]-this.helmertParameters[3]*e[1],this.helmertParameters[1]+this.helmertParameters[2]*e[1]+this.helmertParameters[3]*e[0]]}evaluatePartialDerivativeX(e){if(!this.helmertParameters)throw new Error("Helmert parameters not computed");return[this.helmertParameters[2],this.helmertParameters[3]]}evaluatePartialDerivativeY(e){if(!this.helmertParameters)throw new Error("Helmert parameters not computed");return[-this.helmertParameters[3],this.helmertParameters[2]]}}class ph extends Qt{scale;sourcePointsCenter;destinationPointsCenter;translation;constructor(e,t){super(e,t,"straight",2);const i=new Ds(this.sourcePoints,this.destinationPoints);if(this.scale=i.scale,!this.scale)throw new Error("Scale could not be computed");this.sourcePointsCenter=this.sourcePoints.reduce((s,o)=>[s[0]+o[0],s[1]+o[1]]).map(s=>s/this.pointCount),this.destinationPointsCenter=this.destinationPoints.reduce((s,o)=>[s[0]+o[0],s[1]+o[1]]).map(s=>s/this.pointCount);const n=this.scale;this.translation=this.destinationPointsCenter.map((s,o)=>s-this.sourcePointsCenter[o]*n)}evaluateFunction(e){if(!this.scale||!this.translation)throw new Error("Straight parameters not computed");return[this.translation[0]+this.scale*e[0],this.translation[1]+this.scale*e[1]]}evaluatePartialDerivativeX(e){if(!this.scale||!this.translation)throw new Error("Straight parameters not computed");return[this.scale,0]}evaluatePartialDerivativeY(e){if(!this.scale||!this.translation)throw new Error("Straight parameters not computed");return[0,this.scale]}}class Di extends Qt{polynomialParametersMatrices;polynomialParameters;order;pointCountMinimum;constructor(e,t,i){i=i||1;const n=(i+1)*(i+2)/2;if(super(e,t,"polynomial"+i,n),this.order=i,this.pointCountMinimum=n,this.order<1||this.order>3)throw new Error("Only polynomial transformations of order 1, 2 or 3 are supported");const s=[Ee.columnVector(this.destinationPoints.map(l=>l[0])),Ee.columnVector(this.destinationPoints.map(l=>l[1]))],o=Ee.zeros(this.pointCount,this.pointCountMinimum);for(let l=0;l<this.pointCount;l++)switch(this.order){case 1:o.set(l,0,1),o.set(l,1,this.sourcePoints[l][0]),o.set(l,2,this.sourcePoints[l][1]);break;case 2:o.set(l,0,1),o.set(l,1,this.sourcePoints[l][0]),o.set(l,2,this.sourcePoints[l][1]),o.set(l,3,this.sourcePoints[l][0]**2),o.set(l,4,this.sourcePoints[l][1]**2),o.set(l,5,this.sourcePoints[l][0]*this.sourcePoints[l][1]);break;case 3:o.set(l,0,1),o.set(l,1,this.sourcePoints[l][0]),o.set(l,2,this.sourcePoints[l][1]),o.set(l,3,this.sourcePoints[l][0]**2),o.set(l,4,this.sourcePoints[l][1]**2),o.set(l,5,this.sourcePoints[l][0]*this.sourcePoints[l][1]),o.set(l,6,this.sourcePoints[l][0]**3),o.set(l,7,this.sourcePoints[l][1]**3),o.set(l,8,this.sourcePoints[l][0]**2*this.sourcePoints[l][1]),o.set(l,9,this.sourcePoints[l][0]*this.sourcePoints[l][1]**2);break}const a=Ns(o);this.polynomialParametersMatrices=[a.mmul(s[0]),a.mmul(s[1])],this.polynomialParameters=this.polynomialParametersMatrices.map(l=>l.to1DArray())}evaluateFunction(e){if(!this.polynomialParameters)throw new Error("Polynomial parameters not computed");const t=[0,0];for(let i=0;i<2;i++)switch(this.order){case 1:t[i]+=this.polynomialParameters[i][0]+this.polynomialParameters[i][1]*e[0]+this.polynomialParameters[i][2]*e[1];break;case 2:t[i]+=this.polynomialParameters[i][0]+this.polynomialParameters[i][1]*e[0]+this.polynomialParameters[i][2]*e[1]+this.polynomialParameters[i][3]*e[0]**2+this.polynomialParameters[i][4]*e[1]**2+this.polynomialParameters[i][5]*e[0]*e[1];break;case 3:t[i]+=this.polynomialParameters[i][0]+this.polynomialParameters[i][1]*e[0]+this.polynomialParameters[i][2]*e[1]+this.polynomialParameters[i][3]*e[0]**2+this.polynomialParameters[i][4]*e[1]**2+this.polynomialParameters[i][5]*e[0]*e[1]+this.polynomialParameters[i][6]*e[0]**3+this.polynomialParameters[i][7]*e[1]**3+this.polynomialParameters[i][8]*e[0]**2*e[1]+this.polynomialParameters[i][9]*e[0]*e[1]**2;break}return t}evaluatePartialDerivativeX(e){if(!this.polynomialParameters)throw new Error("Polynomial parameters not computed");const t=[0,0];for(let i=0;i<2;i++)switch(this.order){case 1:t[i]+=this.polynomialParameters[i][1];break;case 2:t[i]+=this.polynomialParameters[i][1]+2*this.polynomialParameters[i][3]*e[0]+this.polynomialParameters[i][5]*e[1];break;case 3:t[i]+=this.polynomialParameters[i][1]+2*this.polynomialParameters[i][3]*e[0]+this.polynomialParameters[i][5]*e[1]+3*this.polynomialParameters[i][6]*e[0]**2+2*this.polynomialParameters[i][8]*e[0]*e[1]+this.polynomialParameters[i][9]*e[1]**2;break}return t}evaluatePartialDerivativeY(e){if(!this.polynomialParameters)throw new Error("Polynomial parameters not computed");const t=[0,0];for(let i=0;i<2;i++)switch(this.order){case 1:t[i]+=this.polynomialParameters[i][2];break;case 2:t[i]+=this.polynomialParameters[i][2]+2*this.polynomialParameters[i][4]*e[1]+this.polynomialParameters[i][5]*e[0];break;case 3:t[i]+=this.polynomialParameters[i][2]+2*this.polynomialParameters[i][4]*e[1]+this.polynomialParameters[i][5]*e[0]+3*this.polynomialParameters[i][7]*e[1]**2+this.polynomialParameters[i][8]*e[0]**2+2*this.polynomialParameters[i][9]*e[0]*e[1];break}return t}}class gh extends Qt{projectiveParametersMatrix;projectiveParameters;constructor(e,t){super(e,t,"projective",4);const i=Ee.zeros(2*this.pointCount,9);for(let s=0;s<this.pointCount;s++)i.set(2*s,0,-e[s][0]),i.set(2*s,1,-e[s][1]),i.set(2*s,2,-1),i.set(2*s,3,0),i.set(2*s,4,0),i.set(2*s,5,0),i.set(2*s,6,t[s][0]*e[s][0]),i.set(2*s,7,t[s][0]*e[s][1]),i.set(2*s,8,t[s][0]),i.set(2*s+1,0,0),i.set(2*s+1,1,0),i.set(2*s+1,2,0),i.set(2*s+1,3,-e[s][0]),i.set(2*s+1,4,-e[s][1]),i.set(2*s+1,5,-1),i.set(2*s+1,6,t[s][1]*e[s][0]),i.set(2*s+1,7,t[s][1]*e[s][1]),i.set(2*s+1,8,t[s][1]);const n=new dh(i);this.projectiveParametersMatrix=Ee.from1DArray(3,3,n.rightSingularVectors.getColumn(8)).transpose(),this.projectiveParameters=this.projectiveParametersMatrix.to2DArray()}evaluateFunction(e){if(!this.projectiveParameters)throw new Error("projective parameters not computed");const t=this.projectiveParameters[0][2]*e[0]+this.projectiveParameters[1][2]*e[1]+this.projectiveParameters[2][2],i=this.projectiveParameters[0][0]*e[0]+this.projectiveParameters[1][0]*e[1]+this.projectiveParameters[2][0],n=this.projectiveParameters[0][1]*e[0]+this.projectiveParameters[1][1]*e[1]+this.projectiveParameters[2][1];return[i/t,n/t]}evaluatePartialDerivativeX(e){if(!this.projectiveParameters)throw new Error("projective parameters not computed");const t=this.projectiveParameters[0][2]*e[0]+this.projectiveParameters[1][2]*e[1]+this.projectiveParameters[2][2],i=this.projectiveParameters[0][0]*e[0]+this.projectiveParameters[1][0]*e[1]+this.projectiveParameters[2][0],n=this.projectiveParameters[0][1]*e[0]+this.projectiveParameters[1][1]*e[1]+this.projectiveParameters[2][1];return[(t*this.projectiveParameters[0][0]-this.projectiveParameters[0][2]*i)/t**2,(t*this.projectiveParameters[0][1]-this.projectiveParameters[0][2]*n)/t**2]}evaluatePartialDerivativeY(e){if(!this.projectiveParameters)throw new Error("projective parameters not computed");const t=this.projectiveParameters[0][2]*e[0]+this.projectiveParameters[1][2]*e[1]+this.projectiveParameters[2][2],i=this.projectiveParameters[0][0]*e[0]+this.projectiveParameters[1][0]*e[1]+this.projectiveParameters[2][0],n=this.projectiveParameters[0][1]*e[0]+this.projectiveParameters[1][1]*e[1]+this.projectiveParameters[2][1];return[(t*this.projectiveParameters[1][0]-this.projectiveParameters[1][2]*i)/t**2,(t*this.projectiveParameters[1][1]-this.projectiveParameters[1][2]*n)/t**2]}}class mh extends Qt{kernelFunction;normFunction;weightsMatrices;rbfWeights;affineWeights;epsilon;constructor(e,t,i,n,s){super(e,t,"thinPlateSpline",3),this.kernelFunction=i,this.normFunction=n;const o=[Ee.columnVector([...this.destinationPoints,[0,0],[0,0],[0,0]].map(u=>u[0])),Ee.columnVector([...this.destinationPoints,[0,0],[0,0],[0,0]].map(u=>u[1]))],a=Ee.zeros(this.pointCount,this.pointCount);for(let u=0;u<this.pointCount;u++)for(let g=0;g<this.pointCount;g++)a.set(u,g,n(this.sourcePoints[u],this.sourcePoints[g]));s===void 0&&(s=a.sum()/(Math.pow(this.pointCount,2)-this.pointCount)),this.epsilon=s;for(let u=0;u<this.pointCount;u++)for(let g=0;g<this.pointCount;g++)a.set(u,g,i(a.get(u,g),{epsilon:s}));const l=Ee.zeros(this.pointCount,3),c=Ee.zeros(this.pointCount+3,this.pointCount+3);for(let u=0;u<this.pointCount;u++)l.set(u,0,1),l.set(u,1,this.sourcePoints[u][0]),l.set(u,2,this.sourcePoints[u][1]);for(let u=0;u<this.pointCount+3;u++)for(let g=0;g<this.pointCount+3;g++)u<this.pointCount&&g<this.pointCount?c.set(u,g,a.get(u,g)):u>=this.pointCount&&g<this.pointCount?c.set(u,g,l.transpose().get(u-this.pointCount,g)):u<this.pointCount&&g>=this.pointCount&&c.set(u,g,l.get(u,g-this.pointCount));const h=fh(c);this.weightsMatrices=[h.mmul(o[0]),h.mmul(o[1])],this.rbfWeights=this.weightsMatrices.map(u=>u.selection([...Array(this.pointCount).keys()],[0]).to1DArray()),this.affineWeights=this.weightsMatrices.map(u=>u.selection([0,1,2].map(g=>g+this.pointCount),[0]).to1DArray())}evaluateFunction(e){if(!this.rbfWeights||!this.affineWeights)throw new Error("Weights not computed");const t=this.sourcePoints.map(n=>this.normFunction(e,n)),i=[0,0];for(let n=0;n<2;n++)i[n]=t.reduce((s,o,a)=>s+this.kernelFunction(o,{epsilon:this.epsilon})*this.rbfWeights[n][a],0),i[n]+=this.affineWeights[n][0]+this.affineWeights[n][1]*e[0]+this.affineWeights[n][2]*e[1];return i}evaluatePartialDerivativeX(e){if(!this.rbfWeights||!this.affineWeights)throw new Error("Weights not computed");const t=this.sourcePoints.map(n=>this.normFunction(e,n)),i=[0,0];for(let n=0;n<2;n++)i[n]=t.reduce((s,o,a)=>s+(o==0?0:this.kernelFunction(o,{derivative:1,epsilon:this.epsilon})*((e[0]-this.sourcePoints[a][0])/o)*this.rbfWeights[n][a]),0),i[n]+=this.affineWeights[n][1];return i}evaluatePartialDerivativeY(e){if(!this.rbfWeights||!this.affineWeights)throw new Error("Weights not computed");const t=this.sourcePoints.map(n=>this.normFunction(e,n)),i=[0,0];for(let n=0;n<2;n++)i[n]=t.reduce((s,o,a)=>s+(o==0?0:this.kernelFunction(o,{derivative:1,epsilon:this.epsilon})*((e[1]-this.sourcePoints[a][1])/o)*this.rbfWeights[n][a]),0),i[n]+=this.affineWeights[n][2];return i}}function vh(r,e){if(e.derivative){if(e.derivative==1)return r===0?0:r+2*r*Math.log(r);throw new Error("Derivate of order "+e.derivative+" not implemented")}else return r===0?0:Math.pow(r,2)*Math.log(r)}function yh(r,e){const t=[e[0]-r[0],e[1]-r[1]];return Math.sqrt(t[0]**2+t[1]**2)}function K(r,e,t){return{maxOffsetRatio:0,maxDepth:0,destinationIsGeographic:!1,sourceIsGeographic:!1,inputIsMultiGeometry:!1,differentHandedness:!1,evaluationType:"function",...t,...e,...r}}function qr(r,e,t){e=lr(e);const i=e.map(o=>({source:o,destination:r.transformForward(o)})),n=Yr(i,!1),s=Fs(r,n,t);return Jr(s,!0).map(o=>o.destination)}function Zr(r,e,t){e=lr(e);const i=e.map(o=>({source:r.transformBackward(o),destination:o})),n=Yr(i,!1),s=Gs(r,n,t);return Jr(s,!0).map(o=>o.source)}function wh(r,e,t){e=pi(e);const i=e.map(o=>({source:o,destination:r.transformForward(o)})),n=Yr(i,!0),s=Fs(r,n,t);return Jr(s,!1).map(o=>o.destination)}function xh(r,e,t){e=pi(e);const i=e.map(o=>({source:r.transformBackward(o),destination:o})),n=Yr(i,!0),s=Gs(r,n,t);return Jr(s,!1).map(o=>o.source)}function Xr(r,e,t){return e.map(i=>wh(r,i,t))}function Hr(r,e,t){return e.map(i=>xh(r,i,t))}function Yr(r,e=!1){const t=r.length-(e?0:1),i=[];for(let n=0;n<t;n++)i.push({from:r[n],to:r[(n+1)%r.length]});return i}function Jr(r,e=!1){const t=r.map(i=>i.from);return e&&t.push(r[r.length-1].to),t}function Fs(r,e,t){return t.maxDepth<=0?e:e.map(i=>Fi(r,i,t,0)).flat(1)}function Gs(r,e,t){return t.maxDepth<=0?e:e.map(i=>Gi(r,i,t,0)).flat(1)}function Fi(r,e,t,i){if(i>=t.maxDepth)return e;const n=(t.sourceIsGeographic?(c,h)=>Dr(c,h).geometry.coordinates:dr)(e.from.source,e.to.source),s=(t.destinationIsGeographic?(c,h)=>Dr(c,h).geometry.coordinates:dr)(e.from.destination,e.to.destination),o=r.transformForward(n),a=t.destinationIsGeographic?ki:xe,l=a(e.from.destination,e.to.destination);if(a(s,o)/l>t.maxOffsetRatio&&l>0){const c={source:n,destination:o};return[Fi(r,{from:e.from,to:c},t,i+1),Fi(r,{from:c,to:e.to},t,i+1)].flat(1)}else return e}function Gi(r,e,t,i){if(i>=t.maxDepth)return e;const n=(t.destinationIsGeographic?(c,h)=>Dr(c,h).geometry.coordinates:dr)(e.from.destination,e.to.destination),s=(t.sourceIsGeographic?(c,h)=>Dr(c,h).geometry.coordinates:dr)(e.from.source,e.to.source),o=r.transformBackward(n),a=t.sourceIsGeographic?ki:xe,l=a(e.from.source,e.to.source);if(a(s,o)/l>t.maxOffsetRatio&&l>0){const c={source:o,destination:n};return[Gi(r,{from:e.from,to:c},t,i+1),Gi(r,{from:c,to:e.to},t,i+1)].flat(1)}else return e}class Bi{gcps;sourcePoints;destinationPoints;type;options;forwardTransformation;backwardTransformation;constructor(e,t="polynomial",i){if(i&&(this.options=i),e.length===0)throw new Error("No control points");this.gcps=e.map(n=>{if("resource"in n&&"geo"in n)return{source:n.resource,destination:n.geo};if("source"in n&&"destination"in n)return n;throw new Error("Unsupported GCP type")}),this.sourcePoints=this.gcps.map(n=>n.source),this.destinationPoints=this.gcps.map(n=>n.destination),this.type=t}createForwardTransformation(){this.forwardTransformation=this.computeTransformation(this.sourcePoints.map(e=>this.assureEqualHandedness(e)),this.destinationPoints)}createBackwardTransformation(){this.backwardTransformation=this.computeTransformation(this.destinationPoints,this.sourcePoints.map(e=>this.assureEqualHandedness(e)))}transformForward(e,t){if(!K(t,this.options).inputIsMultiGeometry){if(pe(e))return this.forwardTransformation||this.createForwardTransformation(),this.forwardTransformation.evaluate(this.assureEqualHandedness(e),K(t,this.options).evaluationType);if(Ue(e))return this.transformForward(At(e),t);if(Se(e))return qr(this,e,K(t,this.options));if(We(e))return qr(this,Ct(e),K(t,this.options,{sourceIsGeographic:!0}));if(Re(e))return Xr(this,e,K(t,this.options));if(ze(e))return Xr(this,kt(e),K(t,this.options,{sourceIsGeographic:!0}))}if(t&&(t.inputIsMultiGeometry=!1),Fe(e))return e.map(i=>this.transformForward(i,t));if(Ve(e))return fr(e).map(i=>this.transformForward(i,t));if(Ge(e))return e.map(i=>this.transformForward(i,t));if($e(e))return pr(e).map(i=>this.transformForward(i,t));if(Be(e))return e.map(i=>this.transformForward(i,t));if(qe(e))return gr(e).map(i=>this.transformForward(i,t));throw new Error("Input type not supported")}transformForwardAsGeojson(e,t){if(!K(t,this.options).inputIsMultiGeometry){if(pe(e))return cr(this.transformForward(e));if(Ue(e))return cr(this.transformForward(At(e)));if(Se(e))return hr(qr(this,e,K(t,this.options,{destinationIsGeographic:!0})));if(We(e))return hr(qr(this,Ct(e),K(t,this.options,{sourceIsGeographic:!0,destinationIsGeographic:!0})));if(Re(e))return ur(Xr(this,e,K(t,this.options,{destinationIsGeographic:!0})));if(ze(e))return ur(Xr(this,kt(e),K(t,this.options,{sourceIsGeographic:!0,destinationIsGeographic:!0})))}if(t&&(t.inputIsMultiGeometry=!1),Fe(e))return mr(e.map(i=>this.transformForwardAsGeojson(i,t)));if(Ve(e))return mr(fr(e).map(i=>this.transformForwardAsGeojson(i,t)));if(Ge(e))return vr(e.map(i=>this.transformForwardAsGeojson(i,t)));if($e(e))return vr(pr(e).map(i=>this.transformForwardAsGeojson(i,t)));if(Be(e))return yr(e.map(i=>this.transformForwardAsGeojson(i,t)));if(qe(e))return yr(gr(e).map(i=>this.transformForwardAsGeojson(i,t)));throw new Error("Input type not supported")}transformBackward(e,t){if(!K(t,this.options).inputIsMultiGeometry){if(pe(e))return this.backwardTransformation||this.createBackwardTransformation(),this.assureEqualHandedness(this.backwardTransformation.evaluate(e));if(Ue(e))return this.transformBackward(At(e));if(Se(e))return Zr(this,e,K(t,this.options));if(We(e))return Zr(this,Ct(e),K(t,this.options,{destinationIsGeographic:!0}));if(Re(e))return Hr(this,e,K(t,this.options));if(ze(e))return Hr(this,kt(e),K(t,this.options,{destinationIsGeographic:!0}))}if(t&&(t.inputIsMultiGeometry=!1),Fe(e))return e.map(i=>this.transformBackward(i,t));if(Ve(e))return fr(e).map(i=>this.transformBackward(i,t));if(Ge(e))return e.map(i=>this.transformBackward(i,t));if($e(e))return pr(e).map(i=>this.transformBackward(i,t));if(Be(e))return e.map(i=>this.transformBackward(i,t));if(qe(e))return gr(e).map(i=>this.transformBackward(i,t));throw new Error("Input type not supported")}transformBackwardAsGeojson(e,t){if(!K(t,this.options).inputIsMultiGeometry){if(pe(e))return cr(this.transformBackward(e));if(Ue(e))return cr(this.transformBackward(At(e)));if(Se(e))return hr(Zr(this,e,K(t,this.options,{sourceIsGeographic:!0})));if(We(e))return hr(Zr(this,Ct(e),K(t,this.options,{sourceIsGeographic:!0,destinationIsGeographic:!0})));if(Re(e))return ur(Hr(this,e,K(t,this.options,{sourceIsGeographic:!0})));if(ze(e))return ur(Hr(this,kt(e),K(t,this.options,{sourceIsGeographic:!0,destinationIsGeographic:!0})))}if(t&&(t.inputIsMultiGeometry=!1),Fe(e))return mr(e.map(i=>this.transformBackwardAsGeojson(i,t)));if(Ve(e))return mr(fr(e).map(i=>this.transformBackwardAsGeojson(i,t)));if(Ge(e))return vr(e.map(i=>this.transformBackwardAsGeojson(i,t)));if($e(e))return vr(pr(e).map(i=>this.transformBackwardAsGeojson(i,t)));if(Be(e))return yr(e.map(i=>this.transformBackwardAsGeojson(i,t)));if(qe(e))return yr(gr(e).map(i=>this.transformBackwardAsGeojson(i,t)));throw new Error("Input type not supported")}transformToGeo(e,t){if(!K(t,this.options).inputIsMultiGeometry){if(pe(e))return this.transformForward(e,t);if(Ue(e))return this.transformForward(e,t);if(Se(e))return this.transformForward(e,t);if(We(e))return this.transformForward(e,t);if(Re(e))return this.transformForward(e,t);if(ze(e))return this.transformForward(e,t)}if(t&&(t.inputIsMultiGeometry=!1),Fe(e))return this.transformForward(e,t);if(Ve(e))return this.transformForward(e,t);if(Ge(e))return this.transformForward(e,t);if($e(e))return this.transformForward(e,t);if(Be(e))return this.transformForward(e,t);if(qe(e))return this.transformForward(e,t);throw new Error("Input type not supported")}transformToGeoAsGeojson(e,t){if(!K(t,this.options).inputIsMultiGeometry){if(pe(e))return this.transformForwardAsGeojson(e,t);if(Ue(e))return this.transformForwardAsGeojson(e,t);if(Se(e))return this.transformForwardAsGeojson(e,t);if(We(e))return this.transformForwardAsGeojson(e,t);if(Re(e))return this.transformForwardAsGeojson(e,t);if(ze(e))return this.transformForwardAsGeojson(e,t)}if(t&&(t.inputIsMultiGeometry=!1),Fe(e))return this.transformForwardAsGeojson(e,t);if(Ve(e))return this.transformForwardAsGeojson(e,t);if(Ge(e))return this.transformForwardAsGeojson(e,t);if($e(e))return this.transformForwardAsGeojson(e,t);if(Be(e))return this.transformForwardAsGeojson(e,t);if(qe(e))return this.transformForwardAsGeojson(e,t);throw new Error("Input type not supported")}transformToResource(e,t){if(!K(t,this.options).inputIsMultiGeometry){if(pe(e))return this.transformBackward(e,t);if(Ue(e))return this.transformBackward(e,t);if(Se(e))return this.transformBackward(e,t);if(We(e))return this.transformBackward(e,t);if(Re(e))return this.transformBackward(e,t);if(ze(e))return this.transformBackward(e,t)}if(t&&(t.inputIsMultiGeometry=!1),Fe(e))return this.transformBackward(e,t);if(Ve(e))return this.transformBackward(e,t);if(Ge(e))return this.transformBackward(e,t);if($e(e))return this.transformBackward(e,t);if(Be(e))return this.transformBackward(e,t);if(qe(e))return this.transformBackward(e,t);throw new Error("Input type not supported")}transformToResourceAsGeojson(e,t){if(!K(t,this.options).inputIsMultiGeometry){if(pe(e))return this.transformBackwardAsGeojson(e,t);if(Ue(e))return this.transformBackwardAsGeojson(e,t);if(Se(e))return this.transformBackwardAsGeojson(e,t);if(We(e))return this.transformBackwardAsGeojson(e,t);if(Re(e))return this.transformBackwardAsGeojson(e,t);if(ze(e))return this.transformBackwardAsGeojson(e,t)}if(t&&(t.inputIsMultiGeometry=!1),Fe(e))return this.transformBackwardAsGeojson(e,t);if(Ve(e))return this.transformBackwardAsGeojson(e,t);if(Ge(e))return this.transformBackwardAsGeojson(e,t);if($e(e))return this.transformBackwardAsGeojson(e,t);if(Be(e))return this.transformBackwardAsGeojson(e,t);if(qe(e))return this.transformBackwardAsGeojson(e,t);throw new Error("Input type not supported")}transformSvgToGeojson(e,t){if(e.type==="circle")return this.transformForwardAsGeojson(e.coordinates);if(e.type==="line")return this.transformForwardAsGeojson(e.coordinates,t);if(e.type==="polyline")return this.transformForwardAsGeojson(e.coordinates,t);if(e.type==="rect")return this.transformForwardAsGeojson([e.coordinates],t);if(e.type==="polygon")return this.transformForwardAsGeojson([e.coordinates],t);throw new Error("Unsupported SVG geometry")}transformSvgStringToGeojsonFeatureCollection(e,t){const i=[];for(const n of Ta(e)){const s=this.transformSvgToGeojson(n,t);i.push(s)}return ha(i)}transformGeojsonToSvg(e,t){if(e.type==="Point")return{type:"circle",coordinates:this.transformBackward(e)};if(e.type==="LineString")return{type:"polyline",coordinates:this.transformBackward(e,t)};if(e.type==="Polygon")return{type:"polygon",coordinates:this.transformBackward(e,t)[0]};throw new Error("Unsupported GeoJSON geometry")}transformGeojsonFeatureCollectionToSvgString(e,t){const i=[];for(const n of da(e)){const s=this.transformGeojsonToSvg(n,t);i.push(s)}return Pa(i)}assureEqualHandedness(e){return this.options?.differentHandedness?ea(e):e}computeTransformation(e,t){if(this.type==="straight")return new ph(e,t);if(this.type==="helmert")return new Ds(e,t);if(this.type==="polynomial1"||this.type==="polynomial")return new Di(e,t);if(this.type==="polynomial2")return new Di(e,t,2);if(this.type==="polynomial3")return new Di(e,t,3);if(this.type==="projective")return new gh(e,t);if(this.type==="thinPlateSpline")return new mh(e,t,vh,yh);throw new Error(`Unsupported transformation type: ${this.type}`)}}const Bs=["log2sigma","twoOmega","airyKavr","signDetJ","thetaa"];function _h(r,e,t,i=1){if(!t)return 0;const n=r[0]**2+r[1]**2,s=e[0]**2+e[1]**2,o=r[0]*e[0]+r[1]*e[1],a=Math.sqrt(.5*(n+s+Math.sqrt((n-s)**2+4*o**2))),l=Math.sqrt(.5*(n+s-Math.sqrt((n-s)**2+4*o**2))),c=Math.atan(r[1]/r[0]),h=Math.sign(-o)*Math.asin(Math.sqrt((1-a**2/n)/(1-(a/l)**2)));switch(Bs.indexOf(t)){case 0:return(Math.log(a*l)-2*Math.log(i))/Math.log(2);case 1:return 2*Math.asin((a-l)/(a+l));case 2:return .5*(Math.log(a/i)**2+Math.log(l/i)**2);case 3:return Math.sign(r[0]*e[1]-r[1]*e[0]);case 4:return c-h;default:throw new Error("Distortion "+t+" not supported")}}var k=(r=>(r.GEOREFERENCEANNOTATIONADDED="georeferenceannotationadded",r.GEOREFERENCEANNOTATIONREMOVED="georeferenceannotationremoved",r.WARPEDMAPADDED="warpedmapadded",r.WARPEDMAPREMOVED="warpedmapremoved",r.WARPEDMAPENTER="warpedmapenter",r.WARPEDMAPLEAVE="warpedmapleave",r.IMAGEINFOLOADED="imageinfoloaded",r.TILEFETCHED="tilefetched",r.TILEFETCHERROR="tilefetcherror",r.MAPTILELOADED="maptileloaded",r.MAPTILEREMOVED="maptileremoved",r.FIRSTMAPTILELOADED="firstmaptileloaded",r.ALLREQUESTEDTILESLOADED="allrequestedtilesloaded",r.TEXTURESUPDATED="texturesupdated",r.ZINDICESCHANGES="zindiceschanged",r.RESOURCEMASKUPDATED="resourcemaskupdated",r.VISIBILITYCHANGED="visibilitychanged",r.TRANSFORMATIONCHANGED="transformationchanged",r.DISTORTIONCHANGED="distortionchanged",r.CHANGED="changed",r.CLEARED="cleared",r))(k||{});let U=class extends Event{data;constructor(e,t){super(e),this.data=t}};const Ui={maxOffsetRatio:.05,maxDepth:2,differentHandedness:!0},Us=!0;function bh(){return{visible:Us}}class Mh extends EventTarget{mapId;georeferencedMap;gcps;projectedGcps;resourceMask;resourceMaskBbox;resourceMaskRectangle;resourceFullMask;resourceFullMaskBbox;resourceFullMaskRectangle;imageInformations;imageId;parsedImage;loadingImageInfo;fetchFn;visible;transformationType;transformer;projectedTransformer;transformerByTransformationType=new Map;projectedTransformerByTransformationType=new Map;geoMask;geoMaskBbox;geoMaskRectangle;geoFullMask;geoFullMaskBbox;geoFullMaskRectangle;projectedGeoMask;projectedGeoMaskBbox;projectedGeoMaskRectangle;projectedGeoFullMask;projectedGeoFullMaskBbox;projectedGeoFullMaskRectangle;resourceToProjectedGeoScale;distortionMeasure;bestScaleFactor;resourceViewportRing=[];resourceViewportRingBbox;constructor(e,t,i){super(),i={...bh(),...i},this.mapId=e,this.georeferencedMap=t,this.gcps=this.georeferencedMap.gcps,this.projectedGcps=this.gcps.map(({resource:n,geo:s})=>({resource:n,geo:Ra(s)})),this.resourceMask=this.georeferencedMap.resourceMask,this.updateResourceMaskProperties(),this.resourceFullMask=[[0,0],[this.georeferencedMap.resource.width,0],[this.georeferencedMap.resource.width,this.georeferencedMap.resource.height],[0,this.georeferencedMap.resource.height]],this.resourceFullMaskBbox=ue(this.resourceFullMask),this.resourceFullMaskRectangle=wr(this.resourceFullMaskBbox),this.imageInformations=i.imageInformations,this.loadingImageInfo=!1,this.visible=i.visible||Us,this.fetchFn=i.fetchFn,this.transformationType=i.transformation?.type||this.georeferencedMap.transformation?.type||"polynomial",this.updateTransformerProperties()}getViewportMask(e){return this.projectedGeoMask.map(t=>ut(e.projectedGeoToViewportTransform,t))}getViewportMaskBbox(e){return ue(this.getViewportMask(e))}getViewportMaskRectangle(e){return this.projectedGeoMaskRectangle.map(t=>ut(e.projectedGeoToViewportTransform,t))}getViewportFullMask(e){return this.projectedGeoFullMask.map(t=>ut(e.projectedGeoToViewportTransform,t))}getViewportFullMaskBbox(e){return ue(this.getViewportFullMask(e))}getViewportFullMaskRectangle(e){return this.projectedGeoFullMaskRectangle.map(t=>ut(e.projectedGeoToViewportTransform,t))}getResourceToViewportScale(e){return Pn(this.resourceMaskRectangle,this.getViewportMaskRectangle(e))}getResourceToCanvasScale(e){return this.getResourceToViewportScale(e)/e.devicePixelRatio}getReferenceScale(){const e=_r(this.projectedTransformerByTransformationType,"helmert",()=>new Bi(this.projectedGcps,"helmert",Ui));return e.forwardTransformation||e.createForwardTransformation(),e.forwardTransformation.scale}setResourceViewportRing(e){this.resourceViewportRing=e,this.resourceViewportRingBbox=ue(e)}setResourceMask(e){this.resourceMask=e,this.updateResourceMaskProperties(),this.updateGeoMask(),this.updateProjectedGeoMask(),this.updateResourceToProjectedGeoScale()}setTransformationType(e){this.transformationType=e,this.updateTransformerProperties()}setDistortionMeasure(e){this.distortionMeasure=e}setGcps(e){this.gcps=e,this.updateTransformerProperties(!1)}setBestScaleFactor(e){const t=this.bestScaleFactor!=e;return t&&(this.bestScaleFactor=e),t}hasImageInfo(){return this.imageId!==void 0&&this.parsedImage!==void 0}async loadImageInfo(){try{this.loadingImageInfo=!0;const e=this.georeferencedMap.resource.id;let t;this.imageInformations?.get(e)?t=this.imageInformations.get(e):(t=await Xo(e,void 0,this.fetchFn),this.imageInformations?.set(e,t)),this.parsedImage=Ai.parse(t),this.imageId=await Ln(e),this.dispatchEvent(new U(k.IMAGEINFOLOADED))}catch(e){throw this.loadingImageInfo=!1,e}finally{this.loadingImageInfo=!1}}dispose(){}updateResourceMaskProperties(){this.resourceMaskBbox=ue(this.resourceMask),this.resourceMaskRectangle=wr(this.resourceMaskBbox)}updateTransformerProperties(e=!0){this.updateTransformer(e),this.updateProjectedTransformer(e),this.updateGeoMask(),this.updateFullGeoMask(),this.updateProjectedGeoMask(),this.updateProjectedFullGeoMask(),this.updateResourceToProjectedGeoScale()}updateTransformer(e=!0){this.transformer=_r(this.transformerByTransformationType,this.transformationType,()=>new Bi(this.gcps,this.transformationType,Ui),e)}updateProjectedTransformer(e=!0){this.projectedTransformer=_r(this.projectedTransformerByTransformationType,this.transformationType,()=>new Bi(this.projectedGcps,this.transformationType,Ui),e)}updateGeoMask(){this.geoMask=this.transformer.transformForwardAsGeojson([this.resourceMask]),this.geoMaskBbox=ue(this.geoMask),this.geoMaskRectangle=this.transformer.transformForward([this.resourceMaskRectangle],{maxDepth:0})[0]}updateFullGeoMask(){this.geoFullMask=this.transformer.transformForwardAsGeojson([this.resourceFullMask]),this.geoFullMaskBbox=ue(this.geoFullMask),this.geoFullMaskRectangle=this.transformer.transformForward([this.resourceFullMaskRectangle],{maxDepth:0})[0]}updateProjectedGeoMask(){this.projectedGeoMask=this.projectedTransformer.transformForward([this.resourceMask])[0],this.projectedGeoMaskBbox=ue(this.projectedGeoMask),this.projectedGeoMaskRectangle=this.projectedTransformer.transformForward([this.resourceMaskRectangle],{maxDepth:0})[0]}updateProjectedFullGeoMask(){this.projectedGeoFullMask=this.projectedTransformer.transformForward([this.resourceFullMask])[0],this.projectedGeoFullMaskBbox=ue(this.projectedGeoFullMask),this.projectedGeoFullMaskRectangle=this.projectedTransformer.transformForward([this.resourceFullMaskRectangle],{maxDepth:0})[0]}updateResourceToProjectedGeoScale(){this.resourceToProjectedGeoScale=Pn(this.resourceMaskRectangle,this.projectedGeoMaskRectangle)}}function Th(r){return Math.sqrt(Math.pow(r[1][0]-r[0][0],2)+Math.pow(r[1][1]-r[0][1],2))}function Eh(r){return Math.atan2(r[1][1]-r[0][1],r[1][0]-r[0][0])}function Ph(r,e,t){return[r[0]+Math.cos(t)*e,r[1]+Math.sin(t)*e]}function Sh(r,e){let t=r[0];const i=[t];for(;Th([t,r[1]])>e;){const n=Ph(t,e,Eh(r));i.push(n),t=n}return i}function Rh(r,e){r=[...r,r[0]];let t=[];for(let i=0;i<r.length-1;i++)t=t.concat(Sh([r[i],r[i+1]],e));return t}function Ih(r,e){const t=[],i=ue(r);for(let n=i[0]+e,s=0;n<=i[2];s++,n+=e)for(let o=i[1]+e,a=0;o<=i[3];a++,o+=e)t.push([n,o]);return t}function Ah(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var Ws={exports:{}},zs=Ch,Vs=+(Math.pow(2,27)+1);function Ch(r,e,t){var i=r*e,n=Vs*r,s=n-r,o=n-s,a=r-o,l=Vs*e,c=l-e,h=l-c,u=e-h,g=i-o*h,y=g-a*h,v=y-o*u,E=a*u-v;return t?(t[0]=E,t[1]=i,t):[E,i]}var kh=jh;function Lh(r,e){var t=r+e,i=t-r,n=t-i,s=e-i,o=r-n,a=o+s;return a?[a,t]:[t]}function jh(r,e){var t=r.length|0,i=e.length|0;if(t===1&&i===1)return Lh(r[0],e[0]);var n=t+i,s=new Array(n),o=0,a=0,l=0,c=Math.abs,h=r[a],u=c(h),g=e[l],y=c(g),v,E;u<y?(E=h,a+=1,a<t&&(h=r[a],u=c(h))):(E=g,l+=1,l<i&&(g=e[l],y=c(g))),a<t&&u<y||l>=i?(v=h,a+=1,a<t&&(h=r[a],u=c(h))):(v=g,l+=1,l<i&&(g=e[l],y=c(g)));for(var P=v+E,w=P-v,S=E-w,d=S,p=P,_,R,A,M,f;a<t&&l<i;)u<y?(v=h,a+=1,a<t&&(h=r[a],u=c(h))):(v=g,l+=1,l<i&&(g=e[l],y=c(g))),E=d,P=v+E,w=P-v,S=E-w,S&&(s[o++]=S),_=p+P,R=_-p,A=_-R,M=P-R,f=p-A,d=f+M,p=_;for(;a<t;)v=h,E=d,P=v+E,w=P-v,S=E-w,S&&(s[o++]=S),_=p+P,R=_-p,A=_-R,M=P-R,f=p-A,d=f+M,p=_,a+=1,a<t&&(h=r[a]);for(;l<i;)v=g,E=d,P=v+E,w=P-v,S=E-w,S&&(s[o++]=S),_=p+P,R=_-p,A=_-R,M=P-R,f=p-A,d=f+M,p=_,l+=1,l<i&&(g=e[l]);return d&&(s[o++]=d),p&&(s[o++]=p),o||(s[o++]=0),s.length=o,s}var Oh=Nh;function Nh(r,e,t){var i=r+e,n=i-r,s=i-n,o=e-n,a=r-s;return t?(t[0]=a+o,t[1]=i,t):[a+o,i]}var Wi=zs,Dh=Oh,Fh=Gh;function Gh(r,e){var t=r.length;if(t===1){var i=Wi(r[0],e);return i[0]?i:[i[1]]}var n=new Array(2*t),s=[.1,.1],o=[.1,.1],a=0;Wi(r[0],e,s),s[0]&&(n[a++]=s[0]);for(var l=1;l<t;++l){Wi(r[l],e,o);var c=s[1];Dh(c,o[0],s),s[0]&&(n[a++]=s[0]);var h=o[1],u=s[1],g=h+u,y=g-h,v=u-y;s[1]=g,v&&(n[a++]=v)}return s[1]&&(n[a++]=s[1]),a===0&&(n[a++]=0),n.length=a,n}var Bh=Wh;function Uh(r,e){var t=r+e,i=t-r,n=t-i,s=e-i,o=r-n,a=o+s;return a?[a,t]:[t]}function Wh(r,e){var t=r.length|0,i=e.length|0;if(t===1&&i===1)return Uh(r[0],-e[0]);var n=t+i,s=new Array(n),o=0,a=0,l=0,c=Math.abs,h=r[a],u=c(h),g=-e[l],y=c(g),v,E;u<y?(E=h,a+=1,a<t&&(h=r[a],u=c(h))):(E=g,l+=1,l<i&&(g=-e[l],y=c(g))),a<t&&u<y||l>=i?(v=h,a+=1,a<t&&(h=r[a],u=c(h))):(v=g,l+=1,l<i&&(g=-e[l],y=c(g)));for(var P=v+E,w=P-v,S=E-w,d=S,p=P,_,R,A,M,f;a<t&&l<i;)u<y?(v=h,a+=1,a<t&&(h=r[a],u=c(h))):(v=g,l+=1,l<i&&(g=-e[l],y=c(g))),E=d,P=v+E,w=P-v,S=E-w,S&&(s[o++]=S),_=p+P,R=_-p,A=_-R,M=P-R,f=p-A,d=f+M,p=_;for(;a<t;)v=h,E=d,P=v+E,w=P-v,S=E-w,S&&(s[o++]=S),_=p+P,R=_-p,A=_-R,M=P-R,f=p-A,d=f+M,p=_,a+=1,a<t&&(h=r[a]);for(;l<i;)v=g,E=d,P=v+E,w=P-v,S=E-w,S&&(s[o++]=S),_=p+P,R=_-p,A=_-R,M=P-R,f=p-A,d=f+M,p=_,l+=1,l<i&&(g=-e[l]);return d&&(s[o++]=d),p&&(s[o++]=p),o||(s[o++]=0),s.length=o,s}(function(r){var e=zs,t=kh,i=Fh,n=Bh,s=5,o=11102230246251565e-32,a=(3+16*o)*o,l=(7+56*o)*o;function c(d,p,_,R){return function(M,f,x){var T=d(d(p(f[1],x[0]),p(-x[1],f[0])),d(p(M[1],f[0]),p(-f[1],M[0]))),b=d(p(M[1],x[0]),p(-x[1],M[0])),$=R(T,b);return $[$.length-1]}}function h(d,p,_,R){return function(M,f,x,T){var b=d(d(_(d(p(x[1],T[0]),p(-T[1],x[0])),f[2]),d(_(d(p(f[1],T[0]),p(-T[1],f[0])),-x[2]),_(d(p(f[1],x[0]),p(-x[1],f[0])),T[2]))),d(_(d(p(f[1],T[0]),p(-T[1],f[0])),M[2]),d(_(d(p(M[1],T[0]),p(-T[1],M[0])),-f[2]),_(d(p(M[1],f[0]),p(-f[1],M[0])),T[2])))),$=d(d(_(d(p(x[1],T[0]),p(-T[1],x[0])),M[2]),d(_(d(p(M[1],T[0]),p(-T[1],M[0])),-x[2]),_(d(p(M[1],x[0]),p(-x[1],M[0])),T[2]))),d(_(d(p(f[1],x[0]),p(-x[1],f[0])),M[2]),d(_(d(p(M[1],x[0]),p(-x[1],M[0])),-f[2]),_(d(p(M[1],f[0]),p(-f[1],M[0])),x[2])))),Y=R(b,$);return Y[Y.length-1]}}function u(d,p,_,R){return function(M,f,x,T,b){var $=d(d(d(_(d(_(d(p(T[1],b[0]),p(-b[1],T[0])),x[2]),d(_(d(p(x[1],b[0]),p(-b[1],x[0])),-T[2]),_(d(p(x[1],T[0]),p(-T[1],x[0])),b[2]))),f[3]),d(_(d(_(d(p(T[1],b[0]),p(-b[1],T[0])),f[2]),d(_(d(p(f[1],b[0]),p(-b[1],f[0])),-T[2]),_(d(p(f[1],T[0]),p(-T[1],f[0])),b[2]))),-x[3]),_(d(_(d(p(x[1],b[0]),p(-b[1],x[0])),f[2]),d(_(d(p(f[1],b[0]),p(-b[1],f[0])),-x[2]),_(d(p(f[1],x[0]),p(-x[1],f[0])),b[2]))),T[3]))),d(_(d(_(d(p(x[1],T[0]),p(-T[1],x[0])),f[2]),d(_(d(p(f[1],T[0]),p(-T[1],f[0])),-x[2]),_(d(p(f[1],x[0]),p(-x[1],f[0])),T[2]))),-b[3]),d(_(d(_(d(p(T[1],b[0]),p(-b[1],T[0])),f[2]),d(_(d(p(f[1],b[0]),p(-b[1],f[0])),-T[2]),_(d(p(f[1],T[0]),p(-T[1],f[0])),b[2]))),M[3]),_(d(_(d(p(T[1],b[0]),p(-b[1],T[0])),M[2]),d(_(d(p(M[1],b[0]),p(-b[1],M[0])),-T[2]),_(d(p(M[1],T[0]),p(-T[1],M[0])),b[2]))),-f[3])))),d(d(_(d(_(d(p(f[1],b[0]),p(-b[1],f[0])),M[2]),d(_(d(p(M[1],b[0]),p(-b[1],M[0])),-f[2]),_(d(p(M[1],f[0]),p(-f[1],M[0])),b[2]))),T[3]),d(_(d(_(d(p(f[1],T[0]),p(-T[1],f[0])),M[2]),d(_(d(p(M[1],T[0]),p(-T[1],M[0])),-f[2]),_(d(p(M[1],f[0]),p(-f[1],M[0])),T[2]))),-b[3]),_(d(_(d(p(x[1],T[0]),p(-T[1],x[0])),f[2]),d(_(d(p(f[1],T[0]),p(-T[1],f[0])),-x[2]),_(d(p(f[1],x[0]),p(-x[1],f[0])),T[2]))),M[3]))),d(_(d(_(d(p(x[1],T[0]),p(-T[1],x[0])),M[2]),d(_(d(p(M[1],T[0]),p(-T[1],M[0])),-x[2]),_(d(p(M[1],x[0]),p(-x[1],M[0])),T[2]))),-f[3]),d(_(d(_(d(p(f[1],T[0]),p(-T[1],f[0])),M[2]),d(_(d(p(M[1],T[0]),p(-T[1],M[0])),-f[2]),_(d(p(M[1],f[0]),p(-f[1],M[0])),T[2]))),x[3]),_(d(_(d(p(f[1],x[0]),p(-x[1],f[0])),M[2]),d(_(d(p(M[1],x[0]),p(-x[1],M[0])),-f[2]),_(d(p(M[1],f[0]),p(-f[1],M[0])),x[2]))),-T[3]))))),Y=d(d(d(_(d(_(d(p(T[1],b[0]),p(-b[1],T[0])),x[2]),d(_(d(p(x[1],b[0]),p(-b[1],x[0])),-T[2]),_(d(p(x[1],T[0]),p(-T[1],x[0])),b[2]))),M[3]),_(d(_(d(p(T[1],b[0]),p(-b[1],T[0])),M[2]),d(_(d(p(M[1],b[0]),p(-b[1],M[0])),-T[2]),_(d(p(M[1],T[0]),p(-T[1],M[0])),b[2]))),-x[3])),d(_(d(_(d(p(x[1],b[0]),p(-b[1],x[0])),M[2]),d(_(d(p(M[1],b[0]),p(-b[1],M[0])),-x[2]),_(d(p(M[1],x[0]),p(-x[1],M[0])),b[2]))),T[3]),_(d(_(d(p(x[1],T[0]),p(-T[1],x[0])),M[2]),d(_(d(p(M[1],T[0]),p(-T[1],M[0])),-x[2]),_(d(p(M[1],x[0]),p(-x[1],M[0])),T[2]))),-b[3]))),d(d(_(d(_(d(p(x[1],b[0]),p(-b[1],x[0])),f[2]),d(_(d(p(f[1],b[0]),p(-b[1],f[0])),-x[2]),_(d(p(f[1],x[0]),p(-x[1],f[0])),b[2]))),M[3]),_(d(_(d(p(x[1],b[0]),p(-b[1],x[0])),M[2]),d(_(d(p(M[1],b[0]),p(-b[1],M[0])),-x[2]),_(d(p(M[1],x[0]),p(-x[1],M[0])),b[2]))),-f[3])),d(_(d(_(d(p(f[1],b[0]),p(-b[1],f[0])),M[2]),d(_(d(p(M[1],b[0]),p(-b[1],M[0])),-f[2]),_(d(p(M[1],f[0]),p(-f[1],M[0])),b[2]))),x[3]),_(d(_(d(p(f[1],x[0]),p(-x[1],f[0])),M[2]),d(_(d(p(M[1],x[0]),p(-x[1],M[0])),-f[2]),_(d(p(M[1],f[0]),p(-f[1],M[0])),x[2]))),-b[3])))),X=R($,Y);return X[X.length-1]}}function g(d){var p=d===3?c:d===4?h:u;return p(t,e,i,n)}var y=g(3),v=g(4),E=[function(){return 0},function(){return 0},function(p,_){return _[0]-p[0]},function(p,_,R){var A=(p[1]-R[1])*(_[0]-R[0]),M=(p[0]-R[0])*(_[1]-R[1]),f=A-M,x;if(A>0){if(M<=0)return f;x=A+M}else if(A<0){if(M>=0)return f;x=-(A+M)}else return f;var T=a*x;return f>=T||f<=-T?f:y(p,_,R)},function(p,_,R,A){var M=p[0]-A[0],f=_[0]-A[0],x=R[0]-A[0],T=p[1]-A[1],b=_[1]-A[1],$=R[1]-A[1],Y=p[2]-A[2],X=_[2]-A[2],V=R[2]-A[2],oe=f*$,he=x*b,me=x*T,ee=M*$,Pe=M*b,z=f*T,ne=Y*(oe-he)+X*(me-ee)+V*(Pe-z),ve=(Math.abs(oe)+Math.abs(he))*Math.abs(Y)+(Math.abs(me)+Math.abs(ee))*Math.abs(X)+(Math.abs(Pe)+Math.abs(z))*Math.abs(V),fe=l*ve;return ne>fe||-ne>fe?ne:v(p,_,R,A)}];function P(d){var p=E[d.length];return p||(p=E[d.length]=g(d.length)),p.apply(void 0,d)}function w(d,p,_,R,A,M,f){return function(T,b,$,Y,X){switch(arguments.length){case 0:case 1:return 0;case 2:return R(T,b);case 3:return A(T,b,$);case 4:return M(T,b,$,Y);case 5:return f(T,b,$,Y,X)}for(var V=new Array(arguments.length),oe=0;oe<arguments.length;++oe)V[oe]=arguments[oe];return d(V)}}function S(){for(;E.length<=s;)E.push(g(E.length));r.exports=w.apply(void 0,[P].concat(E));for(var d=0;d<=s;++d)r.exports[d]=E[d]}S()})(Ws);var zh=Ws.exports,Vh=$h,Qr=zh;function $h(r,e){for(var t=e[0],i=e[1],n=r.length,s=1,o=n,a=0,l=n-1;a<o;l=a++){var c=r[a],h=r[l],u=c[1],g=h[1];if(g<u){if(g<i&&i<u){var y=Qr(c,h,e);if(y===0)return 0;s^=0<y|0}else if(i===u){var v=r[(a+1)%n],E=v[1];if(u<E){var y=Qr(c,h,e);if(y===0)return 0;s^=0<y|0}}}else if(u<g){if(u<i&&i<g){var y=Qr(c,h,e);if(y===0)return 0;s^=y<0|0}else if(i===u){var v=r[(a+1)%n],E=v[1];if(E<u){var y=Qr(c,h,e);if(y===0)return 0;s^=y<0|0}}}else if(i===u){var P=Math.min(c[0],h[0]),w=Math.max(c[0],h[0]);if(a===0){for(;l>0;){var S=(l+n-1)%n,d=r[S];if(d[1]!==i)break;var p=d[0];P=Math.min(P,p),w=Math.max(w,p),l=S}if(l===0)return P<=t&&t<=w?0:1;o=l+1}for(var _=r[(l+n-1)%n][1];a+1<o;){var d=r[a+1];if(d[1]!==i)break;var p=d[0];P=Math.min(P,p),w=Math.max(w,p),a+=1}if(P<=t&&t<=w)return 0;var R=r[(a+1)%n][1];t<P&&_<i!=R<i&&(s^=1)}}return 2*s-1}const qh=Ah(Vh);var $s={};const Zh={version:"1.5.0"};function qs(r){return"("+r.x+";"+r.y+")"}function Xh(r){var e=r.toString();return e==="[object Object]"?qs(r):e}function Hh(r,e){return r.y===e.y?r.x-e.x:r.y-e.y}function Yh(r,e){return r.x===e.x&&r.y===e.y}var zi={toString:Xh,toStringBase:qs,compare:Hh,equals:Yh},Jh=zi,Kr=function(r,e){this.name="PointError",this.points=e=e||[],this.message=r||"Invalid Points!";for(var t=0;t<e.length;t++)this.message+=" "+Jh.toString(e[t])};Kr.prototype=new Error,Kr.prototype.constructor=Kr;var Vi=Kr,Kt=zi,Q=function(r,e){this.x=+r||0,this.y=+e||0,this._p2t_edge_list=null};Q.prototype.toString=function(){return Kt.toStringBase(this)},Q.prototype.toJSON=function(){return{x:this.x,y:this.y}},Q.prototype.clone=function(){return new Q(this.x,this.y)},Q.prototype.set_zero=function(){return this.x=0,this.y=0,this},Q.prototype.set=function(r,e){return this.x=+r||0,this.y=+e||0,this},Q.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},Q.prototype.add=function(r){return this.x+=r.x,this.y+=r.y,this},Q.prototype.sub=function(r){return this.x-=r.x,this.y-=r.y,this},Q.prototype.mul=function(r){return this.x*=r,this.y*=r,this},Q.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},Q.prototype.normalize=function(){var r=this.length();return this.x/=r,this.y/=r,r},Q.prototype.equals=function(r){return this.x===r.x&&this.y===r.y},Q.negate=function(r){return new Q(-r.x,-r.y)},Q.add=function(r,e){return new Q(r.x+e.x,r.y+e.y)},Q.sub=function(r,e){return new Q(r.x-e.x,r.y-e.y)},Q.mul=function(r,e){return new Q(r*e.x,r*e.y)},Q.cross=function(r,e){return typeof r=="number"?typeof e=="number"?r*e:new Q(-r*e.y,r*e.x):typeof e=="number"?new Q(e*r.y,-e*r.x):r.x*e.y-r.y*e.x},Q.toString=Kt.toString,Q.compare=Kt.compare,Q.cmp=Kt.compare,Q.equals=Kt.equals,Q.dot=function(r,e){return r.x*e.x+r.y*e.y};var Zs=Q,Qh=zi,Z=function(r,e,t){this.points_=[r,e,t],this.neighbors_=[null,null,null],this.interior_=!1,this.constrained_edge=[!1,!1,!1],this.delaunay_edge=[!1,!1,!1]},$i=Qh.toString;Z.prototype.toString=function(){return"["+$i(this.points_[0])+$i(this.points_[1])+$i(this.points_[2])+"]"},Z.prototype.getPoint=function(r){return this.points_[r]},Z.prototype.GetPoint=Z.prototype.getPoint,Z.prototype.getPoints=function(){return this.points_},Z.prototype.getNeighbor=function(r){return this.neighbors_[r]},Z.prototype.containsPoint=function(r){var e=this.points_;return r===e[0]||r===e[1]||r===e[2]},Z.prototype.containsEdge=function(r){return this.containsPoint(r.p)&&this.containsPoint(r.q)},Z.prototype.containsPoints=function(r,e){return this.containsPoint(r)&&this.containsPoint(e)},Z.prototype.isInterior=function(){return this.interior_},Z.prototype.setInterior=function(r){return this.interior_=r,this},Z.prototype.markNeighborPointers=function(r,e,t){var i=this.points_;if(r===i[2]&&e===i[1]||r===i[1]&&e===i[2])this.neighbors_[0]=t;else if(r===i[0]&&e===i[2]||r===i[2]&&e===i[0])this.neighbors_[1]=t;else if(r===i[0]&&e===i[1]||r===i[1]&&e===i[0])this.neighbors_[2]=t;else throw new Error("poly2tri Invalid Triangle.markNeighborPointers() call")},Z.prototype.markNeighbor=function(r){var e=this.points_;r.containsPoints(e[1],e[2])?(this.neighbors_[0]=r,r.markNeighborPointers(e[1],e[2],this)):r.containsPoints(e[0],e[2])?(this.neighbors_[1]=r,r.markNeighborPointers(e[0],e[2],this)):r.containsPoints(e[0],e[1])&&(this.neighbors_[2]=r,r.markNeighborPointers(e[0],e[1],this))},Z.prototype.clearNeighbors=function(){this.neighbors_[0]=null,this.neighbors_[1]=null,this.neighbors_[2]=null},Z.prototype.clearDelaunayEdges=function(){this.delaunay_edge[0]=!1,this.delaunay_edge[1]=!1,this.delaunay_edge[2]=!1},Z.prototype.pointCW=function(r){var e=this.points_;return r===e[0]?e[2]:r===e[1]?e[0]:r===e[2]?e[1]:null},Z.prototype.pointCCW=function(r){var e=this.points_;return r===e[0]?e[1]:r===e[1]?e[2]:r===e[2]?e[0]:null},Z.prototype.neighborCW=function(r){return r===this.points_[0]?this.neighbors_[1]:r===this.points_[1]?this.neighbors_[2]:this.neighbors_[0]},Z.prototype.neighborCCW=function(r){return r===this.points_[0]?this.neighbors_[2]:r===this.points_[1]?this.neighbors_[0]:this.neighbors_[1]},Z.prototype.getConstrainedEdgeCW=function(r){return r===this.points_[0]?this.constrained_edge[1]:r===this.points_[1]?this.constrained_edge[2]:this.constrained_edge[0]},Z.prototype.getConstrainedEdgeCCW=function(r){return r===this.points_[0]?this.constrained_edge[2]:r===this.points_[1]?this.constrained_edge[0]:this.constrained_edge[1]},Z.prototype.getConstrainedEdgeAcross=function(r){return r===this.points_[0]?this.constrained_edge[0]:r===this.points_[1]?this.constrained_edge[1]:this.constrained_edge[2]},Z.prototype.setConstrainedEdgeCW=function(r,e){r===this.points_[0]?this.constrained_edge[1]=e:r===this.points_[1]?this.constrained_edge[2]=e:this.constrained_edge[0]=e},Z.prototype.setConstrainedEdgeCCW=function(r,e){r===this.points_[0]?this.constrained_edge[2]=e:r===this.points_[1]?this.constrained_edge[0]=e:this.constrained_edge[1]=e},Z.prototype.getDelaunayEdgeCW=function(r){return r===this.points_[0]?this.delaunay_edge[1]:r===this.points_[1]?this.delaunay_edge[2]:this.delaunay_edge[0]},Z.prototype.getDelaunayEdgeCCW=function(r){return r===this.points_[0]?this.delaunay_edge[2]:r===this.points_[1]?this.delaunay_edge[0]:this.delaunay_edge[1]},Z.prototype.setDelaunayEdgeCW=function(r,e){r===this.points_[0]?this.delaunay_edge[1]=e:r===this.points_[1]?this.delaunay_edge[2]=e:this.delaunay_edge[0]=e},Z.prototype.setDelaunayEdgeCCW=function(r,e){r===this.points_[0]?this.delaunay_edge[2]=e:r===this.points_[1]?this.delaunay_edge[0]=e:this.delaunay_edge[1]=e},Z.prototype.neighborAcross=function(r){return r===this.points_[0]?this.neighbors_[0]:r===this.points_[1]?this.neighbors_[1]:this.neighbors_[2]},Z.prototype.oppositePoint=function(r,e){var t=r.pointCW(e);return this.pointCW(t)},Z.prototype.legalize=function(r,e){var t=this.points_;if(r===t[0])t[1]=t[0],t[0]=t[2],t[2]=e;else if(r===t[1])t[2]=t[1],t[1]=t[0],t[0]=e;else if(r===t[2])t[0]=t[2],t[2]=t[1],t[1]=e;else throw new Error("poly2tri Invalid Triangle.legalize() call")},Z.prototype.index=function(r){var e=this.points_;if(r===e[0])return 0;if(r===e[1])return 1;if(r===e[2])return 2;throw new Error("poly2tri Invalid Triangle.index() call")},Z.prototype.edgeIndex=function(r,e){var t=this.points_;if(r===t[0]){if(e===t[1])return 2;if(e===t[2])return 1}else if(r===t[1]){if(e===t[2])return 0;if(e===t[0])return 2}else if(r===t[2]){if(e===t[0])return 1;if(e===t[1])return 0}return-1},Z.prototype.markConstrainedEdgeByIndex=function(r){this.constrained_edge[r]=!0},Z.prototype.markConstrainedEdgeByEdge=function(r){this.markConstrainedEdgeByPoints(r.p,r.q)},Z.prototype.markConstrainedEdgeByPoints=function(r,e){var t=this.points_;e===t[0]&&r===t[1]||e===t[1]&&r===t[0]?this.constrained_edge[2]=!0:e===t[0]&&r===t[2]||e===t[2]&&r===t[0]?this.constrained_edge[1]=!0:(e===t[1]&&r===t[2]||e===t[2]&&r===t[1])&&(this.constrained_edge[0]=!0)};var qi=Z,Zi={};function Kh(r,e){if(!r)throw new Error(e||"Assert Failed")}var eu=Kh,Xi={exports:{}},tu=function(r,e){this.point=r,this.triangle=e||null,this.next=null,this.prev=null,this.value=r.x},Ne=function(r,e){this.head_=r,this.tail_=e,this.search_node_=r};Ne.prototype.head=function(){return this.head_},Ne.prototype.setHead=function(r){this.head_=r},Ne.prototype.tail=function(){return this.tail_},Ne.prototype.setTail=function(r){this.tail_=r},Ne.prototype.search=function(){return this.search_node_},Ne.prototype.setSearch=function(r){this.search_node_=r},Ne.prototype.findSearchNode=function(){return this.search_node_},Ne.prototype.locateNode=function(r){var e=this.search_node_;if(r<e.value){for(;e=e.prev;)if(r>=e.value)return this.search_node_=e,e}else for(;e=e.next;)if(r<e.value)return this.search_node_=e.prev,e.prev;return null},Ne.prototype.locatePoint=function(r){var e=r.x,t=this.findSearchNode(e),i=t.point.x;if(e===i){if(r!==t.point)if(r===t.prev.point)t=t.prev;else if(r===t.next.point)t=t.next;else throw new Error("poly2tri Invalid AdvancingFront.locatePoint() call")}else if(e<i)for(;(t=t.prev)&&r!==t.point;);else for(;(t=t.next)&&r!==t.point;);return t&&(this.search_node_=t),t},Xi.exports=Ne,Xi.exports.Node=tu;var Xs=Xi.exports,Tt={},er=1e-12;Tt.EPSILON=er;var ei={CW:1,CCW:-1,COLLINEAR:0};Tt.Orientation=ei;function ru(r,e,t){var i=(r.x-t.x)*(e.y-t.y),n=(r.y-t.y)*(e.x-t.x),s=i-n;return s>-er&&s<er?ei.COLLINEAR:s>0?ei.CCW:ei.CW}Tt.orient2d=ru;function iu(r,e,t,i){var n=(r.x-e.x)*(i.y-e.y)-(i.x-e.x)*(r.y-e.y);if(n>=-er)return!1;var s=(r.x-t.x)*(i.y-t.y)-(i.x-t.x)*(r.y-t.y);return!(s<=er)}Tt.inScanArea=iu;function nu(r,e,t){var i=e.x-r.x,n=e.y-r.y,s=t.x-r.x,o=t.y-r.y;return i*s+n*o<0}Tt.isAngleObtuse=nu;var Hi=eu,ti=Vi,Hs=qi,su=Xs.Node,tr=Tt,ou=tr.EPSILON,ie=tr.Orientation,ae=tr.orient2d,Ys=tr.inScanArea,Js=tr.isAngleObtuse;function au(r){r.initTriangulation(),r.createAdvancingFront(),lu(r),cu(r)}function lu(r){var e,t=r.pointCount();for(e=1;e<t;++e)for(var i=r.getPoint(e),n=hu(r,i),s=i._p2t_edge_list,o=0;s&&o<s.length;++o)uu(r,s[o],n)}function cu(r){for(var e=r.front().head().next.triangle,t=r.front().head().next.point;!e.getConstrainedEdgeCW(t);)e=e.neighborCCW(t);r.meshClean(e)}function hu(r,e){var t=r.locateNode(e),i=du(r,e,t);return e.x<=t.point.x+ou&&Et(r,t),fu(r,i),i}function uu(r,e,t){r.edge_event.constrained_edge=e,r.edge_event.right=e.p.x>e.q.x,!Qs(t.triangle,e.p,e.q)&&(yu(r,e,t),Yi(r,e.p,e.q,t.triangle,e.q))}function Yi(r,e,t,i,n){if(!Qs(i,e,t)){var s=i.pointCCW(n),o=ae(t,s,e);if(o===ie.COLLINEAR)throw new ti("poly2tri EdgeEvent: Collinear not supported!",[t,s,e]);var a=i.pointCW(n),l=ae(t,a,e);if(l===ie.COLLINEAR)throw new ti("poly2tri EdgeEvent: Collinear not supported!",[t,a,e]);o===l?(o===ie.CW?i=i.neighborCCW(n):i=i.neighborCW(n),Yi(r,e,t,i,n)):Ki(r,e,t,i,n)}}function Qs(r,e,t){var i=r.edgeIndex(e,t);if(i!==-1){r.markConstrainedEdgeByIndex(i);var n=r.getNeighbor(i);return n&&n.markConstrainedEdgeByPoints(e,t),!0}return!1}function du(r,e,t){var i=new Hs(e,t.point,t.next.point);i.markNeighbor(t.triangle),r.addToMap(i);var n=new su(e);return n.next=t.next,n.prev=t,t.next.prev=n,t.next=n,nt(r,i)||r.mapTriangleToNodes(i),n}function Et(r,e){var t=new Hs(e.prev.point,e.point,e.next.point);t.markNeighbor(e.prev.triangle),t.markNeighbor(e.triangle),r.addToMap(t),e.prev.next=e.next,e.next.prev=e.prev,nt(r,t)||r.mapTriangleToNodes(t)}function fu(r,e){for(var t=e.next;t.next&&!Js(t.point,t.next.point,t.prev.point);)Et(r,t),t=t.next;for(t=e.prev;t.prev&&!Js(t.point,t.next.point,t.prev.point);)Et(r,t),t=t.prev;e.next&&e.next.next&&pu(e)&&mu(r,e)}function pu(r){var e=r.point.x-r.next.next.point.x,t=r.point.y-r.next.next.point.y;return Hi(t>=0,"unordered y"),e>=0||Math.abs(e)<t}function nt(r,e){for(var t=0;t<3;++t)if(!e.delaunay_edge[t]){var i=e.getNeighbor(t);if(i){var n=e.getPoint(t),s=i.oppositePoint(e,n),o=i.index(s);if(i.constrained_edge[o]||i.delaunay_edge[o]){e.constrained_edge[t]=i.constrained_edge[o];continue}var a=gu(n,e.pointCCW(n),e.pointCW(n),s);if(a){e.delaunay_edge[t]=!0,i.delaunay_edge[o]=!0,Ks(e,n,i,s);var l=!nt(r,e);return l&&r.mapTriangleToNodes(e),l=!nt(r,i),l&&r.mapTriangleToNodes(i),e.delaunay_edge[t]=!1,i.delaunay_edge[o]=!1,!0}}}return!1}function gu(r,e,t,i){var n=r.x-i.x,s=r.y-i.y,o=e.x-i.x,a=e.y-i.y,l=n*a,c=o*s,h=l-c;if(h<=0)return!1;var u=t.x-i.x,g=t.y-i.y,y=u*s,v=n*g,E=y-v;if(E<=0)return!1;var P=o*g,w=u*a,S=n*n+s*s,d=o*o+a*a,p=u*u+g*g,_=S*(P-w)+d*E+p*h;return _>0}function Ks(r,e,t,i){var n,s,o,a;n=r.neighborCCW(e),s=r.neighborCW(e),o=t.neighborCCW(i),a=t.neighborCW(i);var l,c,h,u;l=r.getConstrainedEdgeCCW(e),c=r.getConstrainedEdgeCW(e),h=t.getConstrainedEdgeCCW(i),u=t.getConstrainedEdgeCW(i);var g,y,v,E;g=r.getDelaunayEdgeCCW(e),y=r.getDelaunayEdgeCW(e),v=t.getDelaunayEdgeCCW(i),E=t.getDelaunayEdgeCW(i),r.legalize(e,i),t.legalize(i,e),t.setDelaunayEdgeCCW(e,g),r.setDelaunayEdgeCW(e,y),r.setDelaunayEdgeCCW(i,v),t.setDelaunayEdgeCW(i,E),t.setConstrainedEdgeCCW(e,l),r.setConstrainedEdgeCW(e,c),r.setConstrainedEdgeCCW(i,h),t.setConstrainedEdgeCW(i,u),r.clearNeighbors(),t.clearNeighbors(),n&&t.markNeighbor(n),s&&r.markNeighbor(s),o&&r.markNeighbor(o),a&&t.markNeighbor(a),r.markNeighbor(t)}function mu(r,e){for(ae(e.point,e.next.point,e.next.next.point)===ie.CCW?r.basin.left_node=e.next.next:r.basin.left_node=e.next,r.basin.bottom_node=r.basin.left_node;r.basin.bottom_node.next&&r.basin.bottom_node.point.y>=r.basin.bottom_node.next.point.y;)r.basin.bottom_node=r.basin.bottom_node.next;if(r.basin.bottom_node!==r.basin.left_node){for(r.basin.right_node=r.basin.bottom_node;r.basin.right_node.next&&r.basin.right_node.point.y<r.basin.right_node.next.point.y;)r.basin.right_node=r.basin.right_node.next;r.basin.right_node!==r.basin.bottom_node&&(r.basin.width=r.basin.right_node.point.x-r.basin.left_node.point.x,r.basin.left_highest=r.basin.left_node.point.y>r.basin.right_node.point.y,eo(r,r.basin.bottom_node))}}function eo(r,e){if(!vu(r,e)){Et(r,e);var t;if(!(e.prev===r.basin.left_node&&e.next===r.basin.right_node)){if(e.prev===r.basin.left_node){if(t=ae(e.point,e.next.point,e.next.next.point),t===ie.CW)return;e=e.next}else if(e.next===r.basin.right_node){if(t=ae(e.point,e.prev.point,e.prev.prev.point),t===ie.CCW)return;e=e.prev}else e.prev.point.y<e.next.point.y?e=e.prev:e=e.next;eo(r,e)}}}function vu(r,e){var t;return r.basin.left_highest?t=r.basin.left_node.point.y-e.point.y:t=r.basin.right_node.point.y-e.point.y,r.basin.width>t}function yu(r,e,t){r.edge_event.right?wu(r,e,t):xu(r,e,t)}function wu(r,e,t){for(;t.next.point.x<e.p.x;)ae(e.q,t.next.point,e.p)===ie.CCW?to(r,e,t):t=t.next}function to(r,e,t){t.point.x<e.p.x&&(ae(t.point,t.next.point,t.next.next.point)===ie.CCW?Ji(r,e,t):(ro(r,e,t),to(r,e,t)))}function Ji(r,e,t){Et(r,t.next),t.next.point!==e.p&&ae(e.q,t.next.point,e.p)===ie.CCW&&ae(t.point,t.next.point,t.next.next.point)===ie.CCW&&Ji(r,e,t)}function ro(r,e,t){ae(t.next.point,t.next.next.point,t.next.next.next.point)===ie.CCW?Ji(r,e,t.next):ae(e.q,t.next.next.point,e.p)===ie.CCW&&ro(r,e,t.next)}function xu(r,e,t){for(;t.prev.point.x>e.p.x;)ae(e.q,t.prev.point,e.p)===ie.CW?io(r,e,t):t=t.prev}function io(r,e,t){t.point.x>e.p.x&&(ae(t.point,t.prev.point,t.prev.prev.point)===ie.CW?Qi(r,e,t):(no(r,e,t),io(r,e,t)))}function no(r,e,t){ae(t.prev.point,t.prev.prev.point,t.prev.prev.prev.point)===ie.CW?Qi(r,e,t.prev):ae(e.q,t.prev.prev.point,e.p)===ie.CW&&no(r,e,t.prev)}function Qi(r,e,t){Et(r,t.prev),t.prev.point!==e.p&&ae(e.q,t.prev.point,e.p)===ie.CW&&ae(t.point,t.prev.point,t.prev.prev.point)===ie.CW&&Qi(r,e,t)}function Ki(r,e,t,i,n){var s=i.neighborAcross(n);Hi(s,"FLIP failed due to missing triangle!");var o=s.oppositePoint(i,n);if(i.getConstrainedEdgeAcross(n)){var a=i.index(n);throw new ti("poly2tri Intersecting Constraints",[n,o,i.getPoint((a+1)%3),i.getPoint((a+2)%3)])}if(Ys(n,i.pointCCW(n),i.pointCW(n),o))if(Ks(i,n,s,o),r.mapTriangleToNodes(i),r.mapTriangleToNodes(s),n===t&&o===e)t===r.edge_event.constrained_edge.q&&e===r.edge_event.constrained_edge.p&&(i.markConstrainedEdgeByPoints(e,t),s.markConstrainedEdgeByPoints(e,t),nt(r,i),nt(r,s));else{var l=ae(t,o,e);i=_u(r,l,i,s,n,o),Ki(r,e,t,i,n)}else{var c=so(e,t,s,o);oo(r,e,t,i,s,c),Yi(r,e,t,i,n)}}function _u(r,e,t,i,n,s){var o;return e===ie.CCW?(o=i.edgeIndex(n,s),i.delaunay_edge[o]=!0,nt(r,i),i.clearDelaunayEdges(),t):(o=t.edgeIndex(n,s),t.delaunay_edge[o]=!0,nt(r,t),t.clearDelaunayEdges(),i)}function so(r,e,t,i){var n=ae(e,i,r);if(n===ie.CW)return t.pointCCW(i);if(n===ie.CCW)return t.pointCW(i);throw new ti("poly2tri [Unsupported] nextFlipPoint: opposing point on constrained edge!",[e,i,r])}function oo(r,e,t,i,n,s){var o=n.neighborAcross(s);Hi(o,"FLIP failed due to missing triangle");var a=o.oppositePoint(n,s);if(Ys(t,i.pointCCW(t),i.pointCW(t),a))Ki(r,t,a,o,a);else{var l=so(e,t,o,a);oo(r,e,t,i,o,l)}}Zi.triangulate=au;var bu=Vi,rr=Zs,Mu=qi,Tu=Zi,ao=Xs,en=ao.Node,lo=.3,Eu=function(r,e){if(this.p=r,this.q=e,r.y>e.y)this.q=r,this.p=e;else if(r.y===e.y){if(r.x>e.x)this.q=r,this.p=e;else if(r.x===e.x)throw new bu("poly2tri Invalid Edge constructor: repeated points!",[r])}this.q._p2t_edge_list||(this.q._p2t_edge_list=[]),this.q._p2t_edge_list.push(this)},co=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1};co.prototype.clear=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1};var Pu=function(){this.constrained_edge=null,this.right=!1},J=function(r,e){e=e||{},this.triangles_=[],this.map_=[],this.points_=e.cloneArrays?r.slice(0):r,this.edge_list=[],this.pmin_=this.pmax_=null,this.front_=null,this.head_=null,this.tail_=null,this.af_head_=null,this.af_middle_=null,this.af_tail_=null,this.basin=new co,this.edge_event=new Pu,this.initEdges(this.points_)};J.prototype.addHole=function(r){this.initEdges(r);var e,t=r.length;for(e=0;e<t;e++)this.points_.push(r[e]);return this},J.prototype.AddHole=J.prototype.addHole,J.prototype.addHoles=function(r){var e,t=r.length;for(e=0;e<t;e++)this.initEdges(r[e]);return this.points_=this.points_.concat.apply(this.points_,r),this},J.prototype.addPoint=function(r){return this.points_.push(r),this},J.prototype.AddPoint=J.prototype.addPoint,J.prototype.addPoints=function(r){return this.points_=this.points_.concat(r),this},J.prototype.triangulate=function(){return Tu.triangulate(this),this},J.prototype.getBoundingBox=function(){return{min:this.pmin_,max:this.pmax_}},J.prototype.getTriangles=function(){return this.triangles_},J.prototype.GetTriangles=J.prototype.getTriangles,J.prototype.front=function(){return this.front_},J.prototype.pointCount=function(){return this.points_.length},J.prototype.head=function(){return this.head_},J.prototype.setHead=function(r){this.head_=r},J.prototype.tail=function(){return this.tail_},J.prototype.setTail=function(r){this.tail_=r},J.prototype.getMap=function(){return this.map_},J.prototype.initTriangulation=function(){var r=this.points_[0].x,e=this.points_[0].x,t=this.points_[0].y,i=this.points_[0].y,n,s=this.points_.length;for(n=1;n<s;n++){var o=this.points_[n];o.x>r&&(r=o.x),o.x<e&&(e=o.x),o.y>t&&(t=o.y),o.y<i&&(i=o.y)}this.pmin_=new rr(e,i),this.pmax_=new rr(r,t);var a=lo*(r-e),l=lo*(t-i);this.head_=new rr(r+a,i-l),this.tail_=new rr(e-a,i-l),this.points_.sort(rr.compare)},J.prototype.initEdges=function(r){var e,t=r.length;for(e=0;e<t;++e)this.edge_list.push(new Eu(r[e],r[(e+1)%t]))},J.prototype.getPoint=function(r){return this.points_[r]},J.prototype.addToMap=function(r){this.map_.push(r)},J.prototype.locateNode=function(r){return this.front_.locateNode(r.x)},J.prototype.createAdvancingFront=function(){var r,e,t,i=new Mu(this.points_[0],this.tail_,this.head_);this.map_.push(i),r=new en(i.getPoint(1),i),e=new en(i.getPoint(0),i),t=new en(i.getPoint(2)),this.front_=new ao(r,t),r.next=e,e.next=t,e.prev=r,t.prev=e},J.prototype.removeNode=function(r){},J.prototype.mapTriangleToNodes=function(r){for(var e=0;e<3;++e)if(!r.getNeighbor(e)){var t=this.front_.locatePoint(r.pointCW(r.getPoint(e)));t&&(t.triangle=r)}},J.prototype.removeFromMap=function(r){var e,t=this.map_,i=t.length;for(e=0;e<i;e++)if(t[e]===r){t.splice(e,1);break}},J.prototype.meshClean=function(r){for(var e=[r],t,i;t=e.pop();)if(!t.isInterior())for(t.setInterior(!0),this.triangles_.push(t),i=0;i<3;i++)t.constrained_edge[i]||e.push(t.getNeighbor(i))};var Su=J;(function(r){var e=globalThis.poly2tri;r.noConflict=function(){return globalThis.poly2tri=e,r},r.VERSION=Zh.version,r.PointError=Vi,r.Point=Zs,r.Triangle=qi,r.SweepContext=Su;var t=Zi;r.triangulate=t.triangulate,r.sweep={Triangulate:t.triangulate}})($s);function Ru(r,e){let t=0;const i=new $s.SweepContext(Rh(r,e).map(n=>({x:n[0],y:n[1],type:"p",item:t++})));i.addPoints(Ih(r,e).filter(n=>qh(r,n)===-1).map(n=>({x:n[0],y:n[1],type:"g",item:t++})));try{i.triangulate()}catch{throw new Error("A Point Error occured during resource mask triangulation. This is typically because the resource mask contains duplicate or collinear points, or is self-intersecting.")}return i.getTriangles()}function Iu(r,e){const t=Ru(r,e).map(a=>a.getPoints().map(l=>l)),s=[...new Map(t.flat().map(a=>[a.item,a])).values()].sort((a,l)=>a.item-l.item).map(a=>[a.x,a.y]);return{uniquePointsIndexTriangles:t.map(a=>a.map(l=>l.item)),uniquePoints:s}}const Au=80,Cu=10;function ku(){return{}}class Lu extends Mh{resourceTrianglePoints=[];resourceUniquePoints=[];trianglePointsUniquePointsIndex=[];triangulationByBestScaleFactor=new Map;triangulateErrorCount=0;projectedGeoPreviousTrianglePoints=[];projectedGeoTrianglePoints=[];projectedGeoUniquePoints=[];projectedGeoUniquePointsByBestScaleFactorAndTransformationType=new Map;projectedGeoUniquePointsPartialDerivativeX=[];projectedGeoUniquePointsPartialDerivativeY=[];projectedGeoUniquePointsPartialDerivativeXByBestScaleFactorAndTransformationType=new Map;projectedGeoUniquePointsPartialDerivativeYByBestScaleFactorAndTransformationType=new Map;previousTrianglePointsDistortion=[];trianglePointsDistortion=[];uniquePointsDistortion=[];constructor(e,t,i){i={...ku(),...i},super(e,t,i)}setResourceMask(e){super.setResourceMask(e),this.triangulationByBestScaleFactor=new Map,this.projectedGeoUniquePointsByBestScaleFactorAndTransformationType=new Map,this.projectedGeoUniquePointsPartialDerivativeXByBestScaleFactorAndTransformationType=new Map,this.projectedGeoUniquePointsPartialDerivativeYByBestScaleFactorAndTransformationType=new Map,this.updateTriangulation()}setBestScaleFactor(e){const t=super.setBestScaleFactor(e);return t&&this.updateTriangulation(!0),t}updateTriangulation(e=!1){const{trianglePointsUniquePointsIndex:t,resourceUniquePoints:i}=_r(this.triangulationByBestScaleFactor,this.bestScaleFactor,()=>{const n=ga(this.resourceMask)*this.bestScaleFactor/Au;try{const{uniquePointsIndexTriangles:s,uniquePoints:o}=Iu(this.resourceMask,n);return{trianglePointsUniquePointsIndex:s.flat(),resourceUniquePoints:o}}catch(s){return this.triangulateErrorCount++,this.triangulateErrorCount<=Cu&&(console.error(`Error computing triangulation for map ${this.mapId}.`,`Fix this map with Allmaps Editor: https://editor.allmaps.org/#/collection?url=${this.parsedImage?.uri}/info.json`),this.triangulateErrorCount===1&&console.error(s)),{trianglePointsUniquePointsIndex:this.trianglePointsUniquePointsIndex,resourceUniquePoints:this.resourceUniquePoints}}});this.resourceTrianglePoints=t.map(n=>i[n]),this.resourceUniquePoints=i,this.trianglePointsUniquePointsIndex=t,this.updateProjectedGeoTrianglePoints(e)}updateProjectedGeoTrianglePoints(e=!1){this.projectedGeoUniquePoints=yi(this.projectedGeoUniquePointsByBestScaleFactorAndTransformationType,this.bestScaleFactor,this.transformationType,()=>this.resourceUniquePoints.map(t=>this.projectedTransformer.transformToGeo(t))),this.projectedGeoTrianglePoints=this.trianglePointsUniquePointsIndex.map(t=>this.projectedGeoUniquePoints[t]),(e||!this.projectedGeoPreviousTrianglePoints.length)&&(this.projectedGeoPreviousTrianglePoints=this.projectedGeoTrianglePoints),this.updateTrianglePointsDistortion(e)}updateTrianglePointsDistortion(e=!1){this.distortionMeasure&&(this.projectedGeoUniquePointsPartialDerivativeX=yi(this.projectedGeoUniquePointsPartialDerivativeXByBestScaleFactorAndTransformationType,this.bestScaleFactor,this.transformationType,()=>this.resourceUniquePoints.map(t=>this.projectedTransformer.transformToGeo(t,{evaluationType:"partialDerivativeX"}))),this.projectedGeoUniquePointsPartialDerivativeY=yi(this.projectedGeoUniquePointsPartialDerivativeYByBestScaleFactorAndTransformationType,this.bestScaleFactor,this.transformationType,()=>this.resourceUniquePoints.map(t=>this.projectedTransformer.transformToGeo(t,{evaluationType:"partialDerivativeY"})))),this.uniquePointsDistortion=this.projectedGeoUniquePoints.map((t,i)=>_h(this.projectedGeoUniquePointsPartialDerivativeX[i],this.projectedGeoUniquePointsPartialDerivativeY[i],this.distortionMeasure,this.getReferenceScale())),this.trianglePointsDistortion=this.trianglePointsUniquePointsIndex.map(t=>this.uniquePointsDistortion[t]),(e||!this.previousTrianglePointsDistortion.length)&&(this.previousTrianglePointsDistortion=this.trianglePointsDistortion)}resetTrianglePoints(){this.projectedGeoPreviousTrianglePoints=this.projectedGeoTrianglePoints,this.previousTrianglePointsDistortion=this.trianglePointsDistortion}mixTrianglePoints(e){this.projectedGeoPreviousTrianglePoints=this.projectedGeoTrianglePoints.map((t,i)=>ra(t,this.projectedGeoPreviousTrianglePoints[i],e)),this.previousTrianglePointsDistortion=this.trianglePointsDistortion.map((t,i)=>ta(t,this.previousTrianglePointsDistortion[i],e))}}function ju(r){let e=0,t=0;for(const a of r)e+=a.w*a.h,t=Math.max(t,a.w);r.sort((a,l)=>l.h-a.h);const n=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),t),h:1/0}];let s=0,o=0;for(const a of r)for(let l=n.length-1;l>=0;l--){const c=n[l];if(!(a.w>c.w||a.h>c.h)){if(a.x=c.x,a.y=c.y,o=Math.max(o,a.y+a.h),s=Math.max(s,a.x+a.w),a.w===c.w&&a.h===c.h){const h=n.pop();l<n.length&&(n[l]=h)}else a.h===c.h?(c.x+=a.w,c.w-=a.w):a.w===c.w?(c.y+=a.h,c.h-=a.h):(n.push({x:c.x+a.w,y:c.y,w:c.w-a.w,h:a.h}),c.y+=a.h,c.h-=a.h);break}}return{w:s,h:o,fill:e/(s*o)||0}}var Ou=typeof globalThis=="object"&&globalThis&&globalThis.Object===Object&&globalThis,Nu=typeof self=="object"&&self&&self.Object===Object&&self,ho=Ou||Nu||Function("return this")(),ri=ho.Symbol,uo=Object.prototype,Du=uo.hasOwnProperty,Fu=uo.toString,ir=ri?ri.toStringTag:void 0;function Gu(r){var e=Du.call(r,ir),t=r[ir];try{r[ir]=void 0;var i=!0}catch{}var n=Fu.call(r);return i&&(e?r[ir]=t:delete r[ir]),n}var Bu=Object.prototype,Uu=Bu.toString;function Wu(r){return Uu.call(r)}var zu="[object Null]",Vu="[object Undefined]",fo=ri?ri.toStringTag:void 0;function $u(r){return r==null?r===void 0?Vu:zu:fo&&fo in Object(r)?Gu(r):Wu(r)}function qu(r){return r!=null&&typeof r=="object"}var Zu="[object Symbol]";function Xu(r){return typeof r=="symbol"||qu(r)&&$u(r)==Zu}var Hu=/\s/;function Yu(r){for(var e=r.length;e--&&Hu.test(r.charAt(e)););return e}var Ju=/^\s+/;function Qu(r){return r&&r.slice(0,Yu(r)+1).replace(Ju,"")}function ii(r){var e=typeof r;return r!=null&&(e=="object"||e=="function")}var po=NaN,Ku=/^[-+]0x[0-9a-f]+$/i,ed=/^0b[01]+$/i,td=/^0o[0-7]+$/i,rd=parseInt;function go(r){if(typeof r=="number")return r;if(Xu(r))return po;if(ii(r)){var e=typeof r.valueOf=="function"?r.valueOf():r;r=ii(e)?e+"":e}if(typeof r!="string")return r===0?r:+r;r=Qu(r);var t=ed.test(r);return t||td.test(r)?rd(r.slice(2),t?2:8):Ku.test(r)?po:+r}var tn=function(){return ho.Date.now()},id="Expected a function",nd=Math.max,sd=Math.min;function od(r,e,t){var i,n,s,o,a,l,c=0,h=!1,u=!1,g=!0;if(typeof r!="function")throw new TypeError(id);e=go(e)||0,ii(t)&&(h=!!t.leading,u="maxWait"in t,s=u?nd(go(t.maxWait)||0,e):s,g="trailing"in t?!!t.trailing:g);function y(R){var A=i,M=n;return i=n=void 0,c=R,o=r.apply(M,A),o}function v(R){return c=R,a=setTimeout(w,e),h?y(R):o}function E(R){var A=R-l,M=R-c,f=e-A;return u?sd(f,s-M):f}function P(R){var A=R-l,M=R-c;return l===void 0||A>=e||A<0||u&&M>=s}function w(){var R=tn();if(P(R))return S(R);a=setTimeout(w,E(R))}function S(R){return a=void 0,g&&i?y(R):(i=n=void 0,o)}function d(){a!==void 0&&clearTimeout(a),c=0,i=l=n=a=void 0}function p(){return a===void 0?o:S(tn())}function _(){var R=tn(),A=P(R);if(i=arguments,n=this,l=R,A){if(a===void 0)return v(l);if(u)return clearTimeout(a),a=setTimeout(w,e),y(l)}return a===void 0&&(a=setTimeout(w,e)),o}return _.cancel=d,_.flush=p,_}var ad="Expected a function";function rn(r,e,t){var i=!0,n=!0;if(typeof r!="function")throw new TypeError(ad);return ii(t)&&(i="leading"in t?!!t.leading:i,n="trailing"in t?!!t.trailing:n),od(r,e,{leading:i,maxWait:e,trailing:n})}const ld=.5;function mo(r,e){return`${r}:${e}`}function vo(r){return mo(r.mapId,r.tileUrl)}function nn(r){return new Set(r.map(e=>vo(e)))}function cd(r,e,t=ld){let i=Number.POSITIVE_INFINITY,n=r.tileZoomLevels.at(-1);for(const s of r.tileZoomLevels){const o=Math.abs(Math.log(s.scaleFactor)-Math.log(e+t));o<i&&(i=o,n=s)}return n}function hd(r,e,t){const i=ud(r,e),n=dd(i),s=pd(n,t,e),o=dt(ue(r));return s.sort((a,l)=>yo(a,o)-yo(l,o)),s}function ud(r,e){return r.map(t=>[t[0]/e.originalWidth,t[1]/e.originalHeight])}function dd(r){const e={};for(let t=0;t<r.length;t++){const i=[r[t],r[(t+1)%r.length]];fd(i).forEach(([n,s])=>{e[n]||(e[n]=[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]),s<e[n][0]&&(e[n][0]=s),s>e[n][1]&&(e[n][1]=s)})}return e}function fd([r,e]){let t=Math.floor(r[0]),i=Math.floor(r[1]);const n=Math.floor(e[0]),s=Math.floor(e[1]),o=[[t,i]];if(t===n&&i===s)return o;const a=Math.sign(e[0]-r[0]),l=Math.sign(e[1]-r[1]),c=Math.abs(r[0]-t-Math.max(0,a)),h=Math.abs(r[1]-i-Math.max(0,l)),u=Math.abs(r[0]-e[0]),g=Math.abs(r[1]-e[1]);let y=c/u,v=h/g;const E=1/u,P=1/g;for(;!(t===n&&i===s);)y<v?(y=y+E,t=t+a):(v=v+P,i=i+l),o.push([t,i]);return o}function pd(r,e,t){const i=[];for(const n in r){const s=parseInt(n);if(s<0||s>=t.columns)break;const o=Math.max(r[s][0],0),a=Math.min(r[s][1],t.rows-1);for(let l=o;l<=a;l++)i.push({column:s,row:l,tileZoomLevel:t,imageSize:[e.width,e.height]})}return i}function gd(r){return(r.imageRequest.size?.height||0)*(r.imageRequest.size?.width||0)*3}function yo(r,e){return xe(md(r),e)}function md(r){const e=wo(r);return[(e[2]-e[0])/2+e[0],(e[3]-e[1])/2+e[1]]}function vd(r){const e=r.column*r.tileZoomLevel.originalWidth,t=r.row*r.tileZoomLevel.originalHeight;return[e,t]}function wo(r){const e=vd(r),t=Math.min(e[0]+r.tileZoomLevel.originalWidth,r.imageSize[0]),i=Math.min(e[1]+r.tileZoomLevel.originalHeight,r.imageSize[1]);return[e[0],e[1],t,i]}function xo(r,e,t){const i=r.createShader(e);if(i){if(r.shaderSource(i,t),r.compileShader(i),r.getShaderParameter(i,r.COMPILE_STATUS))return i;{const n=r.getShaderInfoLog(i);throw r.deleteShader(i),new Error("Failed to compile shader: "+n)}}else throw new Error("Failed to create shader")}function yd(r,e,t){const i=r.createProgram();if(i){if(r.attachShader(i,e),r.attachShader(i,t),r.linkProgram(i),r.getProgramParameter(i,r.LINK_STATUS))return i;{const n=r.getProgramInfoLog(i);throw r.deleteProgram(i),new Error("Failed to link program: "+n)}}else throw new Error("Failed to create program")}function Pt(r,e,t,i,n){const s=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,s),r.bufferData(r.ARRAY_BUFFER,t,r.STATIC_DRAW);const o=r.FLOAT,a=!1,l=0,c=0,h=r.getAttribLocation(e,n);r.vertexAttribPointer(h,i,o,a,l,c),r.enableVertexAttribArray(h)}const wd=100,xd={leading:!0,trailing:!0},_d=1,bd=1;function Md(r,e){return(t,i,n)=>new Td(t,i,r,e,n)}let Td=class extends Lu{gl;program;vao;CachedTilesByTileUrl=new Map;opacity=_d;saturation=bd;renderOptions={};packedTilesTexture;packedTilesPositionsTexture;packedTilesResourcePositionsAndDimensionsTexture;packedTilesScaleFactorsTexture;projectedGeoToClipTransform;throttledUpdateTextures;constructor(e,t,i,n,s){super(e,t,s),this.gl=i,this.program=n,this.vao=i.createVertexArray(),this.packedTilesTexture=i.createTexture(),this.packedTilesScaleFactorsTexture=i.createTexture(),this.packedTilesPositionsTexture=i.createTexture(),this.packedTilesResourcePositionsAndDimensionsTexture=i.createTexture(),this.throttledUpdateTextures=rn(this.updateTextures.bind(this),wd,xd)}updateVertexBuffers(e){this.projectedGeoToClipTransform=e,this.updateVertexBuffersInternal()}addCachedTileAndUpdateTextures(e){this.CachedTilesByTileUrl.set(e.tileUrl,e),this.throttledUpdateTextures()}removeCachedTileAndUpdateTextures(e){this.CachedTilesByTileUrl.delete(e),this.throttledUpdateTextures()}dispose(){this.gl.deleteVertexArray(this.vao),this.gl.deleteTexture(this.packedTilesTexture),this.gl.deleteTexture(this.packedTilesScaleFactorsTexture),this.gl.deleteTexture(this.packedTilesPositionsTexture),this.gl.deleteTexture(this.packedTilesResourcePositionsAndDimensionsTexture)}updateVertexBuffersInternal(){if(!this.vao||!this.projectedGeoToClipTransform)return;this.gl.bindVertexArray(this.vao);const e=this.resourceTrianglePoints;Pt(this.gl,this.program,new Float32Array(e.flat()),2,"a_resourceTrianglePoint");const t=this.projectedGeoPreviousTrianglePoints.map(a=>ut(this.projectedGeoToClipTransform,a));Pt(this.gl,this.program,new Float32Array(t.flat()),2,"a_clipPreviousTrianglePoint");const i=this.projectedGeoTrianglePoints.map(a=>ut(this.projectedGeoToClipTransform,a));Pt(this.gl,this.program,new Float32Array(i.flat()),2,"a_clipTrianglePoint");const n=this.previousTrianglePointsDistortion;Pt(this.gl,this.program,new Float32Array(n),1,"a_previousTrianglePointDistortion");const s=this.trianglePointsDistortion;Pt(this.gl,this.program,new Float32Array(s),1,"a_trianglePointDistortion");const o=new Float32Array(this.resourceTrianglePoints.length).map((a,l)=>Math.round((l-1)/3));Pt(this.gl,this.program,o,1,"a_triangleIndex")}async updateTextures(){const e=this.gl;if(this.CachedTilesByTileUrl.size===0)return;let t=[...this.CachedTilesByTileUrl.values()];t=t.filter(h=>this.resourceViewportRingBbox?fa(wo(h.tile),this.resourceViewportRingBbox):!0);const i=t.length,n=t.map((h,u)=>({w:h.data.width,h:h.data.height,x:0,y:0,index:u})),{w:s,h:o}=ju(n);e.pixelStorei(e.UNPACK_ALIGNMENT,4),e.bindTexture(e.TEXTURE_2D,this.packedTilesTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,s,o,0,e.RGBA,e.UNSIGNED_BYTE,null);for(const h of n){const u=t[h.index].data;e.texSubImage2D(e.TEXTURE_2D,0,h.x,h.y,u.width,u.height,e.RGBA,e.UNSIGNED_BYTE,u)}e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const a=n.map(h=>[h.x,h.y]);e.bindTexture(e.TEXTURE_2D,this.packedTilesPositionsTexture),e.texImage2D(e.TEXTURE_2D,0,e.RG32I,1,i,0,e.RG_INTEGER,e.INT,new Int32Array(a.flat())),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const l=n.map(h=>{const u=t[h.index];if(u&&u.imageRequest&&u.imageRequest.region)return[u.imageRequest.region.x,u.imageRequest.region.y,u.imageRequest.region.width,u.imageRequest.region.height]});e.bindTexture(e.TEXTURE_2D,this.packedTilesResourcePositionsAndDimensionsTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA32I,1,i,0,e.RGBA_INTEGER,e.INT,new Int32Array(l.flat())),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const c=n.map(({index:h})=>t[h].tile.tileZoomLevel.scaleFactor);e.bindTexture(e.TEXTURE_2D,this.packedTilesScaleFactorsTexture),e.texImage2D(e.TEXTURE_2D,0,e.R32I,1,i,0,e.RED_INTEGER,e.INT,new Int32Array(c)),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),this.dispatchEvent(new U(k.TEXTURESUPDATED))}};const Ed=m.string().or(m.number()).or(m.boolean()),Pd=m.record(m.string(),Ed.array()),st=m.tuple([m.number(),m.number()]),_o=m.object({type:m.literal("Point"),coordinates:st}),bo=st.array().min(3),nr=m.enum(["ImageService1","ImageService2","ImageService3"]),ni=m.object({id:m.string().url(),type:m.string(),label:Pd.optional()}).extend({partOf:m.lazy(()=>ni.array()).optional()}),si=m.union([m.any(),m.object({type:m.string(),options:m.object({}).optional()})]).transform(r=>{if(r&&typeof r=="object"&&"type"in r)return r}),oi=m.union([m.string().url().array(),m.string().url()]),Sd=/^<svg\s+width="\d+"\s+height="\d+"\s*>\s*<polygon\s+points="\s*(-?\d+(\.\d+)?,-?\d+(\.\d+)?\s+){2,}-?\d+(\.\d+)?,-?\d+(\.\d+)?\s*"\s*\/>\s*<\/svg>$/,Rd=m.object({type:m.literal("SvgSelector"),value:m.string().regex(Sd)}),Id=m.object({source:m.string().url(),service:m.array(m.object({"@id":m.string().url(),type:nr})).length(1),selector:Rd}),Mo=m.object({pixelCoords:st}),Ad=m.object({type:m.literal("FeatureCollection"),transformation:si.optional(),features:m.array(m.object({type:m.literal("Feature"),properties:Mo,geometry:_o}))}),sn=m.object({id:m.string().optional(),type:m.literal("Annotation"),"@context":oi.optional(),motivation:m.string().default("georeferencing").optional(),target:Id,body:Ad}),To=m.object({id:m.string().optional(),type:m.literal("AnnotationPage"),"@context":oi.optional(),items:m.array(sn)}),on=/<polygon\s+points="\s*(-?\d+(\.\d+)?,-?\d+(\.\d+)?\s+){2,}-?\d+(\.\d+)?,-?\d+(\.\d+)?\s*"\s*\/>/,Cd=new RegExp(`^<svg\\s+width="\\d+"\\s+height="\\d+"\\s*>\\s*${on.source}\\s*</svg>$`),kd=new RegExp(`^<svg\\s+height="\\d+"\\s+width="\\d+"\\s*>\\s*${on.source}\\s*</svg>$`),Ld=new RegExp(`^<svg\\s*>\\s*${on.source}\\s*</svg>$`),jd=m.string().regex(Ld),Od=m.string().regex(Cd),Nd=m.string().regex(kd),Dd=m.object({type:m.literal("SvgSelector"),value:jd.or(Od).or(Nd)}),Fd=m.object({"@id":m.string().url(),type:nr,height:m.number().positive(),width:m.number().positive(),partOf:ni.array().optional()}),Gd=m.object({id:m.string().url(),type:nr,height:m.number().positive(),width:m.number().positive(),partOf:ni.array().optional()}),Bd=m.object({type:m.literal("SpecificResource"),source:Fd.or(Gd),selector:Dd}),Eo=m.object({resourceCoords:st}),Ud=m.object({type:m.literal("FeatureCollection"),transformation:si.optional(),features:m.array(m.object({type:m.literal("Feature"),properties:Eo,geometry:_o}))}),an=m.object({id:m.string().optional(),type:m.literal("Annotation"),"@context":oi.optional(),motivation:m.string().default("georeferencing").optional(),created:m.string().datetime().optional(),modified:m.string().datetime().optional(),target:Bd,body:Ud}),Po=m.object({id:m.string().optional(),type:m.literal("AnnotationPage"),"@context":oi.optional(),items:m.array(an)});sn.or(an),To.or(Po),Mo.or(Eo);function So(r){return Array.isArray(r)}function Wd(r){return!!(r&&typeof r=="object"&&"type"in r&&r.type==="AnnotationPage")}function ai(r){return!!(r&&typeof r=="object"&&"type"in r&&r.type==="GeoreferencedMap")}function Ro(r){return!!(r&&typeof r=="object"&&"target"in r&&r.target&&typeof r.target=="object"&&"source"in r.target&&typeof r.target.source=="string")}function li(r){return"type"in r&&r.type==="GeoreferencedMap"}function ci(r){return"source"in r.target&&typeof r.target.source=="object"}function zd(r){return{id:Vd(r),...Yd(r),type:$d(r),partOf:qd(r)}}function Vd(r){if(ci(r)){const e=r.target.source;return"id"in e?e.id:e["@id"]}else return r.target.service[0]["@id"]}function $d(r){return"service"in r.target?r.target.service[0].type:r.target.source.type}function qd(r){if(ci(r))return r.target.source.partOf}function Zd(r){return"pixelCoords"in r?r.pixelCoords:r.resourceCoords}function Xd(r){return r.body.features.map(e=>({resource:Zd(e.properties),geo:e.geometry.coordinates}))}function Hd(r){if(ci(r))return{created:r.created,modified:r.modified}}function Yd(r){if(ci(r))return{width:r.target.source.width,height:r.target.source.height};const t=r.target.selector.value,i=/width="(?<width>\d+)"/.exec(t),n=/height="(?<height>\d+)"/.exec(t),s=i?.groups?.width,o=n?.groups?.height;if(!s||!o)throw new Error("Could not parse image dimensions");return{width:parseInt(s),height:parseInt(o)}}function Jd(r){const t=r.target.selector.value,n=/points="(?<points>.+)"/.exec(t)?.groups;if(n&&n.points){const s=n.points.trim().split(/\s+/);if(s[0]===s[s.length-1]&&s.splice(-1),s.length>=3)return s.map(o=>{const a=o.split(",");if(a.length===2)return[parseFloat(a[0]),parseFloat(a[1])];throw new Error("Could not parse resource mask")});throw new Error("Could not parse resource mask")}else throw new Error("Could not parse resource mask")}function Io(r){return{"@context":"https://web.archive.org/web/20240616124036/https://schemas.allmaps.org/map/2/context.json",type:"GeoreferencedMap",id:r.id,...Hd(r),resource:zd(r),gcps:Xd(r),resourceMask:Jd(r),transformation:r.body.transformation}}function ln(r){if(Wd(r)){let e;return"items"in r&&Array.isArray(r.items)&&Ro(r.items[0])?e=To.parse(r):e=Po.parse(r),e.items.map(t=>Io(t))}else{let e;return Ro(r)?e=sn.parse(r):e=an.parse(r),[Io(e)]}}const Ao=m.object({image:st,world:st}),Qd=m.object({uri:m.string().url(),width:m.number(),height:m.number(),type:nr}),hi=m.object({id:m.string().optional(),version:m.number().min(1).max(1).default(1),image:Qd,gcps:Ao.array(),pixelMask:bo,transformation:si.optional()}),cn=m.array(hi),Co=m.object({resource:st,geo:st}),Kd=m.object({id:m.string().url(),width:m.number(),height:m.number(),type:nr,partOf:ni.array().optional()}),ui=m.object({"@context":m.literal("https://web.archive.org/web/20240616124036/https://schemas.allmaps.org/map/2/context.json").optional(),type:m.literal("GeoreferencedMap"),id:m.string().optional(),created:m.string().datetime().optional(),modified:m.string().datetime().optional(),resource:Kd,gcps:Co.array(),resourceMask:bo,transformation:si.optional()}),hn=m.array(ui);hi.or(ui),cn.or(hn),Ao.or(Co);function ef(r){let e,t,i;return li(r)?(e=r.resource.width,t=r.resource.height,i=r.resourceMask):(e=r.image.width,t=r.image.height,i=r.pixelMask),{type:"SvgSelector",value:`<svg width="${e}" height="${t}"><polygon points="${i.map(n=>n.join(",")).join(" ")}" /></svg>`}}function tf(r){let e,t,i,n,s;return li(r)?(e=r.resource.id,t=r.resource.type,i=r.resource.width,n=r.resource.height,s=r.resource.partOf):(e=r.image.uri,t=r.image.type,i=r.image.width,n=r.image.height),{id:e,type:t,height:n,width:i,partOf:s}}function rf(r){if(li(r))return{created:r.created,modified:r.modified}}function nf(){return["https://web.archive.org/web/20240616124036/http://iiif.io/api/extension/georef/1/context.json","https://web.archive.org/web/20240616124036/http://iiif.io/api/presentation/3/context.json"]}function sf(r){let e,t;return"resource"in r?(e=r.resource,t=r.geo):(e=r.image,t=r.world),{type:"Feature",properties:{resourceCoords:e},geometry:{type:"Point",coordinates:t}}}function ko(r){const e={type:"SpecificResource",source:tf(r),selector:ef(r)},t={type:"FeatureCollection",transformation:r.transformation,features:r.gcps.map(i=>sf(i))};return{id:r.id,type:"Annotation","@context":nf(),...rf(r),motivation:"georeferencing",target:e,body:t}}function of(r){if(So(r)){let e;return ai(r[0])?e=hn.parse(r):e=cn.parse(r),{type:"AnnotationPage","@context":"http://www.w3.org/ns/anno.jsonld",items:e.map(i=>ko(i))}}else{let e;return ai(r)?e=ui.parse(r):e=hi.parse(r),ko(e)}}function Lo(r){return li(r)?r:ln(of(r))[0]}function af(r){return r.map(Lo)}function jo(r){if(So(r)){let e;return ai(r[0])?e=hn.parse(r):e=cn.parse(r),af(e)}else{let e;return ai(r)?e=ui.parse(r):e=hi.parse(r),Lo(e)}}function lf(r,e,t,i,n){Oo(r,e,t||0,i||r.length-1,n||cf)}function Oo(r,e,t,i,n){for(;i>t;){if(i-t>600){var s=i-t+1,o=e-t+1,a=Math.log(s),l=.5*Math.exp(2*a/3),c=.5*Math.sqrt(a*l*(s-l)/s)*(o-s/2<0?-1:1),h=Math.max(t,Math.floor(e-o*l/s+c)),u=Math.min(i,Math.floor(e+(s-o)*l/s+c));Oo(r,e,h,u,n)}var g=r[e],y=t,v=i;for(sr(r,t,e),n(r[i],g)>0&&sr(r,t,i);y<v;){for(sr(r,y,v),y++,v--;n(r[y],g)<0;)y++;for(;n(r[v],g)>0;)v--}n(r[t],g)===0?sr(r,t,v):(v++,sr(r,v,i)),v<=e&&(t=v+1),e<=v&&(i=v-1)}}function sr(r,e,t){var i=r[e];r[e]=r[t],r[t]=i}function cf(r,e){return r<e?-1:r>e?1:0}class hf{constructor(e=9){this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(e){let t=this.data;const i=[];if(!fi(e,t))return i;const n=this.toBBox,s=[];for(;t;){for(let o=0;o<t.children.length;o++){const a=t.children[o],l=t.leaf?n(a):a;fi(e,l)&&(t.leaf?i.push(a):dn(e,l)?this._all(a,i):s.push(a))}t=s.pop()}return i}collides(e){let t=this.data;if(!fi(e,t))return!1;const i=[];for(;t;){for(let n=0;n<t.children.length;n++){const s=t.children[n],o=t.leaf?this.toBBox(s):s;if(fi(e,o)){if(t.leaf||dn(e,o))return!0;i.push(s)}}t=i.pop()}return!1}load(e){if(!(e&&e.length))return this;if(e.length<this._minEntries){for(let i=0;i<e.length;i++)this.insert(e[i]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(!this.data.children.length)this.data=t;else if(this.data.height===t.height)this._splitRoot(this.data,t);else{if(this.data.height<t.height){const i=this.data;this.data=t,t=i}this._insert(t,this.data.height-t.height-1,!0)}return this}insert(e){return e&&this._insert(e,this.data.height-1),this}clear(){return this.data=Rt([]),this}remove(e,t){if(!e)return this;let i=this.data;const n=this.toBBox(e),s=[],o=[];let a,l,c;for(;i||s.length;){if(i||(i=s.pop(),l=s[s.length-1],a=o.pop(),c=!0),i.leaf){const h=uf(e,i.children,t);if(h!==-1)return i.children.splice(h,1),s.push(i),this._condense(s),this}!c&&!i.leaf&&dn(i,n)?(s.push(i),o.push(a),a=0,l=i,i=i.children[0]):l?(a++,i=l.children[a],c=!1):i=null}return this}toBBox(e){return e}compareMinX(e,t){return e.minX-t.minX}compareMinY(e,t){return e.minY-t.minY}toJSON(){return this.data}fromJSON(e){return this.data=e,this}_all(e,t){const i=[];for(;e;)e.leaf?t.push(...e.children):i.push(...e.children),e=i.pop();return t}_build(e,t,i,n){const s=i-t+1;let o=this._maxEntries,a;if(s<=o)return a=Rt(e.slice(t,i+1)),St(a,this.toBBox),a;n||(n=Math.ceil(Math.log(s)/Math.log(o)),o=Math.ceil(s/Math.pow(o,n-1))),a=Rt([]),a.leaf=!1,a.height=n;const l=Math.ceil(s/o),c=l*Math.ceil(Math.sqrt(o));No(e,t,i,c,this.compareMinX);for(let h=t;h<=i;h+=c){const u=Math.min(h+c-1,i);No(e,h,u,l,this.compareMinY);for(let g=h;g<=u;g+=l){const y=Math.min(g+l-1,u);a.children.push(this._build(e,g,y,n-1))}}return St(a,this.toBBox),a}_chooseSubtree(e,t,i,n){for(;n.push(t),!(t.leaf||n.length-1===i);){let s=1/0,o=1/0,a;for(let l=0;l<t.children.length;l++){const c=t.children[l],h=un(c),u=pf(e,c)-h;u<o?(o=u,s=h<s?h:s,a=c):u===o&&h<s&&(s=h,a=c)}t=a||t.children[0]}return t}_insert(e,t,i){const n=i?e:this.toBBox(e),s=[],o=this._chooseSubtree(n,this.data,t,s);for(o.children.push(e),ar(o,n);t>=0&&s[t].children.length>this._maxEntries;)this._split(s,t),t--;this._adjustParentBBoxes(n,s,t)}_split(e,t){const i=e[t],n=i.children.length,s=this._minEntries;this._chooseSplitAxis(i,s,n);const o=this._chooseSplitIndex(i,s,n),a=Rt(i.children.splice(o,i.children.length-o));a.height=i.height,a.leaf=i.leaf,St(i,this.toBBox),St(a,this.toBBox),t?e[t-1].children.push(a):this._splitRoot(i,a)}_splitRoot(e,t){this.data=Rt([e,t]),this.data.height=e.height+1,this.data.leaf=!1,St(this.data,this.toBBox)}_chooseSplitIndex(e,t,i){let n,s=1/0,o=1/0;for(let a=t;a<=i-t;a++){const l=or(e,0,a,this.toBBox),c=or(e,a,i,this.toBBox),h=gf(l,c),u=un(l)+un(c);h<s?(s=h,n=a,o=u<o?u:o):h===s&&u<o&&(o=u,n=a)}return n||i-t}_chooseSplitAxis(e,t,i){const n=e.leaf?this.compareMinX:df,s=e.leaf?this.compareMinY:ff,o=this._allDistMargin(e,t,i,n),a=this._allDistMargin(e,t,i,s);o<a&&e.children.sort(n)}_allDistMargin(e,t,i,n){e.children.sort(n);const s=this.toBBox,o=or(e,0,t,s),a=or(e,i-t,i,s);let l=di(o)+di(a);for(let c=t;c<i-t;c++){const h=e.children[c];ar(o,e.leaf?s(h):h),l+=di(o)}for(let c=i-t-1;c>=t;c--){const h=e.children[c];ar(a,e.leaf?s(h):h),l+=di(a)}return l}_adjustParentBBoxes(e,t,i){for(let n=i;n>=0;n--)ar(t[n],e)}_condense(e){for(let t=e.length-1,i;t>=0;t--)e[t].children.length===0?t>0?(i=e[t-1].children,i.splice(i.indexOf(e[t]),1)):this.clear():St(e[t],this.toBBox)}}function uf(r,e,t){if(!t)return e.indexOf(r);for(let i=0;i<e.length;i++)if(t(r,e[i]))return i;return-1}function St(r,e){or(r,0,r.children.length,e,r)}function or(r,e,t,i,n){n||(n=Rt(null)),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(let s=e;s<t;s++){const o=r.children[s];ar(n,r.leaf?i(o):o)}return n}function ar(r,e){return r.minX=Math.min(r.minX,e.minX),r.minY=Math.min(r.minY,e.minY),r.maxX=Math.max(r.maxX,e.maxX),r.maxY=Math.max(r.maxY,e.maxY),r}function df(r,e){return r.minX-e.minX}function ff(r,e){return r.minY-e.minY}function un(r){return(r.maxX-r.minX)*(r.maxY-r.minY)}function di(r){return r.maxX-r.minX+(r.maxY-r.minY)}function pf(r,e){return(Math.max(e.maxX,r.maxX)-Math.min(e.minX,r.minX))*(Math.max(e.maxY,r.maxY)-Math.min(e.minY,r.minY))}function gf(r,e){const t=Math.max(r.minX,e.minX),i=Math.max(r.minY,e.minY),n=Math.min(r.maxX,e.maxX),s=Math.min(r.maxY,e.maxY);return Math.max(0,n-t)*Math.max(0,s-i)}function dn(r,e){return r.minX<=e.minX&&r.minY<=e.minY&&e.maxX<=r.maxX&&e.maxY<=r.maxY}function fi(r,e){return e.minX<=r.maxX&&e.minY<=r.maxY&&e.maxX>=r.minX&&e.maxY>=r.minY}function Rt(r){return{children:r,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function No(r,e,t,i,n){const s=[e,t];for(;s.length;){if(t=s.pop(),e=s.pop(),t-e<=i)continue;const o=e+Math.ceil((t-e)/i/2)*i;lf(r,o,e,t,n),s.push(e,o,o,t)}}function mf(r,e,t){if(t===void 0&&(t={}),!r)throw new Error("point is required");if(!e)throw new Error("polygon is required");var i=wt(r),n=lc(e),s=n.type,o=e.bbox,a=n.coordinates;if(o&&vf(i,o)===!1)return!1;s==="Polygon"&&(a=[a]);for(var l=!1,c=0;c<a.length&&!l;c++)if(Do(i,a[c][0],t.ignoreBoundary)){for(var h=!1,u=1;u<a[c].length&&!h;)Do(i,a[c][u],!t.ignoreBoundary)&&(h=!0),u++;h||(l=!0)}return l}function Do(r,e,t){var i=!1;e[0][0]===e[e.length-1][0]&&e[0][1]===e[e.length-1][1]&&(e=e.slice(0,e.length-1));for(var n=0,s=e.length-1;n<e.length;s=n++){var o=e[n][0],a=e[n][1],l=e[s][0],c=e[s][1],h=r[1]*(o-l)+a*(l-r[0])+c*(r[0]-o)===0&&(o-r[0])*(l-r[0])<=0&&(a-r[1])*(c-r[1])<=0;if(h)return!t;var u=a>r[1]!=c>r[1]&&r[0]<(l-o)*(r[1]-a)/(c-a)+o;u&&(i=!i)}return i}function vf(r,e){return e[0]<=r[0]&&e[1]<=r[1]&&e[2]>=r[0]&&e[3]>=r[1]}const yf=!0;let wf=class{rbush=new hf;polygonsById=new Map;bboxesById=new Map;itemsById=new Map;addItem(e,t){this.removeItem(e);const i=ue(t),n={minX:i[0],minY:i[1],maxX:i[2],maxY:i[3],id:e};this.polygonsById.set(e,t),this.bboxesById.set(e,i),this.itemsById.set(e,n),this.rbush.insert(n)}removeItem(e){const t=this.itemsById.get(e);t&&(this.rbush.remove(t),this.polygonsById.delete(e),this.bboxesById.delete(e),this.itemsById.delete(e))}clear(){this.polygonsById.clear(),this.bboxesById.clear(),this.itemsById.clear(),this.rbush.clear()}search(e,t,i,n){return this.rbush.search({minX:e,minY:t,maxX:i,maxY:n})}getBbox(e){return this.bboxesById.get(e)}getPolygon(e){return this.polygonsById.get(e)}searchFromBbox(e){const[t,i,n,s]=e;return this.search(t,i,n,s).map(o=>o.id)}searchFromPoint(e,t=yf){const[i,n,s,o]=[e[0],e[1],e[0],e[1]],a=this.search(i,n,s,o);return t?a.filter(l=>{const c=this.polygonsById.get(l.id);return c?mf(e,c):!1}).map(l=>l.id):a.map(l=>l.id)}};function xf(){return{createRTree:!0,imageInformations:new Map}}let _f=class extends EventTarget{warpedMapFactory;warpedMapsById=new Map;zIndices=new Map;rtree;imageInformations;transformation;fetchFn;constructor(e,t){super(),this.warpedMapFactory=e,t={...xf(),...t},this.fetchFn=t?.fetchFn,this.imageInformations=t.imageInformations,this.transformation=t.transformation,t.createRTree&&(this.rtree=new wf)}getMapIds(){return this.warpedMapsById.keys()}getWarpedMaps(e){if(e===void 0)return this.warpedMapsById.values();{const t=[];for(const i of e){const n=this.warpedMapsById.get(i);n&&t.push(n)}return t}}getWarpedMap(e){return this.warpedMapsById.get(e)}getMapZIndex(e){return this.zIndices.get(e)}getCenter(){const e=this.getBbox();if(e)return dt(e)}getProjectedCenter(){const e=this.getProjectedBbox();if(e)return dt(e)}getBbox(){let e;for(const t of this.getWarpedMaps())t.visible&&(e?e=Tn(e,t.geoMaskBbox):e=t.geoMaskBbox);return e}getProjectedBbox(){let e;for(const t of this.getWarpedMaps())t.visible&&(e?e=Tn(e,t.projectedGeoMaskBbox):e=t.projectedGeoMaskBbox);return e}getMapsByGeoBbox(e){return this.rtree?this.rtree.searchFromBbox(e):Array.from(this.warpedMapsById.keys())}setImageInformations(e){this.imageInformations=e}setMapResourceMask(e,t){const i=this.warpedMapsById.get(e);i&&(i.setResourceMask(t),this.addToOrUpdateRtree(i),this.dispatchEvent(new U(k.RESOURCEMASKUPDATED,e)))}setMapsTransformationType(e,t){const i=[];for(const n of e){const s=this.warpedMapsById.get(n);s&&s.transformationType!=t&&(s.setTransformationType(t),this.addToOrUpdateRtree(s),i.push(n))}i.length>0&&this.dispatchEvent(new U(k.TRANSFORMATIONCHANGED,i))}setMapsDistortionMeasure(e,t){const i=[];for(const n of e){const s=this.warpedMapsById.get(n);s&&s.distortionMeasure!=t&&(s.setDistortionMeasure(t),i.push(n))}i.length>0&&this.dispatchEvent(new U(k.DISTORTIONCHANGED,i))}bringMapsToFront(e){let t=this.warpedMapsById.size;for(const i of e)this.zIndices.has(i)&&(this.zIndices.set(i,t),t++);this.removeZIndexHoles(),this.dispatchEvent(new U(k.ZINDICESCHANGES))}sendMapsToBack(e){let t=-Array.from(e).length;for(const i of e)this.zIndices.has(i)&&(this.zIndices.set(i,t),t++);this.removeZIndexHoles(),this.dispatchEvent(new U(k.ZINDICESCHANGES))}bringMapsForward(e){for(const[t,i]of this.zIndices.entries())this.zIndices.set(t,i*2);for(const t of e){const i=this.zIndices.get(t);i!==void 0&&this.zIndices.set(t,i+3)}this.removeZIndexHoles(),this.dispatchEvent(new U(k.ZINDICESCHANGES))}sendMapsBackward(e){for(const[t,i]of this.zIndices.entries())this.zIndices.set(t,i*2);for(const t of e){const i=this.zIndices.get(t);i!==void 0&&this.zIndices.set(t,i-3)}this.removeZIndexHoles(),this.dispatchEvent(new U(k.ZINDICESCHANGES))}showMaps(e){for(const t of e){const i=this.warpedMapsById.get(t);i&&(i.visible=!0)}this.dispatchEvent(new U(k.VISIBILITYCHANGED,e))}hideMaps(e){for(const t of e){const i=this.warpedMapsById.get(t);i&&(i.visible=!1)}this.dispatchEvent(new U(k.VISIBILITYCHANGED,e))}async addGeoreferencedMap(e){const t=jo(e),i=Array.isArray(t)?t[0]:t;return this.addGeoreferencedMapInternal(i)}async removeGeoreferencedMap(e){const t=jo(e),i=Array.isArray(t)?t[0]:t;return this.removeGeoreferencedMapInternal(i)}async addGeoreferenceAnnotation(e){const t=[],i=ln(e),n=await Promise.allSettled(i.map(s=>this.addGeoreferencedMapInternal(s)));for(const s of n)s.status==="fulfilled"?t.push(s.value):t.push(s.reason);return this.dispatchEvent(new U(k.GEOREFERENCEANNOTATIONADDED)),this.dispatchEvent(new U(k.ZINDICESCHANGES)),t}async removeGeoreferenceAnnotation(e){const t=[],i=ln(e);for(const n of i){const s=await this.removeGeoreferencedMapInternal(n);t.push(s)}return this.dispatchEvent(new U(k.GEOREFERENCEANNOTATIONREMOVED)),t}clear(){this.warpedMapsById=new Map,this.zIndices=new Map,this.rtree?.clear(),this.dispatchEvent(new U(k.CLEARED))}dispose(){for(const e of this.getWarpedMaps())this.removeEventListenersFromWarpedMap(e),e.dispose()}async addGeoreferencedMapInternal(e){const t=await this.getOrComputeMapId(e),i=this.warpedMapFactory(t,e,{imageInformations:this.imageInformations,fetchFn:this.fetchFn,transformation:this.transformation});return this.warpedMapsById.set(t,i),this.zIndices.set(t,this.warpedMapsById.size-1),this.addToOrUpdateRtree(i),this.addEventListenersToWarpedMap(i),this.dispatchEvent(new U(k.WARPEDMAPADDED,t)),t}async removeGeoreferencedMapInternal(e){const t=await this.getOrComputeMapId(e),i=this.warpedMapsById.get(t);if(i)this.warpedMapsById.delete(t),this.zIndices.delete(t),this.removeFromRtree(i),this.dispatchEvent(new U(k.WARPEDMAPREMOVED,t)),this.removeZIndexHoles(),this.dispatchEvent(new U(k.ZINDICESCHANGES));else throw new Error(`No map found with ID ${t}`);return t}async getOrComputeMapId(e){return e.id||await Aa(e)}addToOrUpdateRtree(e){this.rtree&&(this.rtree.removeItem(e.mapId),this.rtree.addItem(e.mapId,e.geoMask))}removeFromRtree(e){this.rtree&&this.rtree.removeItem(e.mapId)}removeZIndexHoles(){const e=[...this.zIndices.entries()].sort((i,n)=>i[1]-n[1]);let t=0;for(const i of e){const n=i[0];this.zIndices.set(n,t),t++}}imageInfoLoaded(){this.dispatchEvent(new U(k.IMAGEINFOLOADED))}addEventListenersToWarpedMap(e){e.addEventListener(k.IMAGEINFOLOADED,this.imageInfoLoaded.bind(this))}removeEventListenersFromWarpedMap(e){e.removeEventListener(k.IMAGEINFOLOADED,this.imageInfoLoaded.bind(this))}};class bf extends EventTarget{tile;imageRequest;tileUrl;fetchFn;abortController;data;constructor(e,t){super(),this.tile=e.tile,this.imageRequest=e.imageRequest,this.tileUrl=e.tileUrl,this.fetchFn=t,this.abortController=new AbortController}isCachedTile(){return this.data!==void 0}abort(){this.abortController.signal.aborted||this.abortController.abort()}}class Mf{mapId;tile;imageRequest;tileUrl;constructor(e,t){this.mapId=t.mapId,this.tile=e;const i=t.parsedImage.getIiifTile(e.tileZoomLevel,e.column,e.row);this.imageRequest=i,this.tileUrl=t.parsedImage.getImageUrl(i)}}class fn extends bf{async fetch(){try{const e=await(await wn(this.tileUrl,{signal:this.abortController.signal},this.fetchFn)).blob();this.data=await createImageBitmap(e),this.dispatchEvent(new U(k.TILEFETCHED,this.tileUrl))}catch(e){e instanceof Error&&e.name==="AbortError"||this.dispatchEvent(new U(k.TILEFETCHERROR,this.tileUrl))}return this.data}static createFactory(){return(e,t)=>new fn(e,t)}}const Tf=0,Ef=32*1e3*1e3;class Pf extends EventTarget{cachableTileFactory;fetchFn;tilesByTileUrl=new Map;mapIdsByTileUrl=new Map;tileUrlsByMapId=new Map;tilesFetchingCount=0;previousRequestedTiles=[];outgoingTilesHistory=[];constructor(e,t){super(),this.cachableTileFactory=e,this.fetchFn=t?.fetchFn}getCacheableTile(e){return this.tilesByTileUrl.get(e)}getCachedTile(e){const t=this.tilesByTileUrl.get(e);if(t&&t.isCachedTile())return t}getCacheableTiles(){return this.tilesByTileUrl.values()}getCachedTiles(){const e=[];for(const t of this.tilesByTileUrl.values())t.isCachedTile()&&e.push(t);return e}getCachedTilesForMapId(e){const t=[];for(const i of this.tilesByTileUrl.values())i.isCachedTile()&&this.tileUrlsByMapId.get(e)?.has(i.tileUrl)&&t.push(i);return t}getTileUrls(){return this.tilesByTileUrl.keys()}requestFetchableTiles(e){const t=nn(this.previousRequestedTiles),i=nn(e);if(va(t,i))return;const n=[];for(const a of this.previousRequestedTiles)i.has(vo(a))||n.push(a);this.updateOutgoingTilesHistory(n,e.length);const s=nn(this.outgoingTilesHistory),o=new Set([...i,...s]);for(const[a,l]of this.mapIdsByTileUrl)for(const c of l)o.has(mo(c,a))||this.removeMapTile(c,a);for(const a of e)this.addMapTile(a);this.previousRequestedTiles=e}async allRequestedTilesLoaded(){return new Promise(e=>{if(this.finished)e();else{const t=()=>{this.removeEventListener(k.ALLREQUESTEDTILESLOADED,t),e()};this.addEventListener(k.ALLREQUESTEDTILESLOADED,t)}})}getTileUrlsForMapId(e){return this.tileUrlsByMapId.get(e)||new Set}clear(){this.tilesByTileUrl=new Map,this.mapIdsByTileUrl=new Map,this.tileUrlsByMapId=new Map,this.tilesFetchingCount=0,this.outgoingTilesHistory=[]}dispose(){for(const e of this.getCacheableTiles())this.removeEventListenersFromTile(e)}addMapTile(e){const t=e.mapId,i=e.tileUrl;if(this.tilesByTileUrl.has(i))this.dispatchEvent(new U(k.MAPTILELOADED,{mapId:t,tileUrl:i}));else{const n=this.cachableTileFactory(e,this.fetchFn);this.addEventListenersToTile(n),this.tilesByTileUrl.set(i,n),this.updateTilesFetchingCount(1),n.fetch()}this.addTileUrlForMapId(t,i),this.addMapIdForTileUrl(t,i)}removeMapTile(e,t){const i=this.tilesByTileUrl.get(t);if(!i)return;const n=this.removeMapIdForTileUrl(e,t);this.removeTileUrlForMapId(e,t),n.size||(i.isCachedTile()||(i.abort(),this.updateTilesFetchingCount(-1)),this.tilesByTileUrl.delete(t)),this.dispatchEvent(new U(k.MAPTILEREMOVED,{mapId:e,tileUrl:t}))}updateOutgoingTilesHistory(e,t){for(let o=e.length-1;o>=0;o--){const a=e[o];this.outgoingTilesHistory.unshift(a)}this.outgoingTilesHistory=Array.from(new Set(this.outgoingTilesHistory));let i=0,n=0,s=0;for(const o of this.outgoingTilesHistory){if(i+=1,s=gd(o),n+=s,i+t>Tf){i-=1,n-=s;break}if(n>Ef){i-=1,n-=s;break}}this.outgoingTilesHistory=this.outgoingTilesHistory.slice(0,i)}tileFetched(e){if(e instanceof U){const t=e.data;this.updateTilesFetchingCount(-1);for(const i of this.mapIdsByTileUrl.get(t)||[])this.dispatchEvent(new U(k.MAPTILELOADED,{mapId:i,tileUrl:t})),this.tileUrlsByMapId.get(i)?.values().next().value===t&&this.dispatchEvent(new U(k.FIRSTMAPTILELOADED,{mapId:i,tileUrl:t}))}}tileFetchError(e){if(e instanceof U){const t=e.data;this.tilesByTileUrl.has(t)||this.updateTilesFetchingCount(-1)}}addMapIdForTileUrl(e,t){let i=this.mapIdsByTileUrl.get(t);return i?i.add(e):i=new Set([e]),this.mapIdsByTileUrl.set(t,i),i}removeMapIdForTileUrl(e,t){const i=this.mapIdsByTileUrl.get(t);if(i)i.delete(e);else return new Set;return i.size?this.mapIdsByTileUrl.set(t,i):this.mapIdsByTileUrl.delete(t),i}addTileUrlForMapId(e,t){let i=this.tileUrlsByMapId.get(e);return i?i.add(t):i=new Set([t]),this.tileUrlsByMapId.set(e,i),i}removeTileUrlForMapId(e,t){const i=this.tileUrlsByMapId.get(e);return i?(i.delete(t),i.size?this.tileUrlsByMapId.set(e,i):this.tileUrlsByMapId.delete(e),i):new Set}get finished(){return this.tilesFetchingCount===0}updateTilesFetchingCount(e){this.tilesFetchingCount+=e,this.tilesFetchingCount===0&&this.dispatchEvent(new U(k.ALLREQUESTEDTILESLOADED))}addEventListenersToTile(e){e.addEventListener(k.TILEFETCHED,this.tileFetched.bind(this)),e.addEventListener(k.TILEFETCHERROR,this.tileFetchError.bind(this))}removeEventListenersFromTile(e){e.removeEventListener(k.TILEFETCHED,this.tileFetched.bind(this)),e.removeEventListener(k.TILEFETCHERROR,this.tileFetchError.bind(this))}}const Sf=5;class Rf extends EventTarget{warpedMapList;tileCache;mapsInViewport=new Set;viewport;constructor(e,t,i){super(),this.tileCache=new Pf(e,i),this.warpedMapList=new _f(t,i)}async addGeoreferenceAnnotation(e){return this.warpedMapList.addGeoreferenceAnnotation(e)}async addGeoreferencedMap(e){return this.warpedMapList.addGeoreferencedMap(e)}loadMissingImageInfosInViewport(){return this.viewport?Array.from(this.warpedMapList.getMapsByGeoBbox(this.viewport.geoRectangleBbox)).map(e=>this.warpedMapList.getWarpedMap(e)).filter(e=>!e.hasImageInfo()&&!e.loadingImageInfo).map(e=>e.loadImageInfo()):[]}someImageInfosInViewport(){return this.viewport?Array.from(this.warpedMapList.getMapsByGeoBbox(this.viewport.geoRectangleBbox)).map(e=>this.warpedMapList.getWarpedMap(e)).map(e=>e.hasImageInfo()).some(e=>e===!0):!1}shouldUpdateRequestedTiles(){return!0}updateRequestedTiles(){if(!this.viewport)return;const e=this.viewport;if(!this.shouldUpdateRequestedTiles())return;const t=Array.from(this.warpedMapList.getMapsByGeoBbox(this.viewport.geoRectangleBbox)).sort((n,s)=>{const o=this.warpedMapList.getWarpedMap(n),a=this.warpedMapList.getWarpedMap(s);return o&&a?xe(dt(o.geoMaskBbox),e.geoCenter)-xe(dt(a.geoMaskBbox),e.geoCenter):0}),i=[];for(const n of t){const s=this.warpedMapList.getWarpedMap(n);if(!s||!s.visible||!s.hasImageInfo()||pa(s.getViewportMaskBbox(e))<Sf)continue;const o=cd(s.parsedImage,s.getResourceToCanvasScale(e));s.setBestScaleFactor(o.scaleFactor);const a={maxDepth:0,sourceIsGeographic:!1,destinationIsGeographic:!0},l=s.transformer.transformBackward([e.geoRectangle],a)[0];s.setResourceViewportRing(l);const c=hd(l,o,s.parsedImage);for(const h of c)i.push(new Mf(h,s))}this.tileCache.requestFetchableTiles(i),this.updateMapsInViewport(i)}updateMapsInViewport(e){const t=Array.from(this.mapsInViewport),i=e.map(o=>o.mapId).filter((o,a,l)=>l.indexOf(o)===a);this.mapsInViewport=new Set(i.sort((o,a)=>{const l=this.warpedMapList.getMapZIndex(o),c=this.warpedMapList.getMapZIndex(a);return l!==void 0&&c!==void 0?l-c:0}));const n=i.filter(o=>!t.includes(o)),s=t.filter(o=>!i.includes(o));for(const o in n)this.dispatchEvent(new U(k.WARPEDMAPENTER,o));for(const o in s)this.dispatchEvent(new U(k.WARPEDMAPLEAVE,o))}mapTileLoaded(e){}mapTileRemoved(e){}imageInfoLoaded(e){}warpedMapAdded(e){}warpedMapRemoved(e){}transformationChanged(e){}distortionChanged(e){}addEventListeners(){this.tileCache.addEventListener(k.MAPTILELOADED,this.mapTileLoaded.bind(this)),this.tileCache.addEventListener(k.MAPTILEREMOVED,this.mapTileRemoved.bind(this)),this.warpedMapList.addEventListener(k.IMAGEINFOLOADED,this.imageInfoLoaded.bind(this)),this.warpedMapList.addEventListener(k.WARPEDMAPADDED,this.warpedMapAdded.bind(this)),this.warpedMapList.addEventListener(k.WARPEDMAPREMOVED,this.warpedMapRemoved.bind(this)),this.warpedMapList.addEventListener(k.TRANSFORMATIONCHANGED,this.transformationChanged.bind(this)),this.warpedMapList.addEventListener(k.DISTORTIONCHANGED,this.distortionChanged.bind(this))}removeEventListeners(){this.tileCache.removeEventListener(k.MAPTILELOADED,this.mapTileLoaded.bind(this)),this.tileCache.removeEventListener(k.MAPTILEREMOVED,this.mapTileRemoved.bind(this)),this.warpedMapList.removeEventListener(k.IMAGEINFOLOADED,this.imageInfoLoaded.bind(this)),this.warpedMapList.removeEventListener(k.WARPEDMAPADDED,this.warpedMapAdded.bind(this)),this.warpedMapList.removeEventListener(k.WARPEDMAPREMOVED,this.warpedMapRemoved.bind(this)),this.warpedMapList.removeEventListener(k.TRANSFORMATIONCHANGED,this.transformationChanged.bind(this)),this.warpedMapList.removeEventListener(k.DISTORTIONCHANGED,this.distortionChanged.bind(this))}}var If=`#version 300 es

precision highp float;

uniform mat4 u_renderTransform;

uniform float u_animationProgress;

in vec2 a_resourceTrianglePoint;
in vec2 a_clipPreviousTrianglePoint;
in vec2 a_clipTrianglePoint;
in float a_previousTrianglePointDistortion;
in float a_trianglePointDistortion;
in float a_triangleIndex;

out vec2 v_resourceTrianglePoint;
out float v_trianglePointDistortion;
out float v_triangleIndex;

float cubicInOut(float t) {
  return t < 0.5f ? 4.0f * t * t * t : 0.5f * pow(2.0f * t - 2.0f, 3.0f) + 1.0f;
}

void main() {

  vec2 clipTrianglePoint = mix(a_clipPreviousTrianglePoint, a_clipTrianglePoint, cubicInOut(u_animationProgress));
  float trianglePointDistortion = mix(a_previousTrianglePointDistortion, a_trianglePointDistortion, cubicInOut(u_animationProgress));





  gl_Position = u_renderTransform * vec4(clipTrianglePoint, 0.0f, 1.0f);


  v_resourceTrianglePoint = a_resourceTrianglePoint;
  v_trianglePointDistortion = trianglePointDistortion;
  v_triangleIndex = a_triangleIndex;
}`,Af=`#version 300 es

precision highp float;
precision highp isampler2D;

#ifndef SPECTRAL
#define SPECTRAL

const int SPECTRAL_SIZE = 38;
const float SPECTRAL_GAMMA = 2.4;
const float SPECTRAL_EPSILON = 0.0001;

float spectral_uncompand(float x) {
  return (x < 0.04045) ? x / 12.92 : pow((x + 0.055) / 1.055, SPECTRAL_GAMMA);
}

float spectral_compand(float x) {
  return (x < 0.0031308) ? x * 12.92 : 1.055 * pow(x, 1.0 / SPECTRAL_GAMMA) - 0.055;
}

vec3 spectral_srgb_to_linear(vec3 srgb) {
    return vec3(spectral_uncompand(srgb[0]), spectral_uncompand(srgb[1]), spectral_uncompand(srgb[2]));
}

vec3 spectral_linear_to_srgb(vec3 lrgb) {
    return clamp(vec3(spectral_compand(lrgb[0]), spectral_compand(lrgb[1]), spectral_compand(lrgb[2])), 0.0, 1.0);
}

void spectral_upsampling(vec3 lrgb, out float w, out float c, out float m, out float y, out float r, out float g, out float b) {
    w = min(lrgb.r, min(lrgb.g, lrgb.b));

    lrgb -= w;

    c = min(lrgb.g, lrgb.b);
    m = min(lrgb.r, lrgb.b);
    y = min(lrgb.r, lrgb.g);
    r = min(max(0., lrgb.r - lrgb.b), max(0., lrgb.r - lrgb.g));
    g = min(max(0., lrgb.g - lrgb.b), max(0., lrgb.g - lrgb.r));
    b = min(max(0., lrgb.b - lrgb.g), max(0., lrgb.b - lrgb.r));
}

void spectral_linear_to_reflectance(vec3 lrgb, inout float R[SPECTRAL_SIZE]) {
    float w, c, m, y, r, g, b;

    spectral_upsampling(lrgb, w, c, m, y, r, g, b);

     R[0] = max(SPECTRAL_EPSILON, w + c * 0.96853629 + m * 0.51567122 + y * 0.02055257 + r * 0.03147571 + g * 0.49108579 + b * 0.97901834);
     R[1] = max(SPECTRAL_EPSILON, w + c * 0.96855103 + m * 0.54015520 + y * 0.02059936 + r * 0.03146636 + g * 0.46944057 + b * 0.97901649);
     R[2] = max(SPECTRAL_EPSILON, w + c * 0.96859338 + m * 0.62645502 + y * 0.02062723 + r * 0.03140624 + g * 0.40165780 + b * 0.97901118);
     R[3] = max(SPECTRAL_EPSILON, w + c * 0.96877345 + m * 0.75595012 + y * 0.02073387 + r * 0.03119611 + g * 0.24490420 + b * 0.97892146);
     R[4] = max(SPECTRAL_EPSILON, w + c * 0.96942204 + m * 0.92826996 + y * 0.02114202 + r * 0.03053888 + g * 0.06826880 + b * 0.97858555);
     R[5] = max(SPECTRAL_EPSILON, w + c * 0.97143709 + m * 0.97223624 + y * 0.02233154 + r * 0.02856855 + g * 0.02732883 + b * 0.97743705);
     R[6] = max(SPECTRAL_EPSILON, w + c * 0.97541862 + m * 0.98616174 + y * 0.02556857 + r * 0.02459485 + g * 0.01360600 + b * 0.97428075);
     R[7] = max(SPECTRAL_EPSILON, w + c * 0.98074186 + m * 0.98955255 + y * 0.03330189 + r * 0.01929520 + g * 0.01000187 + b * 0.96663223);
     R[8] = max(SPECTRAL_EPSILON, w + c * 0.98580992 + m * 0.98676237 + y * 0.05185294 + r * 0.01423112 + g * 0.01284127 + b * 0.94822893);
     R[9] = max(SPECTRAL_EPSILON, w + c * 0.98971194 + m * 0.97312575 + y * 0.10087639 + r * 0.01033111 + g * 0.02636635 + b * 0.89937713);
    R[10] = max(SPECTRAL_EPSILON, w + c * 0.99238027 + m * 0.91944277 + y * 0.24000413 + r * 0.00765876 + g * 0.07058713 + b * 0.76070164);
    R[11] = max(SPECTRAL_EPSILON, w + c * 0.99409844 + m * 0.32564851 + y * 0.53589066 + r * 0.00593693 + g * 0.70421692 + b * 0.46420440);
    R[12] = max(SPECTRAL_EPSILON, w + c * 0.99517200 + m * 0.13820628 + y * 0.79874659 + r * 0.00485616 + g * 0.85473994 + b * 0.20123039);
    R[13] = max(SPECTRAL_EPSILON, w + c * 0.99576545 + m * 0.05015143 + y * 0.91186529 + r * 0.00426186 + g * 0.95081565 + b * 0.08808402);
    R[14] = max(SPECTRAL_EPSILON, w + c * 0.99593552 + m * 0.02912336 + y * 0.95399623 + r * 0.00409039 + g * 0.97170370 + b * 0.04592894);
    R[15] = max(SPECTRAL_EPSILON, w + c * 0.99564041 + m * 0.02421691 + y * 0.97137099 + r * 0.00438375 + g * 0.97651888 + b * 0.02860373);
    R[16] = max(SPECTRAL_EPSILON, w + c * 0.99464769 + m * 0.02660696 + y * 0.97939505 + r * 0.00537525 + g * 0.97429245 + b * 0.02060067);
    R[17] = max(SPECTRAL_EPSILON, w + c * 0.99229579 + m * 0.03407586 + y * 0.98345207 + r * 0.00772962 + g * 0.97012917 + b * 0.01656701);
    R[18] = max(SPECTRAL_EPSILON, w + c * 0.98638762 + m * 0.04835936 + y * 0.98553736 + r * 0.01366120 + g * 0.94258630 + b * 0.01451549);
    R[19] = max(SPECTRAL_EPSILON, w + c * 0.96829712 + m * 0.00011720 + y * 0.98648905 + r * 0.03181352 + g * 0.99989207 + b * 0.01357964);
    R[20] = max(SPECTRAL_EPSILON, w + c * 0.89228016 + m * 0.00008554 + y * 0.98674535 + r * 0.10791525 + g * 0.99989891 + b * 0.01331243);
    R[21] = max(SPECTRAL_EPSILON, w + c * 0.53740239 + m * 0.85267882 + y * 0.98657555 + r * 0.46249516 + g * 0.13823139 + b * 0.01347661);
    R[22] = max(SPECTRAL_EPSILON, w + c * 0.15360445 + m * 0.93188793 + y * 0.98611877 + r * 0.84604333 + g * 0.06968113 + b * 0.01387181);
    R[23] = max(SPECTRAL_EPSILON, w + c * 0.05705719 + m * 0.94810268 + y * 0.98559942 + r * 0.94275572 + g * 0.05628787 + b * 0.01435472);
    R[24] = max(SPECTRAL_EPSILON, w + c * 0.03126539 + m * 0.94200977 + y * 0.98507063 + r * 0.96860996 + g * 0.06111561 + b * 0.01479836);
    R[25] = max(SPECTRAL_EPSILON, w + c * 0.02205445 + m * 0.91478045 + y * 0.98460039 + r * 0.97783966 + g * 0.08987709 + b * 0.01515250);
    R[26] = max(SPECTRAL_EPSILON, w + c * 0.01802271 + m * 0.87065445 + y * 0.98425301 + r * 0.98187757 + g * 0.13656016 + b * 0.01540513);
    R[27] = max(SPECTRAL_EPSILON, w + c * 0.01613460 + m * 0.78827548 + y * 0.98403909 + r * 0.98377315 + g * 0.22169624 + b * 0.01557233);
    R[28] = max(SPECTRAL_EPSILON, w + c * 0.01520947 + m * 0.65738359 + y * 0.98388535 + r * 0.98470202 + g * 0.32176956 + b * 0.01565710);
    R[29] = max(SPECTRAL_EPSILON, w + c * 0.01475977 + m * 0.59909403 + y * 0.98376116 + r * 0.98515481 + g * 0.36157329 + b * 0.01571025);
    R[30] = max(SPECTRAL_EPSILON, w + c * 0.01454263 + m * 0.56817268 + y * 0.98368246 + r * 0.98537114 + g * 0.48361920 + b * 0.01571916);
    R[31] = max(SPECTRAL_EPSILON, w + c * 0.01444459 + m * 0.54031997 + y * 0.98365023 + r * 0.98546685 + g * 0.46488579 + b * 0.01572133);
    R[32] = max(SPECTRAL_EPSILON, w + c * 0.01439897 + m * 0.52110241 + y * 0.98361309 + r * 0.98550011 + g * 0.47440306 + b * 0.01572502);
    R[33] = max(SPECTRAL_EPSILON, w + c * 0.01437620 + m * 0.51041094 + y * 0.98357259 + r * 0.98551031 + g * 0.48576990 + b * 0.01571717);
    R[34] = max(SPECTRAL_EPSILON, w + c * 0.01436343 + m * 0.50526577 + y * 0.98353856 + r * 0.98550741 + g * 0.49267971 + b * 0.01571905);
    R[35] = max(SPECTRAL_EPSILON, w + c * 0.01435687 + m * 0.50255080 + y * 0.98351247 + r * 0.98551323 + g * 0.49625685 + b * 0.01571059);
    R[36] = max(SPECTRAL_EPSILON, w + c * 0.01435370 + m * 0.50126452 + y * 0.98350101 + r * 0.98551563 + g * 0.49807754 + b * 0.01569728);
    R[37] = max(SPECTRAL_EPSILON, w + c * 0.01435408 + m * 0.50083021 + y * 0.98350852 + r * 0.98551547 + g * 0.49889859 + b * 0.01570020);
}

vec3 spectral_xyz_to_srgb(vec3 xyz) {
    mat3 XYZ_RGB;

    XYZ_RGB[0] = vec3( 3.24306333, -1.53837619, -0.49893282);
    XYZ_RGB[1] = vec3(-0.96896309,  1.87542451,  0.04154303);
    XYZ_RGB[2] = vec3( 0.05568392, -0.20417438,  1.05799454);

    float r = dot(XYZ_RGB[0], xyz);
    float g = dot(XYZ_RGB[1], xyz);
    float b = dot(XYZ_RGB[2], xyz);

    return spectral_linear_to_srgb(vec3(r, g, b));
}

vec3 spectral_reflectance_to_xyz(float R[SPECTRAL_SIZE]) {
    vec3 xyz = vec3(0.0);

    xyz +=  R[0] * vec3(0.00006469, 0.00000184, 0.00030502);
    xyz +=  R[1] * vec3(0.00021941, 0.00000621, 0.00103681);
    xyz +=  R[2] * vec3(0.00112057, 0.00003101, 0.00531314);
    xyz +=  R[3] * vec3(0.00376661, 0.00010475, 0.01795439);
    xyz +=  R[4] * vec3(0.01188055, 0.00035364, 0.05707758);
    xyz +=  R[5] * vec3(0.02328644, 0.00095147, 0.11365162);
    xyz +=  R[6] * vec3(0.03455942, 0.00228226, 0.17335873);
    xyz +=  R[7] * vec3(0.03722379, 0.00420733, 0.19620658);
    xyz +=  R[8] * vec3(0.03241838, 0.00668880, 0.18608237);
    xyz +=  R[9] * vec3(0.02123321, 0.00988840, 0.13995048);
    xyz += R[10] * vec3(0.01049099, 0.01524945, 0.08917453);
    xyz += R[11] * vec3(0.00329584, 0.02141831, 0.04789621);
    xyz += R[12] * vec3(0.00050704, 0.03342293, 0.02814563);
    xyz += R[13] * vec3(0.00094867, 0.05131001, 0.01613766);
    xyz += R[14] * vec3(0.00627372, 0.07040208, 0.00775910);
    xyz += R[15] * vec3(0.01686462, 0.08783871, 0.00429615);
    xyz += R[16] * vec3(0.02868965, 0.09424905, 0.00200551);
    xyz += R[17] * vec3(0.04267481, 0.09795667, 0.00086147);
    xyz += R[18] * vec3(0.05625475, 0.09415219, 0.00036904);
    xyz += R[19] * vec3(0.06947040, 0.08678102, 0.00019143);
    xyz += R[20] * vec3(0.08305315, 0.07885653, 0.00014956);
    xyz += R[21] * vec3(0.08612610, 0.06352670, 0.00009231);
    xyz += R[22] * vec3(0.09046614, 0.05374142, 0.00006813);
    xyz += R[23] * vec3(0.08500387, 0.04264606, 0.00002883);
    xyz += R[24] * vec3(0.07090667, 0.03161735, 0.00001577);
    xyz += R[25] * vec3(0.05062889, 0.02088521, 0.00000394);
    xyz += R[26] * vec3(0.03547396, 0.01386011, 0.00000158);
    xyz += R[27] * vec3(0.02146821, 0.00810264, 0.00000000);
    xyz += R[28] * vec3(0.01251646, 0.00463010, 0.00000000);
    xyz += R[29] * vec3(0.00680458, 0.00249138, 0.00000000);
    xyz += R[30] * vec3(0.00346457, 0.00125930, 0.00000000);
    xyz += R[31] * vec3(0.00149761, 0.00054165, 0.00000000);
    xyz += R[32] * vec3(0.00076970, 0.00027795, 0.00000000);
    xyz += R[33] * vec3(0.00040737, 0.00014711, 0.00000000);
    xyz += R[34] * vec3(0.00016901, 0.00006103, 0.00000000);
    xyz += R[35] * vec3(0.00009522, 0.00003439, 0.00000000);
    xyz += R[36] * vec3(0.00004903, 0.00001771, 0.00000000);
    xyz += R[37] * vec3(0.00002000, 0.00000722, 0.00000000);

    return xyz;
}

float spectral_linear_to_concentration(float l1, float l2, float t) {
    float t1 = l1 * pow(1.0 - t, 2.0);
    float t2 = l2 * pow(t, 2.0);

    return t2 / (t1 + t2);
}

vec3 spectral_mix(vec3 color1, vec3 color2, float t) {
    vec3 lrgb1 = spectral_srgb_to_linear(color1);
    vec3 lrgb2 = spectral_srgb_to_linear(color2);

    float R1[SPECTRAL_SIZE];
    float R2[SPECTRAL_SIZE];

    spectral_linear_to_reflectance(lrgb1, R1);
    spectral_linear_to_reflectance(lrgb2, R2);

    float l1 = spectral_reflectance_to_xyz(R1)[1];
    float l2 = spectral_reflectance_to_xyz(R2)[1];

    t = spectral_linear_to_concentration(l1, l2, t);

    float R[SPECTRAL_SIZE];

    for (int i = 0; i < SPECTRAL_SIZE; i++) {
      float KS = (1.0 - t) * (pow(1.0 - R1[i], 2.0) / (2.0 * R1[i])) + t * (pow(1.0 - R2[i], 2.0) / (2.0 * R2[i]));
      float KM = 1.0 + KS - sqrt(pow(KS, 2.0) + 2.0 * KS);




      R[i] = KM;
    }

    return spectral_xyz_to_srgb(spectral_reflectance_to_xyz(R));
}

vec4 spectral_mix(vec4 color1, vec4 color2, float t) {
    return vec4(spectral_mix(color1.rgb, color2.rgb, t), mix(color1.a, color2.a, t));
}

#endif

uniform bool u_removeColor;
uniform vec3 u_removeColorOptionsColor;
uniform float u_removeColorOptionsThreshold;
uniform float u_removeColorOptionsHardness;

uniform bool u_colorize;
uniform vec3 u_colorizeOptionsColor;

uniform bool u_grid;

uniform float u_opacity;
uniform float u_saturation;

uniform bool u_distortion;
uniform int u_distortionOptionsdistortionMeasure;

uniform int u_bestScaleFactor;

uniform sampler2D u_packedTilesTexture;
uniform isampler2D u_packedTilesPositionsTexture;
uniform isampler2D u_packedTilesResourcePositionsAndDimensionsTexture;
uniform isampler2D u_packedTilesScaleFactorsTexture;

in vec2 v_resourceTrianglePoint;
in float v_triangleIndex;
in float v_trianglePointDistortion;

out vec4 color;

vec4 rgbToVec4(int r, int g, int b) {
  return vec4(float(r) / 255.0f, float(g) / 255.0f, float(b) / 255.0f, 1.0f);
}

void main() {



  vec4 colorTransparent = vec4(0.0f, 0.0f, 0.0f, 0.0f);
  vec4 colorWhite = vec4(1.0f, 1.0f, 1.0f, 1.0f);
  vec4 colorBlack = vec4(0.0f, 0.0f, 0.0f, 1.0f);

  vec4 colorGreen300 = vec4(0.5254f, 0.9372f, 0.6745f, 1.0f);
  vec4 colorPurple300 = vec4(0.8470f, 0.7058f, 0.9960f, 1.0f);
  vec4 colorRed300 = vec4(0.9882f, 0.6470f, 0.6470f, 1.0f);
  vec4 colorYellow300 = vec4(0.9921f, 0.8784f, 0.2784f, 1.0f);
  vec4 colorOrange300 = vec4(0.9921f, 0.7294f, 0.4549f, 1.0f);
  vec4 colorPink300 = vec4(0.9764f, 0.6588f, 0.8313f, 1.0f);
  vec4 colorBlue300 = vec4(0.5764f, 0.7725f, 0.9921f, 1.0f);
  vec4 colorGrey300 = vec4(0.8196f, 0.8352f, 0.8588f, 1.0f);

  vec4 colorGreen500 = vec4(0.1333f, 0.7725f, 0.3686f, 1.0f);
  vec4 colorPurple500 = vec4(0.6588f, 0.3333f, 0.9686f, 1.0f);
  vec4 colorRed500 = vec4(0.9372f, 0.2666f, 0.2666f, 1.0f);
  vec4 colorYellow500 = vec4(0.9176f, 0.7019f, 0.0313f, 1.0f);
  vec4 colorOrange500 = vec4(0.9764f, 0.4509f, 0.0862f, 1.0f);
  vec4 colorPink500 = vec4(0.9254f, 0.2823f, 0.6f, 1.0f);
  vec4 colorBlue500 = vec4(0.2313f, 0.5098f, 0.9647f, 1.0f);
  vec4 colorGrey500 = vec4(0.4196f, 0.4470f, 0.5019f, 1.0f);

  float resourceTrianglePointX = v_resourceTrianglePoint.x;
  float resourceTrianglePointY = v_resourceTrianglePoint.y;


  int packedTilesCount = textureSize(u_packedTilesPositionsTexture, 0).y;
  ivec2 packedTilesTextureSize = textureSize(u_packedTilesTexture, 0);


  int smallestScaleFactorDiff = 256 * 256;
  int bestScaleFactor = 0;


  vec2 packedTilesTexturePoint = vec2(0.0f, 0.0f);


  color = colorTransparent;
  bool found = false;


  for(int index = 0; index < packedTilesCount; index += 1) {


    ivec2 packedTilePosition = texelFetch(u_packedTilesPositionsTexture, ivec2(0, index), 0).rg;
    ivec4 packedTileResourcePositionAndDimension = texelFetch(u_packedTilesResourcePositionsAndDimensionsTexture, ivec2(0, index), 0);
    int packedTileScaleFactor = texelFetch(u_packedTilesScaleFactorsTexture, ivec2(0, index), 0).r;

    float packedTilePositionX = float(packedTilePosition.r);
    float packedTilePositionY = float(packedTilePosition.g);

    float packedTileResourcePositionX = float(packedTileResourcePositionAndDimension.r);
    float packedTileResourcePositionY = float(packedTileResourcePositionAndDimension.g);

    float packedTileDimensionWidth = float(packedTileResourcePositionAndDimension.b);
    float packedTileDimensionHeight = float(packedTileResourcePositionAndDimension.a);





    if(resourceTrianglePointX >= packedTileResourcePositionX &&
      resourceTrianglePointX < packedTileResourcePositionX + packedTileDimensionWidth &&
      resourceTrianglePointY >= packedTileResourcePositionY &&
      resourceTrianglePointY < packedTileResourcePositionY + packedTileDimensionHeight) {
      found = true;

      int scaleFactorDiff = abs(u_bestScaleFactor - packedTileScaleFactor);

      if(scaleFactorDiff < smallestScaleFactorDiff || bestScaleFactor == 0) {

        smallestScaleFactorDiff = scaleFactorDiff;
        bestScaleFactor = packedTileScaleFactor;

        float packedTilePointX = (resourceTrianglePointX - packedTileResourcePositionX) / float(bestScaleFactor);
        float packedTilePointY = (resourceTrianglePointY - packedTileResourcePositionY) / float(bestScaleFactor);

        float packedTilesPointX = packedTilePositionX + packedTilePointX;
        float packedTilesPointY = packedTilePositionY + packedTilePointY;

        float packedTilesTexturePointX = packedTilesPointX / float(packedTilesTextureSize.x);
        float packedTilesTexturePointY = packedTilesPointY / float(packedTilesTextureSize.y);

        packedTilesTexturePoint = vec2(packedTilesTexturePointX, packedTilesTexturePointY);
      }
    }
  }

  if(found == true) {

    color = texture(u_packedTilesTexture, packedTilesTexturePoint);


    if(u_removeColorOptionsThreshold > 0.0f) {
      vec3 backgroundColorDiff = color.rgb - u_removeColorOptionsColor.rgb;
      float backgroundColorDistance = length(backgroundColorDiff);
      if(u_removeColor && backgroundColorDistance < u_removeColorOptionsThreshold) {
        float amount = smoothstep(u_removeColorOptionsThreshold - u_removeColorOptionsThreshold * (1.0f - u_removeColorOptionsHardness), u_removeColorOptionsThreshold, backgroundColorDistance);
        color = vec4(color.rgb * amount, amount);
      }
    }


    float gray = 0.21f * color.r + 0.71f * color.g + 0.07f * color.b;
    color = vec4(color.rgb * (u_saturation) + (gray * (1.0f - u_saturation)), color.a);


    if(u_colorize) {
      color = vec4((u_colorizeOptionsColor + color.rgb) * color.a, color.a);
    }


    color = vec4(color.rgb * u_opacity, color.a * u_opacity);



    if(u_distortion) {



      float trianglePointDistortion = v_trianglePointDistortion;


      trianglePointDistortion = floor(trianglePointDistortion * 10.0f) / 10.0f;

      switch(u_distortionOptionsdistortionMeasure) {
        case 0:
          if(trianglePointDistortion > 0.0f) {
            color = spectral_mix(color, colorRed500, trianglePointDistortion);
          } else {
            color = spectral_mix(color, colorBlue500, abs(trianglePointDistortion));
          }
          break;
        case 1:
          color = spectral_mix(color, colorGreen500, trianglePointDistortion);
          break;
        case 2:
          color = spectral_mix(color, colorYellow500, trianglePointDistortion);
          break;
        case 3:
          color = trianglePointDistortion == -1.0f ? colorRed300 : color;
          break;
        default:
          color = color;
      }
    }



    if(false) {
      color = vec4(abs(sin(v_triangleIndex)), abs(sin(v_triangleIndex + 1.0f)), abs(sin(v_triangleIndex + 2.0f)), 1);
    }


    if(u_grid) {
      float gridSize = 20.0f * float(u_bestScaleFactor);
      float gridWidth = 2.0f * float(u_bestScaleFactor);
      if(mod(float(resourceTrianglePointX) + gridWidth / 2.0f, gridSize) < gridWidth || mod(float(resourceTrianglePointY) + gridWidth / 2.0f, gridSize) < gridWidth) {
        color = colorBlack;
      }
    }
  }
}`;const Cf=500,kf={leading:!0,trailing:!0},Lf=50,jf={leading:!0,trailing:!0},pn=1,gn=1,Of=0,Nf=.7,Df=5,Fo=750;class Ff extends Rf{gl;program;previousSignificantViewport;opacity=pn;saturation=gn;renderOptions={};invertedRenderTransform;lastAnimationFrameRequestId;animating=!1;transformationTransitionStart;animationProgress=1;throttledPrepareRenderInternal;throttledChanged;constructor(e,t){const i=xo(e,e.VERTEX_SHADER,If),n=xo(e,e.FRAGMENT_SHADER,Af),s=yd(e,i,n);super(fn.createFactory(),Md(e,s),t),this.gl=e,this.program=s,e.deleteShader(i),e.deleteShader(n),e.disable(e.DEPTH_TEST),this.invertedRenderTransform=Wo(),this.addEventListeners(),this.throttledPrepareRenderInternal=rn(this.prepareRenderInternal.bind(this),Cf,kf),this.throttledChanged=rn(this.changed.bind(this),Lf,jf)}getOpacity(){return this.opacity}setOpacity(e){this.opacity=e}resetOpacity(){this.opacity=pn}getMapOpacity(e){const t=this.warpedMapList.getWarpedMap(e);if(t)return t.opacity}setMapOpacity(e,t){const i=this.warpedMapList.getWarpedMap(e);i&&(i.opacity=Math.min(Math.max(t,0),1))}resetMapOpacity(e){const t=this.warpedMapList.getWarpedMap(e);t&&(t.opacity=pn)}getRemoveColorOptions(){return this.renderOptions.removeColorOptions}setRemoveColorOptions(e){this.renderOptions.removeColorOptions=e}resetRemoveColorOptions(){this.renderOptions.removeColorOptions=void 0}getMapRemoveColorOptions(e){const t=this.warpedMapList.getWarpedMap(e);if(t)return t.renderOptions.removeColorOptions}setMapRemoveColorOptions(e,t){const i=this.warpedMapList.getWarpedMap(e);i&&(i.renderOptions.removeColorOptions=t)}resetMapRemoveColorOptions(e){const t=this.warpedMapList.getWarpedMap(e);t&&(t.renderOptions.removeColorOptions=void 0)}getColorizeOptions(){return this.renderOptions.colorizeOptions}setColorizeOptions(e){this.renderOptions.colorizeOptions=e}resetColorizeOptions(){this.renderOptions.colorizeOptions=void 0}getMapColorizeOptions(e){const t=this.warpedMapList.getWarpedMap(e);if(t)return t.renderOptions.colorizeOptions}setMapColorizeOptions(e,t){const i=this.warpedMapList.getWarpedMap(e);i&&(i.renderOptions.colorizeOptions=t)}resetMapColorizeOptions(e){const t=this.warpedMapList.getWarpedMap(e);t&&(t.renderOptions.colorizeOptions=void 0)}getGridOptions(){return this.renderOptions.gridOptions}setGridOptions(e){this.renderOptions.gridOptions=e}resetGridOptions(){this.renderOptions.gridOptions=void 0}getMapGridOptions(e){const t=this.warpedMapList.getWarpedMap(e);if(t)return t.renderOptions.gridOptions}setMapGridOptions(e,t){const i=this.warpedMapList.getWarpedMap(e);i&&(i.renderOptions.gridOptions=t)}resetMapGridOptions(e){const t=this.warpedMapList.getWarpedMap(e);t&&(t.renderOptions.gridOptions=void 0)}getSaturation(){return this.saturation}setSaturation(e){this.saturation=e}resetSaturation(){this.saturation=gn}getMapSaturation(e){const t=this.warpedMapList.getWarpedMap(e);if(t)return t.saturation}setMapSaturation(e,t){const i=this.warpedMapList.getWarpedMap(e);i&&(i.saturation=t)}resetMapSaturation(e){const t=this.warpedMapList.getWarpedMap(e);t&&(t.saturation=gn)}render(e){this.viewport=e,this.loadMissingImageInfosInViewport(),this.someImageInfosInViewport()&&this.throttledPrepareRenderInternal(),this.renderInternal()}clear(){this.warpedMapList.clear(),this.mapsInViewport=new Set,this.gl.clear(this.gl.DEPTH_BUFFER_BIT|this.gl.COLOR_BUFFER_BIT),this.tileCache.clear()}dispose(){for(const e of this.warpedMapList.getWarpedMaps())this.removeEventListenersFromWebGL2WarpedMap(e),e.dispose();this.tileCache.clear(),this.tileCache.dispose(),this.removeEventListeners(),this.gl.deleteProgram(this.program)}prepareRenderInternal(){this.updateRequestedTiles(),this.updateVertexBuffers()}shouldUpdateRequestedTiles(){if(!this.viewport||this.animating)return!1;if(this.previousSignificantViewport){const e=[];for(let i=0;i<4;i++)e.push(xe(this.previousSignificantViewport.projectedGeoRectangle[i],this.viewport.projectedGeoRectangle[i])/this.viewport.projectedGeoPerViewportScale);const t=Math.max(...e);return t===0?!0:t>Df?(this.previousSignificantViewport=this.viewport,!0):!1}else return this.previousSignificantViewport=this.viewport,!0}updateVertexBuffers(){if(this.viewport){this.invertedRenderTransform=Vo(this.viewport.projectedGeoToClipTransform);for(const e of this.mapsInViewport){const t=this.warpedMapList.getWarpedMap(e);if(!t)break;t.updateVertexBuffers(this.viewport.projectedGeoToClipTransform)}}}renderInternal(){if(!this.viewport)return;const e=zo(this.viewport.projectedGeoToClipTransform,this.invertedRenderTransform),t=this.gl;t.viewport(0,0,t.canvas.width,t.canvas.height),t.enable(t.BLEND),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),t.useProgram(this.program);const i=t.getUniformLocation(this.program,"u_renderTransform");t.uniformMatrix4fv(i,!1,qo(e));const n=t.getUniformLocation(this.program,"u_animationProgress");t.uniform1f(n,this.animationProgress);for(const s of this.mapsInViewport){const o=this.warpedMapList.getWarpedMap(s);if(!o)continue;this.setRenderOptionsUniforms(this.renderOptions,o.renderOptions);const a=t.getUniformLocation(this.program,"u_opacity");t.uniform1f(a,this.opacity*o.opacity);const l=t.getUniformLocation(this.program,"u_saturation");t.uniform1f(l,this.saturation*o.saturation);const c=t.getUniformLocation(this.program,"u_distortion");if(t.uniform1f(c,o.distortionMeasure?1:0),o.distortionMeasure){const p=t.getUniformLocation(this.program,"u_distortionOptionsdistortionMeasure");t.uniform1i(p,Bs.indexOf(o.distortionMeasure))}const h=t.getUniformLocation(this.program,"u_bestScaleFactor"),u=o.bestScaleFactor;t.uniform1i(h,u);const g=t.getUniformLocation(this.program,"u_packedTilesTexture");t.uniform1i(g,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,o.packedTilesTexture);const y=t.getUniformLocation(this.program,"u_packedTilesPositionsTexture");t.uniform1i(y,1),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,o.packedTilesPositionsTexture);const v=t.getUniformLocation(this.program,"u_packedTilesResourcePositionsAndDimensionsTexture");t.uniform1i(v,2),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,o.packedTilesResourcePositionsAndDimensionsTexture);const E=t.getUniformLocation(this.program,"u_packedTilesScaleFactorsTexture");t.uniform1i(E,3),t.activeTexture(t.TEXTURE3),t.bindTexture(t.TEXTURE_2D,o.packedTilesScaleFactorsTexture);const P=o.vao,w=o.resourceTrianglePoints.length,S=this.gl.TRIANGLES;t.bindVertexArray(P),t.drawArrays(S,0,w)}}setRenderOptionsUniforms(e,t){const i=this.gl,n={removeColorOptions:{color:t.removeColorOptions?.color||e.removeColorOptions?.color,hardness:Sn(t.removeColorOptions?.hardness,e.removeColorOptions?.hardness),threshold:Sn(t.removeColorOptions?.threshold,e.removeColorOptions?.threshold)},colorizeOptions:{...e.colorizeOptions,...t.colorizeOptions},gridOptions:{...e.gridOptions,...t.gridOptions}},s=n.removeColorOptions?.color,o=i.getUniformLocation(this.program,"u_removeColor");if(i.uniform1f(o,s?1:0),s){const u=i.getUniformLocation(this.program,"u_removeColorOptionsColor");i.uniform3fv(u,s);const g=i.getUniformLocation(this.program,"u_removeColorOptionsThreshold");i.uniform1f(g,n.removeColorOptions?.threshold||Of);const y=i.getUniformLocation(this.program,"u_removeColorOptionsHardness");i.uniform1f(y,n.removeColorOptions?.hardness||Nf)}const a=n.colorizeOptions?.color,l=i.getUniformLocation(this.program,"u_colorize");if(i.uniform1f(l,a?1:0),a){const u=i.getUniformLocation(this.program,"u_colorizeOptionsColor");i.uniform3fv(u,a)}const c=n.gridOptions?.enabled,h=i.getUniformLocation(this.program,"u_grid");i.uniform1f(h,c?1:0)}startTransformationTransition(){this.lastAnimationFrameRequestId!==void 0&&cancelAnimationFrame(this.lastAnimationFrameRequestId),this.animating=!0,this.transformationTransitionStart=void 0,this.lastAnimationFrameRequestId=requestAnimationFrame(this.transformationTransitionFrame.bind(this))}transformationTransitionFrame(e){if(this.transformationTransitionStart||(this.transformationTransitionStart=e),e-this.transformationTransitionStart<Fo)this.animationProgress=(e-this.transformationTransitionStart)/Fo,this.renderInternal(),this.lastAnimationFrameRequestId=requestAnimationFrame(this.transformationTransitionFrame.bind(this));else{for(const t of this.warpedMapList.getWarpedMaps())t.resetTrianglePoints();this.updateVertexBuffers(),this.animating=!1,this.animationProgress=0,this.transformationTransitionStart=void 0}}changed(){this.dispatchEvent(new U(k.CHANGED))}imageInfoLoaded(e){e instanceof U&&this.dispatchEvent(new U(k.IMAGEINFOLOADED))}mapTileLoaded(e){if(e instanceof U){const{mapId:t,tileUrl:i}=e.data,n=this.tileCache.getCacheableTile(i);if(!n||!n.isCachedTile())return;const s=this.warpedMapList.getWarpedMap(t);if(!s)return;s.addCachedTileAndUpdateTextures(n)}}mapTileRemoved(e){if(e instanceof U){const{mapId:t,tileUrl:i}=e.data,n=this.warpedMapList.getWarpedMap(t);if(!n)return;n.removeCachedTileAndUpdateTextures(i)}}warpedMapAdded(e){if(e instanceof U){const t=e.data,i=this.warpedMapList.getWarpedMap(t);i&&this.addEventListenersToWebGL2WarpedMap(i)}}transformationChanged(e){if(e instanceof U){const t=e.data;for(const i of this.warpedMapList.getWarpedMaps(t))this.animating&&i.mixTrianglePoints(this.animationProgress),i.updateProjectedGeoTrianglePoints(!1);this.updateVertexBuffers(),this.startTransformationTransition()}}distortionChanged(e){if(e instanceof U){const t=e.data;for(const i of this.warpedMapList.getWarpedMaps(t))this.animating&&i.mixTrianglePoints(this.animationProgress),i.updateTrianglePointsDistortion(!1);this.updateVertexBuffers(),this.startTransformationTransition()}}addEventListenersToWebGL2WarpedMap(e){e.addEventListener(k.TEXTURESUPDATED,this.throttledChanged.bind(this))}removeEventListenersFromWebGL2WarpedMap(e){e.removeEventListener(k.TEXTURESUPDATED,this.throttledChanged.bind(this))}}const Gf="Renderer not defined. Add the layer to a map before calling this function.",Go="tilePane",Bo=1;function W(r){if(!r)throw new Error(Gf)}class mn extends Je.Layer{container;canvas;gl;renderer;_annotationOrAnnotationUrl;resizeObserver;options={opacity:Bo,interactive:!1,className:"",pane:Go,zIndex:1};constructor(e,t){super(),this.initialize(e,t)}initialize(e,t){this._annotationOrAnnotationUrl=e,Je.setOptions(this,t),this._initGl()}onAdd(e){if(!this._map||!this.container)return this;const t=this.getPaneName();return this._map.getPane(t)?.appendChild(this.container),e.on("zoomend viewreset move",this._update,this),e.on("zoomanim",this._animateZoom,this),e.on("unload",this._unload,this),this.resizeObserver=new ResizeObserver(this._resized.bind(this)),this.resizeObserver.observe(this._map.getContainer(),{box:"content-box"}),this._annotationOrAnnotationUrl&&(typeof this._annotationOrAnnotationUrl=="string"&&ya(this._annotationOrAnnotationUrl)?this.addGeoreferenceAnnotationByUrl(this._annotationOrAnnotationUrl).then(()=>this._update()):this.addGeoreferenceAnnotation(this._annotationOrAnnotationUrl).then(()=>this._update())),this}onRemove(e){return this.container&&this.container.remove(),e.off("zoomend viewreset move",this._update,this),e.off("zoomanim",this._animateZoom,this),this}async addGeoreferenceAnnotation(e){W(this.renderer);const t=await this.renderer.warpedMapList.addGeoreferenceAnnotation(e);return this._update(),t}async removeGeoreferenceAnnotation(e){W(this.renderer);const t=await this.renderer.warpedMapList.removeGeoreferenceAnnotation(e);return this._update(),t}async addGeoreferenceAnnotationByUrl(e){const t=await fetch(e).then(i=>i.json());return this.addGeoreferenceAnnotation(t)}async removeGeoreferenceAnnotationByUrl(e){const t=await fetch(e).then(n=>n.json());return this.removeGeoreferenceAnnotation(t)}async addGeoreferencedMap(e){W(this.renderer);const t=this.renderer.warpedMapList.addGeoreferencedMap(e);return this._update(),t}async removeGeoreferencedMap(e){W(this.renderer);const t=this.renderer.warpedMapList.removeGeoreferencedMap(e);return this._update(),t}getContainer(){return this.container}getCanvas(){return this.canvas}getWarpedMapList(){return W(this.renderer),this.renderer.warpedMapList}getWarpedMap(e){return W(this.renderer),this.renderer.warpedMapList.getWarpedMap(e)}showMap(e){W(this.renderer),this.renderer.warpedMapList.showMaps([e]),this._update()}showMaps(e){W(this.renderer),this.renderer.warpedMapList.showMaps(e),this._update()}hideMap(e){W(this.renderer),this.renderer.warpedMapList.hideMaps([e]),this._update()}hideMaps(e){W(this.renderer),this.renderer.warpedMapList.hideMaps(e),this._update()}isMapVisible(e){return W(this.renderer),this.renderer.warpedMapList.getWarpedMap(e)?.visible}setMapResourceMask(e,t){W(this.renderer),this.renderer.warpedMapList.setMapResourceMask(e,t),this._update()}setMapsTransformationType(e,t){W(this.renderer),this.renderer.warpedMapList.setMapsTransformationType(e,t),this._update()}setMapsDistortionMeasure(e,t){W(this.renderer),this.renderer.warpedMapList.setMapsDistortionMeasure(e,t),this._update()}getBounds(){W(this.renderer);const e=this.renderer.warpedMapList.getBbox();if(e)return[[e[1],e[0]],[e[3],e[2]]]}bringMapsToFront(e){W(this.renderer),this.renderer.warpedMapList.bringMapsToFront(e),this._update()}sendMapsToBack(e){W(this.renderer),this.renderer.warpedMapList.sendMapsToBack(e),this._update()}bringMapsForward(e){W(this.renderer),this.renderer.warpedMapList.bringMapsForward(e),this._update()}sendMapsBackward(e){W(this.renderer),this.renderer.warpedMapList.sendMapsBackward(e),this._update()}bringToFront(){return this._map&&this.container&&Je.DomUtil.toFront(this.container),this}bringToBack(){return this._map&&this.container&&Je.DomUtil.toBack(this.container),this}getMapZIndex(e){return W(this.renderer),this.renderer.warpedMapList.getMapZIndex(e)}getZIndex(){return this.options.zIndex}setZIndex(e){return this.options.zIndex=e,this._updateZIndex(),this}setImageInformations(e){W(this.renderer),this.renderer.warpedMapList.setImageInformations(e)}getPaneName(){return this.options.pane||Go}getOpacity(){return this.options.opacity||Bo}setOpacity(e){return this.options.opacity=e,this._update(),this}resetOpacity(){return this.options.opacity=1,this._update(),this}getMapOpacity(e){return W(this.renderer),this.renderer.getMapOpacity(e)}setMapOpacity(e,t){return W(this.renderer),this.renderer.setMapOpacity(e,t),this._update(),this}resetMapOpacity(e){return W(this.renderer),this.renderer.resetMapOpacity(e),this._update(),this}setSaturation(e){return W(this.renderer),this.renderer.setSaturation(e),this._update(),this}resetSaturation(){return W(this.renderer),this.renderer.resetSaturation(),this._update(),this}setMapSaturation(e,t){return W(this.renderer),this.renderer.setMapSaturation(e,t),this._update(),this}resetMapSaturation(e){return W(this.renderer),this.renderer.resetMapSaturation(e),this._update(),this}setRemoveColor(e){W(this.renderer);const t=e.hexColor?br(e.hexColor):void 0;return this.renderer.setRemoveColorOptions({color:t,threshold:e.threshold,hardness:e.hardness}),this._update(),this}resetRemoveColor(){return W(this.renderer),this.renderer.resetRemoveColorOptions(),this._update(),this}setMapRemoveColor(e,t){W(this.renderer);const i=t.hexColor?br(t.hexColor):void 0;return this.renderer.setMapRemoveColorOptions(e,{color:i,threshold:t.threshold,hardness:t.hardness}),this._update(),this}resetMapRemoveColor(e){return W(this.renderer),this.renderer.resetMapRemoveColorOptions(e),this}setColorize(e){W(this.renderer);const t=br(e);return t&&(this.renderer.setColorizeOptions({color:t}),this._update()),this}resetColorize(){return W(this.renderer),this.renderer.resetColorizeOptions(),this._update(),this}setMapColorize(e,t){W(this.renderer);const i=br(t);return i&&(this.renderer.setMapColorizeOptions(e,{color:i}),this._update()),this}resetMapColorize(e){return W(this.renderer),this.renderer.resetMapColorizeOptions(e),this._update(),this}clear(){return W(this.renderer),this.renderer.clear(),this._update(),this}_initGl(){if(this.container=Je.DomUtil.create("div"),this.container.classList.add("leaflet-layer"),this.container.classList.add("allmaps-warped-map-layer"),this.options.zIndex&&this._updateZIndex(),this.canvas=Je.DomUtil.create("canvas",void 0,this.container),this.canvas.classList.add("leaflet-zoom-animated"),this.canvas.classList.add("leaflet-image-layer"),this.options.interactive&&this.canvas.classList.add("leaflet-interactive"),this.options.className&&this.canvas.classList.add(this.options.className),this.gl=this.canvas.getContext("webgl2",{premultipliedAlpha:!0}),!this.gl)throw new Error("WebGL 2 not available");this.renderer=new Ff(this.gl),this._addEventListeners()}_resized(e){if(this.canvas){for(const t of e){const i=t.contentRect.width,n=t.contentRect.height,s=window.devicePixelRatio,o=Math.round(i*s),a=Math.round(n*s);this.canvas.width=o,this.canvas.height=a,this.canvas.style.width=i+"px",this.canvas.style.height=n+"px"}this._update()}}_animateZoom(e){if(!this.canvas)return;const t=this._map.getZoomScale(e.zoom),i=this._map._latLngBoundsToNewLayerBounds(this._map.getBounds(),e.zoom,e.center).min;Je.DomUtil.setTransform(this.canvas,i,t)}_updateZIndex(){this.container&&this.options.zIndex!==void 0&&(this.container.style.zIndex=String(this.options.zIndex))}_update(){if(!this._map||!this.renderer||!this.canvas||!this._map.options.crs)return;const e=this._map.containerPointToLayerPoint([0,0]);Je.DomUtil.setPosition(this.canvas,e),this.renderer.setOpacity(this.getOpacity());const t=this._map.getSize(),i=[t.x,t.y],n=this._map.getCenter(),s=this._map.options.crs.project(n),o=[s.x,s.y],a=this._map.getBounds(),l=this._map.options.crs.project(a.getNorthEast()),c=this._map.options.crs.project(a.getNorthWest()),h=this._map.options.crs.project(a.getSouthWest()),u=this._map.options.crs.project(a.getSouthEast()),g=[[l.x,l.y],[c.x,c.y],[h.x,h.y],[u.x,u.y]],y=vi(g),v=xr(y,i),E=new Mr(i,o,v,0,window.devicePixelRatio);return this.renderer.render(E),this.container}_addEventListeners(){W(this.renderer),this.renderer.addEventListener(k.CHANGED,this._update.bind(this)),this.renderer.addEventListener(k.IMAGEINFOLOADED,this._update.bind(this)),this.renderer.addEventListener(k.WARPEDMAPENTER,this._passWarpedMapEvent.bind(this)),this.renderer.addEventListener(k.WARPEDMAPLEAVE,this._passWarpedMapEvent.bind(this)),this.renderer.tileCache.addEventListener(k.FIRSTMAPTILELOADED,this._passWarpedMapEvent.bind(this)),this.renderer.tileCache.addEventListener(k.ALLREQUESTEDTILESLOADED,this._passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.addEventListener(k.WARPEDMAPADDED,this._passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.addEventListener(k.WARPEDMAPREMOVED,this._passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.addEventListener(k.VISIBILITYCHANGED,this._update.bind(this)),this.renderer.warpedMapList.addEventListener(k.CLEARED,this._update.bind(this))}_removeEventListeners(){W(this.renderer),this.renderer.removeEventListener(k.CHANGED,this._update.bind(this)),this.renderer.removeEventListener(k.IMAGEINFOLOADED,this._update.bind(this)),this.renderer.removeEventListener(k.WARPEDMAPENTER,this._passWarpedMapEvent.bind(this)),this.renderer.removeEventListener(k.WARPEDMAPLEAVE,this._passWarpedMapEvent.bind(this)),this.renderer.tileCache.removeEventListener(k.FIRSTMAPTILELOADED,this._passWarpedMapEvent.bind(this)),this.renderer.tileCache.removeEventListener(k.ALLREQUESTEDTILESLOADED,this._passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.removeEventListener(k.WARPEDMAPADDED,this._passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.removeEventListener(k.WARPEDMAPREMOVED,this._passWarpedMapEvent.bind(this)),this.renderer.warpedMapList.removeEventListener(k.VISIBILITYCHANGED,this._update.bind(this)),this.renderer.warpedMapList.removeEventListener(k.CLEARED,this._update.bind(this))}_passWarpedMapEvent(e){e instanceof U&&this._map&&this._map.fire(e.type,e.data)}_unload(){if(W(this.renderer),!this.gl)return;this.renderer.dispose();const e=this.gl.getExtension("WEBGL_lose_context");e&&e.loseContext();const t=this.gl.canvas;t.width=1,t.height=1,this.resizeObserver?.disconnect(),this._removeEventListeners()}}const Bf=function(r,e){return new mn(r,e)};L.WarpedMapLayer=mn,L.warpedMapLayer=Bf,De.WarpedMapEvent=U,De.WarpedMapEventType=k,De.WarpedMapLayer=mn,Object.defineProperty(De,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=allmaps-leaflet-1.9.umd.js.map


}
/*
     FILE ARCHIVED ON 12:40:36 Jun 16, 2024 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 17:36:28 Aug 21, 2024.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
*/
/*
playback timings (ms):
  captures_list: 0.71
  exclusion.robots: 0.032
  exclusion.robots.policy: 0.019
  esindex: 0.012
  cdx.remote: 13.439
  LoadShardBlock: 90.919 (3)
  PetaboxLoader3.datanode: 158.753 (5)
  load_resource: 210.269
  PetaboxLoader3.resolve: 96.193
  loaddict: 63.044
*/